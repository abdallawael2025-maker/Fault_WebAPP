<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
<style>
  :root{--primary:#0A4C88;--accent:#08365F;--muted:#666}
  body{font-family:Arial, Tahoma, sans-serif;margin:0;background:#f4f6f8;color:#111}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  nav{display:flex;gap:6px;background:var(--accent);padding:8px}
  nav button{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
  nav button.active{background:#0d5aa2}
  section{padding:16px}
  .box{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.05);margin-bottom:12px}
  label{display:block;margin-top:8px;font-size:14px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  input[type="date"]{font-size:14px;color:#333;min-height:40px;padding:10px}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer}
  textarea{min-height:70px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.ghost{background:#eee;color:#111}
  .row{display:flex;gap:8px;align-items:center}
  .row .flex{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #ddd;padding:10px;text-align:right;vertical-align:top;min-height:40px}
  th{background:#0A4C88;color:#fff}
  .actions button{margin-left:6px}
  .status-okay{background:#c4f7c4}
  .status-working{background:#fff3b0}
  .status-wait-company{background:#ffd59e}
  .status-wait-part{background:#ffb4b4}
  #tiles{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tile{flex:1 1 140px;background:#fff;padding:10px;border-radius:6px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
  canvas{background:#fff;border-radius:6px;padding:8px}
  /* Responsive helpers */
  .table-responsive{overflow-x:auto}
  /* Disable horizontal swipe/scroll specifically for dashboard table */
  #page_dash .table-responsive{overflow-x:hidden; touch-action:pan-y; -webkit-overflow-scrolling:auto}
  #page_dash .table-responsive table{min-width:0; width:100%}
  canvas{max-width:100%;height:auto}
  /* Mobile card view */
  .card-view{display:none;margin-bottom:12px;padding:8px}
  .fault-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .fault-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .fault-card-row:last-child{border-bottom:none}
  .fault-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .fault-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .fault-card-value.empty{color:#999;font-style:italic}
  .fault-card-actions{display:flex;gap:8px;margin-top:16px}
  .fault-card-actions button{flex:1;padding:8px;font-size:13px}
  .fault-card-actions button.btn{font-size:12px}
  .table-view{display:block}
  /* Order card styles */
  .order-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .order-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .order-card-row:last-child{border-bottom:none}
  .order-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .order-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .order-card-value.empty{color:#999;font-style:italic}
  .order-card-actions{display:flex;gap:8px;margin-top:16px}
  .order-card-actions button{flex:1;padding:8px;font-size:13px}
  .order-card-actions button.btn{font-size:12px}
  /* Status badge styling */
  .card-status-badge{display:inline-block;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;text-align:center;width:100%}

  @media (max-width:800px){
    header{padding:10px}
    header h1{font-size:16px}
    nav{flex-wrap:wrap}
    nav button{padding:6px 8px;font-size:14px}
    .row{flex-direction:column;align-items:stretch}
    .row .flex{order:99;height:0}
    .tile{flex:1 1 45%}
    .box{padding:10px}
    .table-responsive table{min-width:600px}
  }

  @media (max-width:600px){
    header h1{font-size:15px}
    nav button{font-size:13px;padding:6px}
    .tile{flex-basis:100%}
    .row .flex{display:block;height:auto}
    .row input[type="date"]{flex:1 !important;max-width:none !important;min-width:auto}
    /* Show cards on mobile, hide table */
    .table-view{display:none !important}
    .card-view{display:block !important}
    .home-btn{padding:8px 14px !important}
    /* dashboard table mobile: convert to stacked cards with professional look */
    #dashTable{border:0}
    #dashTable thead{display:none}
    #dashTable tbody{display:block;padding:6px}
    #dashTable tr{display:block;background:#ffffff;border:1px solid #e6e9ef;border-radius:10px;margin:8px auto;padding:8px;max-width:360px;box-shadow:0 6px 18px rgba(10,76,136,0.06)}
    #dashTable td{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px dashed #f0f2f5;font-size:13px}
    #dashTable td:last-child{border-bottom:0}
    #dashTable td::before{content:attr(data-label);font-weight:600;color:#6b7a8a;margin-inline-end:8px;font-size:12px;opacity:0.9}
    #dashTable td[data-label]{font-size:14px;color:#08365F}
    /* emphasize values */
    #dashTable td[data-label="Ø§Ù„Ø¹Ø¯Ø¯"], #dashTable td[data-label="Ø§Ù„Ù†Ø³Ø¨Ø©"]{font-weight:700;color:#0A4C88}
  }
  
  @media (max-width:480px){
    .fault-card-label{flex:0 0 35%}
    .fault-card-actions button{font-size:11px;padding:5px}
    .row input[type="date"]{flex:0 0 45% !important;margin:4px}
    .row label{flex:0 0 100%;margin-bottom:4px;font-size:12px}
    .row button{flex:1;margin:4px 0}
  }
  @media print{
    nav,.no-print,.actions,.controls{display:none!important}
    body{background:#fff;margin:0;padding:0;font-size:12px}
    .box,section,header{padding:0!important;margin:0!important;box-shadow:none!important}
    .summary-title{font-size:18px!important}
    .summary-desc{font-size:13px!important}
    .summary-date{font-size:12px!important}
    .summary-total{font-size:13px!important;padding:6px 0!important}
    .group-title{font-size:15px!important;padding:6px 0!important}
    .cards-wrap{flex-wrap:wrap!important;gap:8px!important}
    .summary-card{min-width:120px!important;max-width:160px!important;padding:10px 8px!important;margin-bottom:6px!important}
    .card-title{font-size:13px!important}
    .card-count{font-size:15px!important;padding:4px 8px!important}
    table{font-size:11px!important}
    th,td{padding:4px!important}
    h2,h3{font-size:15px!important;margin:4px 0!important}
    .footer{font-size:10px!important;margin-top:10px!important}
    .group-section{margin-bottom:12px!important}
    .cards-wrap,.summary-card{flex-direction:column!important;align-items:stretch!important}
  }
  /* Login modal styles */
  #loginModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000}
  #loginModal.hidden{display:none}
  .login-container{background:#fff;padding:32px;border-radius:12px;min-width:340px;max-width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.2);direction:rtl;text-align:right}
  .login-container h2{margin:0 0 24px;font-size:24px;color:var(--primary);text-align:center}
  .login-container label{display:block;margin:16px 0 6px;font-weight:600;color:#333;font-size:14px}
  .login-container input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;font-size:14px}
  .login-container input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(10,76,136,0.1)}
  .login-container .login-buttons{display:flex;gap:10px;margin-top:24px;justify-content:flex-end}
  .login-container button{padding:10px 20px;border:0;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600}
  .login-container .login-btn{background:var(--primary);color:#fff}
  .login-container .login-btn:hover{background:var(--accent)}
  .login-container .error{color:#e53935;font-size:13px;margin-top:6px;display:none}
  .login-container .error.show{display:block}
  
  /* Password modal (attendance access) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:15px}
  .modal-overlay.active{display:flex}
  #changePasswordModal{display:none}
  #changePasswordModal[style*="display: flex"]{display:flex!important}
  .modal{background:#fff;padding:20px;border-radius:8px;min-width:320px;max-width:92%;box-shadow:0 6px 30px rgba(0,0,0,0.25);direction:rtl;text-align:right}
  #changePasswordModal .modal{max-width:100%;width:100%;max-width:450px}
  .modal h3{margin:0 0 8px;font-size:16px}
  .modal .modal-row{margin-top:8px}
  .modal input[type="password"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  .pwd-toggle{position:relative;display:flex;align-items:center}
  .pwd-toggle input{width:100%;padding:8px 35px 8px 8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
  .eye-icon{position:absolute;left:8px;cursor:pointer;font-size:18px;user-select:none}
  .modal .modal-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;flex-wrap:wrap}
  .modal .modal-actions button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer;flex:1;min-width:100px}
  .modal .btn-primary{background:var(--primary);color:#fff}
  .modal .btn-ghost{background:#eee}
  .pwd-requirements{font-size:12px;color:#666;margin-top:8px;line-height:1.5}
  .pwd-requirements li{margin:4px 0}
  .pwd-requirement-met{color:#4caf50}
  .pwd-requirement-unmet{color:#e53935}
  .success{color:#4caf50;font-size:14px}

  /* Password toggle icon */
  .pwd-toggle{position:relative;display:inline-block;width:100%}
  .pwd-toggle input{width:100%;padding-left:40px}
  .pwd-toggle .eye-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#666;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;border:1px solid #ddd;background:#fff;transition:background 0.2s, border-color 0.2s;user-select:none}
  .pwd-toggle .eye-icon:hover{background:#f8f9fa;border-color:#ccc}

  /* Success message */
  .success{color:#4caf50;font-size:14px;display:none}

  /* Home fullscreen simple page */
  #page_home.home-fullscreen{min-height:calc(100vh - 0px);display:flex;align-items:center;justify-content:center;background:#fff}
  #page_home.home-fullscreen .home-inner{max-width:920px;margin:0 auto;padding:24px}
  #page_home.home-fullscreen h1{font-size:32px;margin-bottom:8px;color:var(--primary);font-weight:700}
  #page_home.home-fullscreen p.lead{color:var(--muted);margin-bottom:18px;font-size:15px}
  /* professional button list */
  #page_home .home-buttons{display:grid;grid-template-columns:1fr;gap:12px;width:360px;margin:0 auto}
  @media(min-width:760px){ #page_home .home-buttons{width:420px} }
  .home-btn{display:flex;align-items:center;gap:12px;padding:14px 18px;font-size:16px;border-radius:12px;border:1px solid rgba(10,76,136,0.08);background:#fff;box-shadow:0 6px 18px rgba(10,76,136,0.06);cursor:pointer;transition:transform .14s ease,box-shadow .14s ease}
  .home-btn:hover{transform:translateY(-6px);box-shadow:0 16px 36px rgba(10,76,136,0.12)}
  .home-btn .icon{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(10,76,136,0.06);color:var(--primary);font-size:18px}
  .home-btn .label{flex:1;text-align:right;font-weight:700;color:#08365F;font-size:17px}
  .home-btn.secondary .icon{background:rgba(255,112,67,0.08);color:#ff7043}
  .home-btn.success .icon{background:rgba(76,175,80,0.08);color:#4caf50}
  .home-btn.info .icon{background:rgba(0,151,167,0.08);color:#0097a7}
  .home-btn.ghost{background:#fafafa}
  .home-btn.contrast .label{color:#fff}
  .home-btn.contrast .icon{background:rgba(255,255,255,0.12);color:#fff}
  /* Mobile tweaks: larger touch targets and spacing */
  @media(max-width:420px){
    #page_home.home-fullscreen{padding:20px}
    #page_home .home-inner{padding:8px}
    #page_home .home-buttons{gap:14px;width:100%}
    .home-btn{padding:18px 16px;font-size:18px;border-radius:12px}
    .home-btn .icon{width:46px;height:46px}
    .home-btn .label{font-size:17px}
  }
  /* Mobile-only entry animations for home buttons */
  @media(max-width:420px){
    .home-btn{opacity:0;transform:translateY(12px)}
    @keyframes fadeUpMobile{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    #page_home .home-buttons .home-btn:nth-child(1){animation:fadeUpMobile .42s ease .08s forwards}
    #page_home .home-buttons .home-btn:nth-child(2){animation:fadeUpMobile .42s ease .14s forwards}
    #page_home .home-buttons .home-btn:nth-child(3){animation:fadeUpMobile .42s ease .20s forwards}
    #page_home .home-buttons .home-btn:nth-child(4){animation:fadeUpMobile .42s ease .26s forwards}
    #page_home .home-buttons .home-btn:nth-child(5){animation:fadeUpMobile .42s ease .32s forwards}
    #page_home .home-buttons .home-btn:nth-child(6){animation:fadeUpMobile .42s ease .38s forwards}
  }
</style>
</head>
<body>
<!-- Login Modal -->
<div id="loginModal">
  <div class="login-container">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form id="loginForm" onsubmit="handleLogin(event)">
      <label for="userCode">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
      <input type="text" id="userCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required />
      
      <label for="userPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
      <input type="password" id="userPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
      
      <div class="error" id="loginError">Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
      
      <div class="login-buttons">
        <button type="submit" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal-overlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3 style="margin:0">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
      <button onclick="closeChangePasswordModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
    </div>
    
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
    <div class="pwd-toggle">
      <input type="password" id="currentPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" />
      <span class="eye-icon" onclick="togglePasswordVisibility('currentPassword')">ğŸ‘ï¸</span>
    </div>
    
    <label style="margin-top:16px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
    <div class="pwd-toggle">
      <input type="password" id="newPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" oninput="updatePasswordRequirements()" />
      <span class="eye-icon" onclick="togglePasswordVisibility('newPassword')">ğŸ‘ï¸</span>
    </div>
    
    <div class="pwd-requirements">
      <strong>Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Minimum 8 characters):</strong>
      <ul style="margin:6px 0;padding-left:20px">
        <li id="req-length" class="pwd-requirement-unmet">âœ— 8 characters minimum</li>
        <li id="req-upper" class="pwd-requirement-unmet">âœ— Uppercase letter (A-Z)</li>
        <li id="req-lower" class="pwd-requirement-unmet">âœ— Lowercase letter (a-z)</li>
        <li id="req-number" class="pwd-requirement-unmet">âœ— Number (0-9)</li>
        <li id="req-special" class="pwd-requirement-unmet">âœ— Special character (!@#$%^&*)</li>
      </ul>
    </div>
    
    <label style="margin-top:16px">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
    <div class="pwd-toggle">
      <input type="password" id="confirmPassword" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
      <span class="eye-icon" onclick="togglePasswordVisibility('confirmPassword')">ğŸ‘ï¸</span>
    </div>
    
    <div class="error" id="changePasswordError" style="display:none;margin-top:12px;color:#e53935;font-size:14px"></div>
    <div class="success" id="changePasswordSuccess" style="display:none;margin-top:12px"></div>
    
    <div class="modal-actions" style="margin-top:20px">
      <button onclick="closeChangePasswordModal()" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
      <button onclick="saveNewPassword()" class="btn btn-primary">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
    </div>
  </div>
</div>

<header>
  <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
  </dispplay:none><div style="font-size:13px;color:#fff"></div>
</header>

<nav style="display:none">
  <button id="navHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button id="navFaults">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</button>
  <button id="navMaintenance">Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
  <button id="navCatalog">ÙƒØªØ§Ù„ÙˆØ¬</button>
  <button id="navOrders">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</button>
  <button id="navAttendance">Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª</button>
  <button id="navTrash">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
  <button id="navDash">Dashboard</button>
</nav>

<section style="display:none">
  <div id="page_home" class="page home-fullscreen">
    <div class="home-inner">
      <h1 style="margin:0 0 12px;text-align:center;color:var(--primary)">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª (Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡)</h1>
      <p class="lead" style="text-align:center;margin:0 0 20px;color:var(--muted)">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡</p>
      <div class="home-buttons">
        <button class="btn home-btn contrast" style="background:#e53935" onclick="show('faults');setTimeout(()=>showLatestFaultNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Warning / Fault SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 21h22L12 2 1 21z" fill="#fff"/><path d="M13 16h-2v2h2v-2zm0-8h-2v6h2V8z" fill="#000"/></svg>
          </span>
          <span class="label">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</span>
        </button>
        <button class="btn home-btn secondary" style="background:#ff7043" onclick="show('maintenance');setTimeout(()=>showLatestMaintenanceNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Wrench / Maintenance SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.7 19.3l-2-2c-.4-.4-1-.4-1.4 0l-1.1 1.1c-1.3-.5-2.7-1-4-1.6l.7-1.7-6.1-6.1-1.7.7c-.6-1.3-1.1-2.7-1.6-4L7.6 4c.2-.6.1-1.2-.4-1.7L4.2.9C3.8.5 3.2.5 2.8.9L1.3 2.4C.9 2.8.8 3.4 1 3.9c1.2 4 2.5 7.9 3.7 11.9 1.2 3.9 4.3 7 8.2 8.2 4 .2 7.9-1 11.9-3.7.5-.2.8-.8.4-1.2l-1.5-1.5c-.5-.4-1.1-.4-1.5 0l-1.6 1.6c-.5.5-1.1.4-1.5 0z" fill="#fff"/></svg>
          </span>
          <span class="label">Ø§Ù„ØµÙŠØ§Ù†Ø©</span>
        </button>
        <button class="btn home-btn success" style="background:#4caf50" onclick="show('orders');setTimeout(()=>showLatestOrderNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Cart / Orders SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 4h-2l-1 2h2l1-2zm0 0h10l1.2 6H6.8L7 4zM6 20a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4z" fill="#fff"/></svg>
          </span>
          <span class="label">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</span>
        </button>
        <button class="btn home-btn contrast" style="background:#f3e30a" onclick="show('catalog');setTimeout(()=>showLatestCatalogNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Catalog / Document SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4a2 2 0 012-2h10a2 2 0 012 2v16a2 2 0 01-2 2H5a2 2 0 01-2-2V4z" fill="#fff"/><path d="M7 8h8M7 12h8M7 16h5" stroke="#000" stroke-width="1" stroke-linecap="round"/></svg>
          </span>
          <span class="label">Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬</span>
        </button>
        <button class="btn home-btn info" style="background:#0097a7" onclick="show('attendance');setTimeout(()=>showLatestAttendanceNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Calendar / Attendance SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10h5v5H7z" fill="#fff"/><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v13a2 2 0 002 2h14a2 2 0 002-2V6c0-1.1-.9-2-2-2z" fill="#fff"/></svg>
          </span>
          <span class="label">Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª</span>
        </button>
        <button class="btn home-btn contrast" style="background:#3949ab" onclick="show('dash');">
          <span class="icon" aria-hidden>
            <!-- Original Chart / Dashboard SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h4v8H3v-8zm6-6h4v14h-4V7zm6-4h4v18h-4V3z" fill="#fff"/></svg>
          </span>
          <span class="label">Dashboard</span>
        </button>
      </div>
    </div>
  </div>
  <!-- FAULTS -->
  <div id="page_faults" class="page">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø·Ù„</h3>
      <div id="form">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="machineGroup">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <div id="machineItemContainer">
          <label style="margin-top:6px">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <select id="machineItem" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
          </select>
        </div>
        <div id="customMachineGroupContainer" style="display:none">          
          <div id="customMachinePlaceContainer">
            <label style="margin-top:6px">Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
            <input type="text" id="customMachinePlace" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
          </div>
          <label style="margin-top:6px">Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMachineName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
        </div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="personToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="personChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="person" multiple required style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>Ø­Ø³Ù† Ù…Ø³Ø¹Ø¯</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø¬ÙˆØ¯Ø©</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</option>
                  <option>Ø¹Ù„ÙŠ Ù…Ø±Ø³ÙŠ</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                </select>
        <label>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„</label><textarea id="description"placeholder="Ø´Ø±Ø­ ÙˆØµÙ  Ø§Ù„Ø¹Ø·Ù„"></textarea>
        <label>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</label><textarea id="solution" placeholder="Ø´Ø±Ø­ Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„"></textarea>
        <label>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label><select id="shift"><option>ØµØ¨Ø§Ø­ÙŠØ©</option><option>Ù…Ø³Ø§Ø¦ÙŠØ©</option><option>Ù„ÙŠÙ„ÙŠØ©</option></select>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date" required />
        <label>Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±ØŸ</label>
        <select id="partChanged">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
        <div id="partFieldsContainer" style="display:none">
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number)</label><input id="lcode" />
          <label>Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input id="partName" placeholder="Ø£Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±" />
          <label>ÙƒÙ…ÙŠØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input type="number" id="partQty" min="0" value="0" />
        </div>
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„</label>
        <select id="status">
          <option>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button id="addBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„</button>
          <button class="btn ghost" id="clearBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportCsvAll">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportDocAll">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©ØŒ ÙˆØµÙØŒ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <input id="filterStatus" placeholder="ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)" style="width:220px;max-width:40%" />
        <button class="btn ghost" id="applyFiltersBtn">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="btn ghost" id="clearFiltersBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromFault" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToFault" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterFaultBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="faultTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="faultCards" class="card-view"></div>

      <div id="faultsPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF buttons -->
      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printPdfCurrentPage">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" style="background:#0077b6" id="printPdfAll">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
        <button class="btn" style="background:#009688" id="printFaultsSummaryBtn">Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- MAINTENANCE -->
  <div id="page_maintenance" class="page" style="display:none">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ§Ù†Ø©</h3>
      <div id="maintenanceForm">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="mainGroup">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <div id="mainItemContainer">
          <label style="margin-top:6px">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <select id="mainItem" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
          </select>
        </div>
        <div id="customMainGroupContainer" style="display:none">
          <div id="customMainPlaceContainer">
            <label style="margin-top:6px">Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
            <input type="text" id="customMainPlace" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
          </div>
          <label style="margin-top:6px">Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMainName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
        </div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="mainPersonToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="mainPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="mainPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>KBA Egypt</option>
                  <option>CBE Team</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  
                </select>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mainDate" required />
       <label>Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±ØŸ</label>
        <select id="mainPartChanged">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
        <div id="mainPartFieldsContainer" style="display:none">
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number)</label><input id="mainLcode" />
          <label>Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input id="mainPartName" placeholder="Ø§Ø³Ù… Ù‚Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±" />
          <label>ÙƒÙ…ÙŠØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input type="number" id="mainPartQty" min="0" value="0" />
        </div>
        <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
        <select id="mainType">
          <option>Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
          <option>Ø´Ù‡Ø±ÙŠØ©</option>
          <option>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
          <option>Ø³Ù†ÙˆÙŠØ©</option>
          <option>Ø·Ø§Ø±Ø¦Ø©</option>
        </select>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="mainNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ÙˆØµÙ Ø§Ù„ØµÙŠØ§Ù†Ø©"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addMaintenanceBtn">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©</button>
          <button class="btn ghost" id="clearMaintenanceBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportMaintenanceCsv">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportMaintenanceDoc">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchMaintenance" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyMaintenanceFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterMaintenanceBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="maintenanceTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="maintenanceCards" class="card-view"></div>

      <div id="maintenancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printMaintenanceCurrentPage">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" style="background:#0077b6" id="printMaintenanceBtn">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
        <button class="btn" style="background:#009688" id="printMaintenanceSummaryBtn">Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </div>

  <!-- ÙƒØªØ§Ù„ÙˆØ¬  -->
  <div id="page_catalog" class="page" style="display:none">
    <div class="box">
      <h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙƒØªØ§Ù„ÙˆØ¬ ØµÙŠØ§Ù†Ø©</h3>
      <div id="catalogForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="catalogMachine">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
          <option value="Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù†">Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù†</option>
          <option value="Ø§Ù†ØªØ§Ù„ÙŠÙˆ">Ø§Ù†ØªØ§Ù„ÙŠÙˆ</option>
          <option value="Ù†ÙˆØªØ§ Ø³ÙƒØ±ÙŠÙ†">Ù†ÙˆØªØ§ Ø³ÙƒØ±ÙŠÙ†</option>
          <option value="Ø§ÙˆØ¨ØªÙŠ Ù†ÙˆØªØ§">Ø§ÙˆØ¨ØªÙŠ Ù†ÙˆØªØ§</option>
          <option value="ØªØ±Ù‚ÙŠÙ…">ØªØ±Ù‚ÙŠÙ…</option>
          <option value="Foil SMP 140">Foil SMP 140</option>
          <option value="BPS">BPS</option>
          <option value="CUTLINK">CUTLINK</option>
          <option value="CUTPAK">CUTPAK</option>
          <option value="Ø§Ù„ÙØ±Ù…">Ø§Ù„ÙØ±Ù…</option>
          <option value="Ø§Ù„ØªØ¬Ù‡ÙŠØ²Ø§Øª">Ø§Ù„ØªØ¬Ù‡ÙŠØ²Ø§Øª</option>
        </select>
        
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="catalogDescription" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØµÙ"></textarea>
        
        <label>Ø§Ù„Ø±Ø§Ø¨Ø· / URL</label>
        <input type="url" id="catalogUrl" placeholder="https://example.com" />
        
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addCatalogBtn">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ù„ÙˆØ¬</button>
          <button class="btn ghost" id="clearCatalogBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportCatalogCsv">ØªØµØ¯ÙŠØ± CSV</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchCatalog" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©â€¦" style="flex:1" />
        <button class="btn ghost" id="applyCatalogFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="btn ghost" id="clearCatalogFilterBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="catalogTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="catalogCards" class="card-view"></div>

      <div id="catalogPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printCatalogCurrentPage">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" style="background:#0077b6" id="printCatalogAll">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>
  </div>

  <!-- ORDERS -->
  <div id="page_orders" class="page" style="display:none">
    <div class="box">
      <h3>Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ / ØªÙˆØ±ÙŠØ¯</h3>
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="orderNum" />
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label><input id="supplyNum" />
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="orderDate" required />
      <label>Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="orderPersonToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="orderPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="orderPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>Ø­Ø³Ù† Ù…Ø³Ø¹Ø¯</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø¬ÙˆØ¯Ø©</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</option>
                  <option>Ø¹Ù„ÙŠ Ù…Ø±Ø³ÙŠ</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                </select>
      <label>ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><textarea id="orderDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ ÙˆØµÙ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="addOrderBtn">Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±</button>
        <button class="btn ghost" id="clearOrderBtn">Ù…Ø³Ø­</button>
        <div class="flex"></div>
        <button class="btn" id="exportOrdersCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="exportOrdersDoc">ØªØµØ¯ÙŠØ± Word</button>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchOrder" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø± Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyOrderFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterOrderBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="orderTable">
        <thead><tr><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù…Ø±</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="orderCards" class="card-view"></div>
      <!-- Order details modal -->
      <div id="orderDetailsModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal" role="document" aria-labelledby="orderDetailsTitle">
          <h3 id="orderDetailsTitle">ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
          <div class="modal-row" id="orderDetailsContent" style="text-align:right;direction:rtl"></div>
          <div class="modal-actions">
            <button id="orderDetailsClose" class="btn btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
            <button id="orderDetailsEdit" class="btn">ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
        </div>
      </div>

      <div id="ordersPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF buttons -->
      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printOrdersCurrentPage">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" style="background:#0077b6" id="printOrdersBtn">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div id="page_attendance" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
      <div id="attendanceForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label>
        <select id="workerName">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</option>
          <option value="Ø¹Ù…Ø± Ø­Ù…Ø²Ø©">Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
          <option value="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ">Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
          <option value="Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯">Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
          <option value="Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡">Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
          <option value="Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„">Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
          <option value="Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„">Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„</option>
          <option value="Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±">Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
          <option value="Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ">Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
          <option value="Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ">Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
          <option value="Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯">Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
          <option value="Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…">Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
          <option value="Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯">Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
        </select>
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label><input id="workerNum" disabled />
        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="date" id="absenceDate" required />
        <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="number" id="daysCount" min="1" value="1" />
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</label>
        <select id="vacationType" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</option>
          <option value="Ø§Ø¬Ø§Ø²Ø© Ø§Ø¹ØªÙŠØ§Ø¯ÙŠ">Ø§Ø¬Ø§Ø²Ø© Ø§Ø¹ØªÙŠØ§Ø¯ÙŠ</option>
          <option value="Ø®Ù…Ø³Ø© Ù…ØªØµÙ„ÙŠÙ†">Ø®Ù…Ø³Ø© Ù…ØªØµÙ„ÙŠÙ†</option>
          <option value="Ø¨Ø¯Ù„ Ø±Ø§Ø­Ø©">Ø¨Ø¯Ù„ Ø±Ø§Ø­Ø©</option>
          <option value="Ù…Ø£Ù…ÙˆØ±ÙŠØ©">Ù…Ø£Ù…ÙˆØ±ÙŠØ©</option>
          <option value="Ù…Ø±Ø¶ÙŠ Ø®Ø¯Ù…Ø© Ø°Ø§ØªÙŠØ© 12 ÙŠÙˆÙ…">Ù…Ø±Ø¶ÙŠ Ø®Ø¯Ù…Ø© Ø°Ø§ØªÙŠØ© 12 ÙŠÙˆÙ…</option>
          <option value="Ø±ØµÙŠØ¯ Ù…Ø±Ø­Ù„ Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù„ÙŠ ÙØ§ØªØª">Ø±ØµÙŠØ¯ Ù…Ø±Ø­Ù„ Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù„ÙŠ ÙØ§ØªØª</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addAttendanceBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„</button>
          <button class="btn ghost" id="clearAttendanceBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportAttendanceCsv">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportAttendanceDoc">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchAttendance" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyAttendanceFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div id="attendanceSummary" style="margin:8px 0;font-weight:600;display:none"></div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterAttendanceBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="attendanceCards" class="card-view"></div>

      <!-- Password modal for attendance cards (keeps cards hidden unless unlocked) -->
      <div id="attendancePasswordModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal" role="document" aria-labelledby="attendancePasswordTitle">
          <h3 id="attendancePasswordTitle">ÙØªØ­ Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª</h3>
          <div class="modal-row">Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª.</div>
          <div class="modal-row">
            <div class="pwd-toggle">
              <input id="attendancePasswordInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="eye-icon" onclick="togglePassword('attendancePasswordInput')">ğŸ‘ï¸</span>
            </div>
          </div>
          <div class="modal-actions">
            <button id="attendancePasswordCancel" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="attendancePasswordSubmit" class="btn btn-primary">ÙØªØ­</button>
          </div>
        </div>
      </div>

      <div id="attendancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printAttendanceCurrentPage">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" style="background:#0077b6" id="printAttendanceBtn">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>
  </div>

  <!-- TRASH -->
  <div id="page_trash" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h3>
      <div style="margin-bottom:8px">
        <button class="btn ghost" id="emptyTrashBtn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
        <button class="btn" id="changeDeletePasswordBtn">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      </div>
      <h4>Ø£Ø¹Ø·Ø§Ù„ Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashFaults"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø£ÙˆØ§Ù…Ø± Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashOrders"><thead><tr><th>Ø£Ù…Ø±</th><th>ØªÙˆØ±ÙŠØ¯</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashAttendance"><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ / Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashMaintenance"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>

      <h4 style="margin-top:12px">ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙ</h4>
      <div class="table-responsive">
      <table id="trashCatalog"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="page_dash" class="page" style="display:none">
    <div id="tiles" style="margin-bottom:12px"></div>
      <div style="max-width:900px;margin:8px auto 14px;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap">
        <label style="font-weight:600">ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
        <input id="dashDateFrom" type="date" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
        <label style="font-weight:600">Ø¥Ù„Ù‰</label>
        <input id="dashDateTo" type="date" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
        <label style="font-weight:600">Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="dashMachineGroup" style="padding:6px;border-radius:6px;border:1px solid #ddd;min-width:160px">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <label style="font-weight:600">Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="dashMachineItem" style="padding:6px;border-radius:6px;border:1px solid #ddd;min-width:180px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <button class="btn" id="dashFilterBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…</button>
        <button class="btn-ghost" id="dashResetBtn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
      <input type="hidden" id="filterMaintenanceType" value="" />
    <div class="box" style="max-width:800px;margin:0 auto">
      <canvas id="pie"></canvas>
      <div style="margin-top:12px">
        <div id="dashSummary" style="text-align:center;margin-bottom:8px;font-weight:700;color:#08365F"></div>
        <div class="table-responsive">
        <table id="dashTable" style="width:100%"><thead><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘         Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª    â•‘
   â•‘                                                                â•‘
   â•‘  Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ÙƒÙˆØ¯:                                   â•‘
   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
   â•‘  1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ API ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©                         â•‘
   â•‘  2. Ø®Ø±ÙŠØ·Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ£Ø±Ù‚Ø§Ù…Ù‡Ù…                               â•‘
   â•‘  3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ                         â•‘
   â•‘  4. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©                    â•‘
   â•‘  5. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© (uid, ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ etc)               â•‘
   â•‘  6. Ø¯ÙˆØ§Ù„ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª                       â•‘
   â•‘  7. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ù„Ø£Ø¹Ø·Ø§Ù„                                      â•‘
   â•‘  8. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡                                 â•‘
   â•‘  9. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ù„ØµÙŠØ§Ù†Ø©                                      â•‘
   â•‘  10. ØªØµÙÙŠØ© ÙˆÙÙ„ØªØ±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©                              â•‘
   â•‘  11. Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙˆØ§Ù„ØªØµØ¯ÙŠØ±Ø§Øª                          â•‘
   â•‘  12. Ø¹Ù…Ù„ÙŠØ§Øª CRUD ÙˆØªØµØ¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ±               â•‘
   â•‘  13. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© Ù„Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±                   â•‘
   â•‘  14. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© (CSV, Word, PDF)                 â•‘
   â•‘  15. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª                                 â•‘
   â•‘  16. Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©                                â•‘
   â•‘  17. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØµÙŠÙŠØ± (Render) Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©                   â•‘
   â•‘  18. Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©         â•‘
   â•‘                                                                â•‘
   â•‘  Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø­ÙÙˆØ¸Ø© ÙˆØªØ¹Ù…Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ â€” Ù„Ù… Ù†ØºÙŠØ± Ø£ÙŠ       â•‘
   â•‘  Ù…Ù†Ø·Ù‚ØŒ ÙÙ‚Ø· Ø£Ø¶ÙÙ†Ø§ ØªÙ‚Ø³ÙŠÙ…Ø§Øª ØªÙ†Ø¸ÙŠÙ…ÙŠØ© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ù‡Ù„              â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ API ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://script.google.com/macros/s/AKfycbxEXMoQ67l_MTrDawtk5fywCDTOuL4rtMc3v92G3q03abz_fwn1ilaPJP3px8Rwjs1O/exec';

/* storage keys */
const K_FAULTS='faults_v2_final', K_ORDERS='orders_v2_final', K_TRASH='trash_v2_final', K_ATT='attendance_v1', K_MAINTENANCE='maintenance_v1';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. Ø®Ø±ÙŠØ·Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ£Ø±Ù‚Ø§Ù…Ù‡Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// worker name â†’ worker number mapping (persisted)
const K_WORKERS = 'worker_map_v1';
let WORKER_MAP = JSON.parse(localStorage.getItem(K_WORKERS) || '{}');
function saveWorkerMap(){ localStorage.setItem(K_WORKERS, JSON.stringify(WORKER_MAP)); }
// merge user-provided worker mappings (overwrite or add)
const NEW_WORKERS = {
  "Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡": "207487",
  "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ": "207070",
  "Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯": "207478",
  "Ø¹Ù…Ø± Ø­Ù…Ø²Ø©": "207053",
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„": "207533",
  "Ù…Ø¹Ø§Ø° ÙƒÙ…Ø§Ù„": "208568",
  "Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ": "207252",
  "Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±": "207081",
  "Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ": "207230",
  "Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯": "207097",
  "Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…": "207106",
  "Ø§Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯": "207061",
};
Object.assign(WORKER_MAP, NEW_WORKERS);
saveWorkerMap();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/* load */
let faults = JSON.parse(localStorage.getItem(K_FAULTS)||'[]');
let orders = JSON.parse(localStorage.getItem(K_ORDERS)||'[]');
let maintenance = JSON.parse(localStorage.getItem(K_MAINTENANCE)||'[]');
let trash = JSON.parse(localStorage.getItem(K_TRASH)||'{"faults":[],"orders":[],"attendance":[],"maintenance":[]}');
let attendance = JSON.parse(localStorage.getItem(K_ATT)||'[]');
let catalog = JSON.parse(localStorage.getItem('catalog_v1')||'[]');
let catalogTrash = JSON.parse(localStorage.getItem('catalog_trash')||'[]');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªÙ†Ø¶ÙŠÙ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† trash.maintenance Ù…ÙˆØ¬ÙˆØ¯Ø©
if(!trash.maintenance) trash.maintenance = [];

// ØªÙ†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø²Ø§Ø¦Ø¯
faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
maintenance.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
trash.faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
trash.orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
trash.maintenance?.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });

/* PAGINATION SETUP */
const ITEMS_PER_PAGE = 10;
let currentPageFaults = 1;
let currentPageOrders = 1;
let currentPageMaintenance = 1;
let currentPageAttendance = 1;
let currentPageCatalog = 1;
let isFilteredFaults = false;
let isFilteredOrders = false;
let isFilteredMaintenance = false;
let isFilteredAttendance = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPaginatedData(data) {
  // Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø¢Ø®Ø± Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹)
  return data.slice().reverse();
}

function paginate(data, pageNum) {
  const reversed = getPaginatedData(data);
  const start = (pageNum - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  return {
    items: reversed.slice(start, end),
    totalPages: Math.ceil(reversed.length / ITEMS_PER_PAGE),
    totalItems: reversed.length,
    currentPage: pageNum
  };
}

function updatePaginationButtons(containerSelector, totalPages, currentPage, onPageChange) {
  const container = document.querySelector(containerSelector);
  if (!container) return;
  
  container.innerHTML = '';
  
  // Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
  const firstBtn = document.createElement('button');
  firstBtn.className = 'btn ghost';
  firstBtn.textContent = '|< Ø£ÙˆÙ„ ØµÙØ­Ø©';
  firstBtn.disabled = currentPage === 1;
  firstBtn.onclick = () => onPageChange(1);
  container.appendChild(firstBtn);
  
  // Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn ghost';
  prevBtn.textContent = '< Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => onPageChange(currentPage - 1);
  container.appendChild(prevBtn);
  
  // Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©
  const pageInfo = document.createElement('span');
  pageInfo.style.cssText = 'margin:0 8px;display:inline-block;color:#666';
  pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}`;
  container.appendChild(pageInfo);
  
  // Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn ghost';
  nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠØ© >';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => onPageChange(currentPage + 1);
  container.appendChild(nextBtn);
  
  // Ø²Ø±Ø§Ø± Ø¢Ø®Ø± ØµÙØ­Ø©
  const lastBtn = document.createElement('button');
  lastBtn.className = 'btn ghost';
  lastBtn.textContent = 'Ø¢Ø®Ø± ØµÙØ­Ø© >|';
  lastBtn.disabled = currentPage === totalPages;
  lastBtn.onclick = () => onPageChange(totalPages);
  container.appendChild(lastBtn);
}
attendance.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
trash.attendance?.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
saveAll();

/* Trash sync interval - declare early to avoid ReferenceError */
let trashSyncInterval = null;

/* ui refs */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const navFaults = document.getElementById('navFaults');
const navMaintenance = document.getElementById('navMaintenance');
const navCatalog = document.getElementById('navCatalog');
const navOrders = document.getElementById('navOrders');
const navAttendance = document.getElementById('navAttendance');
const navTrash = document.getElementById('navTrash');
const navDash = document.getElementById('navDash');
const navHome = document.getElementById('navHome');

navFaults.onclick = ()=>{show('faults'); setTimeout(()=>showLatestFaultNotification(), 500);};
navMaintenance.onclick = ()=>{show('maintenance'); setTimeout(()=>showLatestMaintenanceNotification(), 500);};
navCatalog.onclick = ()=>{show('catalog');setTimeout(()=>showLatestCatalogNotification(), 500);};
navOrders.onclick = ()=>{show('orders'); setTimeout(()=>showLatestOrderNotification(), 500);};
navAttendance.onclick = ()=>{show('attendance'); setTimeout(()=>showLatestAttendanceNotification(), 500);};
navTrash.onclick = ()=>show('trash');
navDash.onclick = ()=>show('dash');
if(navHome) navHome.onclick = ()=>show('home');

function show(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  // Handle home page: hide header/nav for a clean white landing
  if(page === 'home'){
    const headerEl = document.querySelector('header');
    const navEl = document.querySelector('nav');
    if(headerEl) headerEl.style.display = 'none';
    if(navEl) navEl.style.display = 'none';
    document.body.style.background = '#fff';
    const el = document.getElementById('page_home'); if(el) { el.classList.add('home-fullscreen'); el.style.display = 'block'; }
    return;
  }
  // restore header/nav when not on home
  const headerEl = document.querySelector('header');
  const navEl = document.querySelector('nav');
  if(headerEl) headerEl.style.display = '';
  if(navEl) navEl.style.display = '';
  document.body.style.background = '';

  if(page==='faults'){ document.getElementById('page_faults').style.display='block'; navFaults.classList.add('active'); stopTrashSync(); }
  if(page==='maintenance'){ document.getElementById('page_maintenance').style.display='block'; navMaintenance.classList.add('active'); stopTrashSync(); }
  if(page==='catalog'){ document.getElementById('page_catalog').style.display='block'; navCatalog.classList.add('active'); stopTrashSync(); }
  if(page==='orders'){ document.getElementById('page_orders').style.display='block'; navOrders.classList.add('active'); stopTrashSync(); }
  if(page==='attendance'){ document.getElementById('page_attendance').style.display='block'; navAttendance.classList.add('active'); stopTrashSync(); }
  if(page==='trash'){ document.getElementById('page_trash').style.display='block'; navTrash.classList.add('active'); startTrashSync(); }
  if(page==='dash'){ document.getElementById('page_dash').style.display='block'; navDash.classList.add('active'); drawDashboard(); stopTrashSync(); }
}
show('home');

// Ø¯Ø§Ù„Ø© Ù„ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ
function adjustHomePageTitleSize() {
  const homeTitle = document.querySelector('#page_home h1');
  if (homeTitle) {
    if (window.innerWidth <= 600) {
      homeTitle.style.fontSize = '20px';
    } else {
      homeTitle.style.fontSize = '';
    }
  }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', adjustHomePageTitleSize);

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
window.addEventListener('resize', adjustHomePageTitleSize);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø¹Ø·Ù„ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡
function showLatestFaultNotification() {
  if(faults && faults.length > 0) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ø¹Ø·Ù„ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ ÙØ¹Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø«)
    // ÙˆØ¥Ø°Ø§ ØªÙƒØ±Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ø®ØªØ± Ø¢Ø®Ø± Ø¹Ø·Ù„ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®
    let latestFault = faults[0];
    let latestDate = new Date(latestFault.date || 0).getTime();
    
    for(let i = 1; i < faults.length; i++) {
      const faultDate = new Date(faults[i].date || 0).getTime();
      if(faultDate >= latestDate) {
        latestDate = faultDate;
        latestFault = faults[i];
      }
    }
    
    const faultInfo = `
Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©: ${latestFault.machine}
Ø§Ù„Ù‚Ø§Ø¦Ù…: ${latestFault.person}
Ø§Ù„ÙˆØµÙ: ${latestFault.description}
Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„: ${latestFault.solution || '-'}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${latestFault.date}
Ø§Ù„Ø­Ø§Ù„Ø©: ${latestFault.status}`;
    
    showNotification('Ø¢Ø®Ø± Ø¹Ø·Ù„ Ù…Ø³Ø¬Ù„', faultInfo);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§
function showLatestMaintenanceNotification() {
  if(maintenance && maintenance.length > 0) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙØ¹Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø«)
    // ÙˆØ¥Ø°Ø§ ØªÙƒØ±Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ø®ØªØ± Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø© ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®
    let latestMaintenance = maintenance[0];
    let latestDate = new Date(latestMaintenance.date || 0).getTime();
    
    for(let i = 1; i < maintenance.length; i++) {
      const maintDate = new Date(maintenance[i].date || 0).getTime();
      if(maintDate >= latestDate) {
        latestDate = maintDate;
        latestMaintenance = maintenance[i];
      }
    }
    
    const mainInfo = `
Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©: ${latestMaintenance.machine}
Ø§Ù„Ù‚Ø§Ø¦Ù…: ${latestMaintenance.person}
Ø§Ù„Ù†ÙˆØ¹: ${latestMaintenance.type}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${latestMaintenance.date}
Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${latestMaintenance.notes || '-'}
ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹ ØºÙŠØ§Ø±: ${latestMaintenance.partChanged === 'yes' ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}${latestMaintenance.partChanged === 'yes' ? `
Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©: ${latestMaintenance.partName || '-'}
Ø§Ù„ÙƒÙ…ÙŠØ©: ${latestMaintenance.partQty || '-'}` : ''}`;
    
    showNotification('Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø© Ù…Ø³Ø¬Ù„Ø©', mainInfo);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙƒØªØ§Ù„ÙˆØ¬ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡
function showLatestCatalogNotification() {
  if(catalog && catalog.length > 0) {
    // Use the paginated view (reversed) so the most recently registered item appears first
    const latestCatalog = getPaginatedData(catalog)[0] || catalog[0];
    const catalogInfo = `
Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©: ${latestCatalog.machine}
Ø§Ù„ÙˆØµÙ: ${latestCatalog.description || '-'}
Ø§Ù„Ø±Ø§Ø¨Ø·: ${latestCatalog.url || '-'}`;
    
    showNotification('Ø¢Ø®Ø± ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ø³Ø¬Ù„', catalogInfo);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡
function showLatestOrderNotification() {
  if(orders && orders.length > 0) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ø£Ù…Ø± ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø«)
    let latestOrder = orders[0];
    let latestDate = new Date(latestOrder.date || 0).getTime();
    
    for(let i = 1; i < orders.length; i++) {
      const orderDate = new Date(orders[i].date || 0).getTime();
      if(orderDate > latestDate) {
        latestDate = orderDate;
        latestOrder = orders[i];
      }
    }
    
    const orderInfo = `
Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±: ${latestOrder.orderNum || '-'}
Ø§Ù„ØªÙˆØ±ÙŠØ¯: ${latestOrder.supplyNum || '-'}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${latestOrder.date || '-'}
Ø§Ù„Ù‚Ø§Ø¦Ù…: ${latestOrder.person}`;
    
    showNotification('Ø¢Ø®Ø± Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ù…Ø³Ø¬Ù„', orderInfo);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø£Ø¬Ø§Ø²Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§
function showLatestAttendanceNotification() {
  if(attendance && attendance.length > 0) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ø£Ø¬Ø§Ø²Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø«)
    let latestAtt = attendance[0];
    let latestDate = new Date(latestAtt.absenceDate || 0).getTime();
    
    for(let i = 1; i < attendance.length; i++) {
      const attDate = new Date(attendance[i].absenceDate || 0).getTime();
      if(attDate > latestDate) {
        latestDate = attDate;
        latestAtt = attendance[i];
      }
    }
    
    const attInfo = `
Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù: ${latestAtt.workerName}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø¬Ø§Ø²Ø©: ${latestAtt.absenceDate}
Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: ${latestAtt.daysCount}
Ø§Ù„Ù†ÙˆØ¹: ${latestAtt.vacationType}`;
    
    showNotification('Ø¢Ø®Ø± Ø£Ø¬Ø§Ø²Ø© Ù…Ø³Ø¬Ù„Ø©', attInfo);
  }
}

// Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹)
window.addEventListener('load', function() {
  setTimeout(function() {
    const welcomeTime = new Date().toLocaleTimeString('ar-EG');
    showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ', 'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… - ' + welcomeTime);
  }, 500);
});

// Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', function() {
  console.log('â¹ï¸ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
});

window.addEventListener('pageshow', function(event) {
  if(event.persisted) {
    // Ø¹ÙˆØ¯Ø© Ù…Ù† cache (Ø§Ù„Ø²Ø± Ø§Ù„Ø®Ù„ÙÙŠ)
    const time = new Date().toLocaleTimeString('ar-EG');
    showNotification('Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø©', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ' + time);
  } else {
    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯
    const time = new Date().toLocaleTimeString('ar-EG');
    showNotification('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© - ' + time);
  }
});

// Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
window.addEventListener('unload', function() {
  console.log('ğŸšª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºØ§Ø¯Ø± Ø§Ù„ØµÙØ­Ø©');
});

/* helpers */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getTodayDate(){ 
  const d = new Date(); 
  const year = d.getFullYear(); 
  const month = String(d.getMonth()+1).padStart(2,'0'); 
  const day = String(d.getDate()).padStart(2,'0'); 
  return `${year}-${month}-${day}`; 
}
function formatDateOnly(dateStr) {
  if (!dateStr) return '';
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙŠØºØ© YYYY-MM-DD ÙÙ‚Ø·ØŒ Ø£Ø±Ø¬Ø¹Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆÙ‚ØªØŒ Ø´ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
  return dateStr.split('T')[0].split(' ')[0];
}
function saveAll(){ 
  localStorage.setItem(K_FAULTS, JSON.stringify(faults)); 
  localStorage.setItem(K_ORDERS, JSON.stringify(orders)); 
  localStorage.setItem(K_MAINTENANCE, JSON.stringify(maintenance)); 
  localStorage.setItem(K_TRASH, JSON.stringify(trash)); 
  localStorage.setItem(K_ATT, JSON.stringify(attendance));
  localStorage.setItem('catalog_v1', JSON.stringify(catalog));
  localStorage.setItem('catalog_trash', JSON.stringify(catalogTrash));
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© + ØµÙˆØª + Ø¥Ø´Ø¹Ø§Ø± Ù…ØªØµÙØ­)
function showNotification(title, message, type = 'success') {
  // 1. Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© (Toast)
  showSuccess(message);
  
  // 2. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  playNotificationSound();
  
  // 3. Ø¥Ø´Ø¹Ø§Ø± Ù…ØªØµÙØ­ (Browser Notification)
  if('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, {
      body: message,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%230A4C88"/><text x="50" y="60" font-size="50" fill="white" text-anchor="middle" font-weight="bold">âš™</text></svg>',
      tag: 'system-notification'
    });
  }
}

// Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function playNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') {
      audioContext.resume().then(() => {
        playSound(audioContext);
      }).catch(err => console.warn('Audio resume failed:', err));
    } else {
      playSound(audioContext);
    }
  } catch (e) {
    console.warn('Audio not supported:', e);
  }
}

function playSound(audioContext) {
  try {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800; // ØªØ±Ø¯Ø¯ Ø§Ù„ØµÙˆØª
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    console.warn('Error playing sound:', e);
  }
}

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
if('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
const NOTIFICATION_EMAIL = 'abdallawael2025@gmail.com';

function sendEmailNotification(title, message) {
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ console Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
  const timestamp = new Date().toLocaleString('ar-EG');
  console.log('ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', { title, message, to: NOTIFICATION_EMAIL, timestamp });
  
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± FormSubmit (Ø®Ø¯Ù…Ø© Ù…Ø¬Ø§Ù†ÙŠØ©)
  const emailData = {
    email: NOTIFICATION_EMAIL,
    name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
    subject: title,
    message: message,
    timestamp: timestamp
  };
  
  // Ø¬Ø±Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± FormSubmit.co
  fetch('https://formsubmit.co/ajax/' + NOTIFICATION_EMAIL, {
    method: 'POST',
    body: JSON.stringify(emailData),
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  }).then(response => {
    if(response.ok) {
      console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ' + NOTIFICATION_EMAIL);
    } else {
      console.warn('âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø±Ù…Ø²:', response.status);
    }
  }).catch(err => {
    console.log('âš ï¸ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù‚Ø¯ Ù„Ø§ ÙŠØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª):', err);
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function notifyAction(actionType, itemType, itemName = '') {
  const messages = {
    'fault_added': { title: 'Ø¹Ø·Ù„ Ø¬Ø¯ÙŠØ¯', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø·Ù„ Ø¬Ø¯ÙŠØ¯${itemName ? ' - ' + itemName : ''}` },
    'fault_edited': { title: 'ØªØ­Ø¯ÙŠØ« Ø¹Ø·Ù„', message: `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø·Ù„${itemName ? ' - ' + itemName : ''}` },
    'fault_deleted': { title: 'Ø­Ø°Ù Ø¹Ø·Ù„', message: `ØªÙ… Ø­Ø°Ù Ø¹Ø·Ù„${itemName ? ' - ' + itemName : ''}` },
    'maintenance_added': { title: 'ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©${itemName ? ' - ' + itemName : ''}` },
    'maintenance_edited': { title: 'ØªØ­Ø¯ÙŠØ« ØµÙŠØ§Ù†Ø©', message: `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ§Ù†Ø©${itemName ? ' - ' + itemName : ''}` },
    'maintenance_deleted': { title: 'Ø­Ø°Ù ØµÙŠØ§Ù†Ø©', message: `ØªÙ… Ø­Ø°Ù ØµÙŠØ§Ù†Ø©${itemName ? ' - ' + itemName : ''}` },
    'order_added': { title: 'Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯', message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯${itemName ? ' - ' + itemName : ''}` },
    'order_edited': { title: 'ØªØ­Ø¯ÙŠØ« Ø£Ù…Ø± Ø´Ø±Ø§Ø¡', message: `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡${itemName ? ' - ' + itemName : ''}` },
    'order_deleted': { title: 'Ø­Ø°Ù Ø£Ù…Ø± Ø´Ø±Ø§Ø¡', message: `ØªÙ… Ø­Ø°Ù Ø£Ù…Ø± Ø´Ø±Ø§Ø¡${itemName ? ' - ' + itemName : ''}` },
    'attendance_added': { title: 'Ø£Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø©', message: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø©${itemName ? ' - ' + itemName : ''}` },
    'attendance_edited': { title: 'ØªØ­Ø¯ÙŠØ« Ø£Ø¬Ø§Ø²Ø©', message: `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø£Ø¬Ø§Ø²Ø©${itemName ? ' - ' + itemName : ''}` },
    'attendance_deleted': { title: 'Ø­Ø°Ù Ø£Ø¬Ø§Ø²Ø©', message: `ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø£Ø¬Ø§Ø²Ø©${itemName ? ' - ' + itemName : ''}` }
  };
  
  const msg = messages[actionType];
  if(msg) {
    showNotification(msg.title, msg.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. Ø¯ÙˆØ§Ù„ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£Ùˆ Dash Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
function getSelectedMachineLine(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return { machine: '', line: '' };
  const opt = sel.options[sel.selectedIndex];
  if(!opt) return { machine: '', line: '' };
  const machine = opt.text || '';
  const line = opt.parentElement && opt.parentElement.label ? opt.parentElement.label : '';
  return { machine: machine.trim(), line: line.trim() };
}

function setSelectMachineLine(selectId, machine, line){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  for(let i=0;i<sel.options.length;i++){
    const o = sel.options[i];
    const grp = o.parentElement && o.parentElement.label ? o.parentElement.label : '';
    if(o.text === (machine||'') && grp === (line||'')){
      sel.selectedIndex = i; return;
    }
  }
  // fallback: try match by machine text only
  for(let i=0;i<sel.options.length;i++) if(sel.options[i].text === (machine||'')){ sel.selectedIndex = i; return; }
  sel.selectedIndex = 0;
}

// -- Grouped selection support (group -> items)
const MACHINE_GROUPS = {
  "Ø®Ø· Ù¡": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¡","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¡","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¢","Ù†ÙˆØªØ§Ø³ÙƒØ±ÙŠÙ† Ù¡","ØªØ±Ù‚ÙŠÙ… Ù¡"],
  "Ø®Ø· Ù¢": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¢","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù£","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¤","Ù†ÙˆØªØ§Ø³ÙƒØ±ÙŠÙ† Ù¢","ØªØ±Ù‚ÙŠÙ… Ù¢"],
  "Ø®Ø· Ù£": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù£","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¥","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¦","Ø§ÙˆØ¨ØªÙŠ Ù†ÙˆØªØ§","ØªØ±Ù‚ÙŠÙ… Ù£"],
  "Ø®Ø· Ù¤": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¤","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù§","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¨","Foil SPM 140","ØªØ±Ù‚ÙŠÙ… Ù¤"],
  "ØªØ´Ø·ÙŠØ¨": ["BPS 1","BPS 2","BPS 3","Cutlink 1","Cutlink 2","Cutpak 1","Cutpak 2","Kallfas Shrink Offline 1","Kallfas Shrink Offline 2","Bars"],
  "Ø§Ù„ÙØ±Ù…": ["BDS 1","BDS 2","Silo 1","Silo 2"],
  "Ø§Ù„ØªØ¬Ù‡ÙŠØ²Ø§Øª": [
    "lathe machine 1","lathe machine 2","plastirota 1","plastirota 2","plastmix 1","plastmix 2",
    "plate grinding 1","plate grinding 2","plate coat 1","plate coat 2","pilfora lv","Plate Shear","plate Bright",
    "Ø­ÙˆØ¶ Ø§Ù„Ù†ÙŠÙƒÙ„ 1+ Rectifier 1","Ø­ÙˆØ¶ Ø§Ù„Ù†ÙŠÙƒÙ„ 2+ Rectifier 2","Ø­ÙˆØ¶ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ù„ØªÙ†Ø´ÙŠØ· + Rectifier 3","Ø¬Ù‡Ø§Ø² Ù†Ø²Ø¹ Ø§Ù„Ø§Ù…Ù„Ø§Ø­ Ù…Ù† Ø§Ù„Ù…ÙŠØ§Ù‡","scrubber",
    "CToP 1","CToP 2","PolyWash 1","PolyWash 2","PolyExpose 1","PolyExpose 2","Plate Bender","Plate Punch IV",
    "Vertical burning-in oven","Vertical drying cabinet","Gravograph 1","Gravograph 2","plate check","Mathemat digital","Ùˆ Ù…Ù„Ø­Ù‚Ø§ØªÙ‡ CTiP",
    "Galvano Lab","Ù‚Ø³Ù… Ø§Ù„Ø§Ø­Ø¨Ø§Ø±","tensiometer","microscopes","Plate Inspection","Ø§Ù„Ù„ÙˆØ±Ø¬ÙŠ","Ø­ÙˆØ¶ Ø§Ù„ØµÙŠØ§Ù†Ù‡","ÙˆØ­Ø¯Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ù‡","Mathemat digital 2"],
  "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©": ["__custom__"],
  "Ø£Ø®Ø±ÙŠ": ["__custom__"]
};

function initGroupSelects(){
  const groups = Object.keys(MACHINE_GROUPS);
  const mg = document.getElementById('machineGroup');
  const mg2 = document.getElementById('mainGroup');
  const mgDash = document.getElementById('dashMachineGroup');
  if(mg){ mg.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg.appendChild(o); }); }
  if(mg2){ mg2.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg2.appendChild(o); }); }
  if(mgDash){ mgDash.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mgDash.appendChild(o); }); }
}

function populateItemsForGroup(groupName, itemSelectId){
  const items = MACHINE_GROUPS[groupName] || [];
  const sel = document.getElementById(itemSelectId);
  if(!sel) return;
  
  // Ø­Ø¯Ø¯ Ø£ÙŠ Ø­Ø§ÙˆÙŠØ§Øª Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡Ø§
  let itemContainer = null;
  let customContainer = null;
  
  if(itemSelectId === 'machineItem') {
    itemContainer = document.getElementById('machineItemContainer');
    customContainer = document.getElementById('customMachineGroupContainer');
  } else if(itemSelectId === 'mainItem') {
    itemContainer = document.getElementById('mainItemContainer');
    customContainer = document.getElementById('customMainGroupContainer');
  }
  
 // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© "Ø£Ø®Ø±ÙŠ" Ø£Ùˆ "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø®ÙÙ select ÙˆØ§Ø¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(groupName === 'Ø£Ø®Ø±ÙŠ' || groupName === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>';
    sel.disabled = true;
    if(itemContainer) itemContainer.style.display = 'none';
    if(customContainer) customContainer.style.display = 'block';
    let placeEl = null;
    let nameEl = null;
    let placeContainer = null;
    // Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    if(itemSelectId === 'machineItem') {
      placeEl = document.getElementById('customMachinePlace');
      nameEl = document.getElementById('customMachineName');
      placeContainer = document.getElementById('customMachinePlaceContainer');
    } else if(itemSelectId === 'mainItem') {
      placeEl = document.getElementById('customMainPlace');
      nameEl = document.getElementById('customMainName');
      placeContainer = document.getElementById('customMainPlaceContainer');
    }
    // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ "Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" ÙÙ‚Ø· Ù„Ù€ "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©" ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡ Ù„Ù€ "Ø£Ø®Ø±ÙŠ"
    if(groupName === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
      if(placeContainer) placeContainer.style.display = 'none';
      if(placeEl) placeEl.removeAttribute('required');
      if(nameEl) nameEl.setAttribute('required','required');
    } else if(groupName === 'Ø£Ø®Ø±ÙŠ') {
      if(placeContainer) placeContainer.style.display = 'block';
      if(placeEl) placeEl.setAttribute('required','required');
      if(nameEl) nameEl.setAttribute('required','required');
    }
    return;
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø± select ÙˆØ¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(itemContainer) itemContainer.style.display = 'block';
  if(customContainer) customContainer.style.display = 'none';
  let placeContainer = null;
  let placeEl = null;
  let nameEl = null;
  // Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  if(itemSelectId === 'machineItem') {
    placeContainer = document.getElementById('customMachinePlaceContainer');
    placeEl = document.getElementById('customMachinePlace');
    nameEl = document.getElementById('customMachineName');
  } else if(itemSelectId === 'mainItem') {
    placeContainer = document.getElementById('customMainPlaceContainer');
    placeEl = document.getElementById('customMainPlace');
    nameEl = document.getElementById('customMainName');
  }
  // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ "Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  if(placeContainer) placeContainer.style.display = 'block';
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© ØµÙØ© required Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©
  if(placeEl) placeEl.removeAttribute('required');
  if(nameEl) nameEl.removeAttribute('required');
  
  if(!groupName || items.length===0){ sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; sel.disabled = true; return; }
  sel.disabled = false; sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>';
  items.forEach(it=>{ const o = document.createElement('option'); o.value = it; o.textContent = it; sel.appendChild(o); });
}

// Populate dashboard machine items select
function populateDashItemsForGroup(groupName){
  const items = MACHINE_GROUPS[groupName] || [];
  const sel = document.getElementById('dashMachineItem');
  if(!sel) return;
  sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>';
  items.forEach(it=>{ const o=document.createElement('option'); o.value = it; o.textContent = it; sel.appendChild(o); });
}

function getSelectedMachineLineFromGroups(groupId, itemId){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  const line = g ? (g.value||'') : '';
  let machine = it ? (it.value||'') : '';
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ" Ø£Ùˆ "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(line === 'Ø£Ø®Ø±ÙŠ' || line === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
    if(itemId === 'machineItem') {
      const place = document.getElementById('customMachinePlace');
      const name = document.getElementById('customMachineName');
      machine = (name ? name.value.trim() : '');
      // Ø§Ø³ØªØ®Ø¯Ù… place ÙƒÙ€ machine ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ"
      if(place && place.value.trim() && line === 'Ø£Ø®Ø±ÙŠ') {
        machine = place.value.trim() + ' - ' + machine;
      }
    } else if(itemId === 'mainItem') {
      const place = document.getElementById('customMainPlace');
      const name = document.getElementById('customMainName');
      machine = (name ? name.value.trim() : '');
      // Ø§Ø³ØªØ®Ø¯Ù… place ÙƒÙ€ machine ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ"
      if(place && place.value.trim() && line === 'Ø£Ø®Ø±ÙŠ') {
        machine = place.value.trim() + ' - ' + machine;
      }
    }
  }
  
  return { machine: machine.trim(), line: line.trim() };
}

function setGroupSelection(groupId, itemId, machine, line){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  if(!g || !it) return;
  g.value = line || '';
  populateItemsForGroup(g.value, itemId);
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© "Ø£Ø®Ø±ÙŠ" Ø£Ùˆ "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ù„Ø§ ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  if(line === 'Ø£Ø®Ø±ÙŠ' || line === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
    return;
  }
  
  if(machine){ for(let i=0;i<it.options.length;i++){ if(it.options[i].value === machine){ it.selectedIndex = i; break; } } }
}

document.addEventListener('DOMContentLoaded', function(){ initGroupSelects();
  document.getElementById('machineGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'machineItem'); });
  document.getElementById('mainGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'mainItem'); });
  document.getElementById('dashMachineGroup')?.addEventListener('change', function(){ populateDashItemsForGroup(this.value); });
});

// Auto-fill worker number when a worker name is selected in attendance
document.addEventListener('DOMContentLoaded', function(){
  const workerNameSelect = document.getElementById('workerName');
  const workerNumInput = document.getElementById('workerNum');
  if(!workerNameSelect) return;
  
  // Function to update worker number based on selected name
  function updateWorkerNum(){
    const name = (workerNameSelect.value||'').trim();
    if(!name) {
      if(workerNumInput) workerNumInput.value = '';
      return;
    }
    // Look up in WORKER_MAP
    if(WORKER_MAP[name]){
      if(workerNumInput) workerNumInput.value = WORKER_MAP[name];
    } else {
      // If not found, clear it
      if(workerNumInput) workerNumInput.value = '';
    }
  }
  
  // Update on change
  workerNameSelect.addEventListener('change', updateWorkerNum);
  
  // Initialize on page load
  updateWorkerNum();
});

// --- Multi-select hidden UI helpers (person & mainPerson)
function getSelectedValues(selectId){
  const sel = document.getElementById(selectId); if(!sel) return []; return Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v && v.trim());
}
function setMultiSelectValues(selectId, csvOrArray){
  const sel = document.getElementById(selectId); if(!sel) return;
  let arr = [];
  if(Array.isArray(csvOrArray)) arr = csvOrArray;
  else if(typeof csvOrArray === 'string' && csvOrArray.trim() !== '') arr = csvOrArray.split(',').map(s=>s.trim()).filter(Boolean);
  for(let i=0;i<sel.options.length;i++){ sel.options[i].selected = arr.includes(sel.options[i].value); }
}
function renderSelectedChips(selectId, chipsId){
  const sel = document.getElementById(selectId); const cont = document.getElementById(chipsId); if(!sel || !cont) return; cont.innerHTML='';
  const vals = getSelectedValues(selectId);
  if(vals.length===0){ cont.innerHTML = '<span class="empty">â€”</span>'; return; }
  vals.forEach(v=>{
    const span = document.createElement('span'); span.className='chip'; span.style.cssText='display:inline-block;background:#eef;padding:4px 8px;border-radius:12px;margin:2px;font-size:13px';
    span.textContent = v;
    const rem = document.createElement('button'); rem.type='button'; rem.textContent='âœ•'; rem.style.cssText='background:transparent;border:0;color:#900;cursor:pointer;margin-left:6px';
    rem.addEventListener('click', ()=>{ for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value===v){ sel.options[i].selected=false; break; } } renderSelectedChips(selectId,chipsId); });
    span.appendChild(rem);
    cont.appendChild(span);
  });
}

document.addEventListener('DOMContentLoaded', function(){
  // Toggle button for showing/hiding part fields
  const partChangedSelect = document.getElementById('partChanged');
  const partFieldsContainer = document.getElementById('partFieldsContainer');
  
  if(partChangedSelect && partFieldsContainer) {
    // Function to toggle part fields visibility
    function togglePartFields() {
      partFieldsContainer.style.display = partChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    partChangedSelect.addEventListener('change', togglePartFields);
    
    // Initialize on page load
    togglePartFields();
  }

  // Toggle button for showing/hiding maintenance part fields
  const mainPartChangedSelect = document.getElementById('mainPartChanged');
  const mainPartFieldsContainer = document.getElementById('mainPartFieldsContainer');
  
  if(mainPartChangedSelect && mainPartFieldsContainer) {
    // Function to toggle part fields visibility
    function toggleMainPartFields() {
      mainPartFieldsContainer.style.display = mainPartChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    mainPartChangedSelect.addEventListener('change', toggleMainPartFields);
    
    // Initialize on page load
    toggleMainPartFields();
  }
  
  // toggle buttons â€” show/hide select and update chips after change
  const personToggle = document.getElementById('personToggle');
  const mainPersonToggle = document.getElementById('mainPersonToggle');
  const personSel = document.getElementById('person');
  const mainPersonSel = document.getElementById('mainPerson');
  const orderPersonToggle = document.getElementById('orderPersonToggle');
  const orderPersonSel = document.getElementById('orderPerson');

  personToggle?.addEventListener('click', function(){
    if(!personSel) return;
    personSel.style.display = (personSel.style.display==='none'?'block':'none');
    if(personSel.style.display!=='none') personSel.focus();
    // update chips to reflect current selection whenever the list is toggled
    renderSelectedChips('person','personChips');
  });

  mainPersonToggle?.addEventListener('click', function(){
    if(!mainPersonSel) return;
    mainPersonSel.style.display = (mainPersonSel.style.display==='none'?'block':'none');
    if(mainPersonSel.style.display!=='none') mainPersonSel.focus();
    renderSelectedChips('mainPerson','mainPersonChips');
  });

  // order person toggle/listeners
  orderPersonToggle?.addEventListener('click', function(){
    if(!orderPersonSel) return;
    orderPersonSel.style.display = (orderPersonSel.style.display==='none'?'block':'none');
    if(orderPersonSel.style.display!=='none') orderPersonSel.focus();
    renderSelectedChips('orderPerson','orderPersonChips');
  });

  // update chips live when the user changes selection inside the hidden multi-select
  personSel?.addEventListener('change', function(){
    renderSelectedChips('person','personChips');
    // hide the multi-select after selection to keep UI compact
    personSel.style.display = 'none';
  });
  mainPersonSel?.addEventListener('change', function(){
    renderSelectedChips('mainPerson','mainPersonChips');
    mainPersonSel.style.display = 'none';
  });
  orderPersonSel?.addEventListener('change', function(){
    renderSelectedChips('orderPerson','orderPersonChips');
    orderPersonSel.style.display = 'none';
  });

  // render initial chips
  renderSelectedChips('person','personChips');
  renderSelectedChips('mainPerson','mainPersonChips');
  renderSelectedChips('orderPerson','orderPersonChips');
});

function displayValue(value) {
  const val = String(value || '').trim();
  if (!val || val === 'undefined' || val === 'null' || val === '0') {
    return '<span class="empty">â€”</span>';
  }
  return escapeHtml(val);
}

// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¯ÙŠÙ‡Ø§ IDs
maintenance.forEach(m => { if(!m.id) m.id = uid(); });
faults.forEach(f => { if(!f.id) f.id = uid(); });
orders.forEach(o => { if(!o.id) o.id = uid(); });
attendance.forEach(a => { if(!a.id) a.id = uid(); });
trash.faults.forEach(f => { if(!f.id) f.id = uid(); });
trash.orders.forEach(o => { if(!o.id) o.id = uid(); });
trash.maintenance.forEach(m => { if(!m.id) m.id = uid(); });
(trash.attendance||[]).forEach(a => { if(!a.id) a.id = uid(); });
saveAll();

function startTrashSync(){
  // if(trashSyncInterval) return; // Already syncing
  if (typeof trashSyncInterval !== "undefined" && trashSyncInterval) {
        clearInterval(trashSyncInterval);
    }
  console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  // Initial load
  loadTrashFromServer();
  // Then refresh every 2 seconds while viewing trash
  trashSyncInterval = setInterval(loadTrashFromServer, 2000);
}

function stopTrashSync(){
  if(trashSyncInterval){
    clearInterval(trashSyncInterval);
    trashSyncInterval = null;
    console.log('â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  }
}

function loadTrashFromServer(){
  // Load all trash data in parallel and wait for all to complete
  const promises = [];
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_faults')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.faults = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_orders')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.orders = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_maintenance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.maintenance = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_attendance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.attendance = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§ØªÙ„ÙˆØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_catalog')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.attendance = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„ÙƒØ§ØªÙ„ÙˆØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§ØªÙ„ÙˆØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );  

  // Ø§Ù†ØªØ¸Ø± ÙƒÙ„ Ø§Ù„Ù€ fetches ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø±Ù†Ø¯Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© - ÙˆØ§Ø±Ø¬Ø¹ Promise
  return Promise.all(promises).then(() => {
    console.log('ğŸ‰ Ø§Ù†ØªÙ‡Øª ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ - Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ù†Ø¯Ø±');
    saveAll();
    renderTrash();
  }).catch(err => {
    console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ loadTrashFromServer:', err);
    renderTrash(); // Ø±Ù†Ø¯Ø± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø£Ø®Ø·Ø§Ø¡
    throw err; // Ù…Ø±Ø± Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ø£Ø¹Ù„Ù‰
  });
}

/* Helper for POSTing to API with safe JSON/text handling */
function apiPost(payload){
  return fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  }).then(async (r)=>{
    const text = await r.text().catch(()=>null);
    let json = null;
    try{ if(text) json = JSON.parse(text); }catch(e){ /* non-json response */ }
    return { ok: r.ok, status: r.status, statusText: r.statusText, json: json, text: text };
  });
}

/* CRUD faults */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ù„Ø£Ø¹Ø·Ø§Ù„ (Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingFaultId = null;
document.getElementById('addBtn').addEventListener('click', onAddOrSave);
document.getElementById('clearBtn').addEventListener('click', clearFaultForm);
function clearFaultForm(){
  editingFaultId = null;
  document.getElementById('machineGroup').value = '';
  populateItemsForGroup('', 'machineItem');
  document.getElementById('customMachinePlace').value = '';
  document.getElementById('customMachineName').value = '';
  setMultiSelectValues('person',''); renderSelectedChips('person','personChips');
  document.getElementById('description').value=''; 
  document.getElementById('solution').value=''; 
  document.getElementById('shift').value='ØµØ¨Ø§Ø­ÙŠØ©'; 
  document.getElementById('date').value=getTodayDate(); 
  document.getElementById('partChanged').value='no';
  document.getElementById('partFieldsContainer').style.display='none';
  document.getElementById('lcode').value=''; 
  document.getElementById('partName').value=''; 
  document.getElementById('partQty').value=0; 
  document.getElementById('status').value='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'; 
  document.getElementById('addBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„';
}

function onAddOrSave(){
  if(editingFaultId) return saveEditFault();
  
  const selML = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„ Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª)
  if(!(getSelectedValues('person').length > 0 || (personChips && personChips.textContent.trim() !== ''))) {
    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„. (Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)');
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  if(selML.line === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„
    const customName = document.getElementById('customMachineName').value.trim();
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
  } else if(selML.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±ÙŠ"ØŒ ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
    const place = document.getElementById('customMachinePlace').value.trim();
    const customName = document.getElementById('customMachineName').value.trim();
    if(!place) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
  } else {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if(!selML.machine) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
  var person = document.getElementById('person');
  var personChips = document.getElementById('personChips');
  var description = document.getElementById('description');
  var solution = document.getElementById('solution');
  var shift = document.getElementById('shift');
  var date = document.getElementById('date');
  var partChanged = document.getElementById('partChanged');
  var lcode = document.getElementById('lcode');
  var partName = document.getElementById('partName');
  var partQty = document.getElementById('partQty');
  var status = document.getElementById('status');
  
  if(!(getSelectedValues('person').length > 0 || (personChips && personChips.textContent.trim() !== ''))){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.'); return; }
  if(!description || description.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„.'); return; }
  if(!solution || solution.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø´Ø±Ø­ Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„.'); return; }
  if(!shift || shift.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©.'); return; }
  if(!date || date.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.'); return; }
  if(!partChanged || partChanged.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±.'); return; }
  if(partChanged && partChanged.value === 'yes'){
    if(!lcode || lcode.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number).'); return; }
    if(!partName || partName.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.'); return; }
    if(!partQty || partQty.value === '' || Number(partQty.value) <= 0){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.'); return; }
  }
  if(!status || status.value.trim()===''){  alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„.'); return; }
  
  // Get the part changed value
  const partChangedVal = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcodeVal = partChangedVal === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partNameVal = partChangedVal === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQtyVal = partChangedVal === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;
  
  const f = {
    id: uid(),
    machine: selML.machine,
    line: selML.line,
    person: getSelectedValues('person').join(', '),
    description: document.getElementById('description').value.trim(),
    solution: document.getElementById('solution').value.trim(),
    shift: document.getElementById('shift').value,
    date: formatDateOnly(document.getElementById('date').value),
    partChanged: partChangedVal,
    lcode: lcodeVal,
    partName: partNameVal,
    partQty: partQtyVal,
    status: document.getElementById('status').value
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'fault', op: 'add', data: f })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ø·Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  faults.unshift(f);
  clearFaultForm(); 
  currentPageFaults = 1;
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¹Ø·Ù„
  notifyAction('fault_added', 'fault', f.machine);
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
  try{ if(typeof enableEditFor === 'function') enableEditFor(f.id, 60*1000); }catch(e){}
  
  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø¹Ø·Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  setTimeout(function() {
    showLatestFaultNotification();
  }, 500);
}

/* edit fault */
function startEditFault(id){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø·Ù„ØŸ')) return;
  const f = faults.find(x=>x.id===id); if(!f) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); editingFaultId = id;
  setGroupSelection('machineGroup','machineItem', f.machine, f.line);
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ù…Ù„Ø£ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(f.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† f.machine
    const parts = f.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMachinePlace').value = parts[0].trim();
      document.getElementById('customMachineName').value = parts[1].trim();
    } else {
      document.getElementById('customMachinePlace').value = '';
      document.getElementById('customMachineName').value = f.machine;
    }
  } else {
    document.getElementById('customMachinePlace').value = '';
    document.getElementById('customMachineName').value = '';
  }
  setMultiSelectValues('person', f.person);
  renderSelectedChips('person','personChips');
  document.getElementById('description').value = f.description;
  document.getElementById('solution').value = f.solution || '';
  document.getElementById('shift').value = f.shift;
  document.getElementById('date').value = f.date;
  // Set part changed based on whether part fields have values
  const hasPartData = f.lcode || f.partName || f.partQty;
  document.getElementById('partChanged').value = hasPartData ? 'yes' : 'no';
  document.getElementById('partFieldsContainer').style.display = hasPartData ? 'block' : 'none';
  document.getElementById('lcode').value = f.lcode;
  document.getElementById('partName').value = f.partName;
  document.getElementById('partQty').value = f.partQty;
  document.getElementById('status').value = f.status;
  document.getElementById('addBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

function saveEditFault(){
  const idx = faults.findIndex(x=>x.id===editingFaultId); if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');

  // Get the part changed value
  const partChanged = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcode = partChanged === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partName = partChanged === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQty = partChanged === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;

  // Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
  const selML2 = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  faults[idx].machine = selML2.machine;
  faults[idx].line = selML2.line;
  faults[idx].person = getSelectedValues('person').join(', ');
  faults[idx].description = document.getElementById('description').value.trim();
  faults[idx].solution = document.getElementById('solution').value.trim();
  faults[idx].shift = document.getElementById('shift').value;
  faults[idx].date = formatDateOnly(document.getElementById('date').value);
  faults[idx].partChanged = partChanged;
  faults[idx].lcode = lcode;
  faults[idx].partName = partName;
  faults[idx].partQty = partQty;
  faults[idx].status = document.getElementById('status').value;

   // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Sheet
  const f = faults[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => console.error('fault update error', err));

  editingFaultId = null;
  clearFaultForm(); 
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø·Ù„
  notifyAction('fault_edited', 'fault', faults[idx].machine);
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function moveToTrashFault(id){
  const f = faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† faults Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    const deletedFault = faults.splice(idx,1)[0];
    trash.faults.unshift(deletedFault);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø¹Ø·Ù„
    notifyAction('fault_deleted', 'fault', deletedFault.machine);
    showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }
}

function restoreFault(id){
  const f = trash.faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ faults Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    faults.unshift(trash.faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
  }
}
// function permanentDeleteFault(id){ const idx = trash.faults.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.faults.splice(idx,1); saveAll(); renderTrash(); }
function permanentDeleteFault(id){
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  stopTrashSync();

  // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  trash.faults.splice(idx,1);
  saveAll(); renderTrash();
  console.log('âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø·Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§:', id);

  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±)
  apiPost({ kind: 'fault', op: 'delete', data: { id } })
    .then(res => {
      console.log('âœ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('âœ“ ØªÙ… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      else console.warn('âš  Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø­Ø°Ù:', res.text || res.statusText);
    })
    .catch(err => console.error('âš  Ø®Ø·Ø£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', err))
    .finally(() => startTrashSync());
}


/* CRUD orders */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingOrderId = null;
document.getElementById('addOrderBtn').addEventListener('click', ()=> {
  if(editingOrderId) return saveEditOrder(); addOrder();});
document.getElementById('clearOrderBtn').addEventListener('click', clearOrderForm);

function addOrder(){
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…/Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
  if(getSelectedValues('orderPerson').length === 0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.'); return; }
  const o = { 
    id: uid(), 
    orderNum: document.getElementById('orderNum').value.trim(), 
    supplyNum: document.getElementById('supplyNum').value.trim(), 
    date: formatDateOnly(document.getElementById('orderDate').value), 
    person: getSelectedValues('orderPerson').join(', '), 
    details: document.getElementById('orderDetails').value.trim() 
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'order', op: 'add', data: o })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  orders.unshift(o); clearOrderForm(); currentPageOrders = 1; renderOrderTable(); renderTrash();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø± Ø´Ø±Ø§Ø¡
  notifyAction('order_added', 'order', o.orderNum || 'Ø¬Ø¯ÙŠØ¯');
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
  try{ if(typeof enableEditFor === 'function') enableEditFor(o.id, 60*1000); }catch(e){}
}
function startEditOrder(id){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ØŸ')) return;
  const o = orders.find(x=>x.id===id); if(!o) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  editingOrderId = id;
  document.getElementById('orderNum').value = o.orderNum;
  document.getElementById('supplyNum').value = o.supplyNum;
  document.getElementById('orderDate').value = o.date;
  // set multi-select values and render chips
  setMultiSelectValues('orderPerson', o.person);
  renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value = o.details;
  document.getElementById('addOrderBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}
// function saveEditOrder(){ const idx=orders.findIndex(x=>x.id===editingOrderId); if(idx===-1) return; orders[idx].orderNum=document.getElementById('orderNum').value.trim(); orders[idx].supplyNum=document.getElementById('supplyNum').value.trim(); orders[idx].date=document.getElementById('orderDate').value; orders[idx].person=document.getElementById('orderPerson').value.trim(); orders[idx].details=document.getElementById('orderDetails').value.trim(); editingOrderId=null; clearOrderForm(); renderOrderTable(); }
function saveEditOrder(){
  const idx = orders.findIndex(x=>x.id===editingOrderId); 
  if(idx===-1) return;

  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…/Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
  if(getSelectedValues('orderPerson').length === 0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.'); return; }

  orders[idx].orderNum = document.getElementById('orderNum').value.trim();
  orders[idx].supplyNum= document.getElementById('supplyNum').value.trim();
  orders[idx].date     = formatDateOnly(document.getElementById('orderDate').value);
  orders[idx].person   = getSelectedValues('orderPerson').join(', ');
  orders[idx].details  = document.getElementById('orderDetails').value.trim();

  const o = orders[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order update error', err));

  editingOrderId=null; 
  clearOrderForm(); 
  renderOrderTable();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡
  notifyAction('order_edited', 'order', orders[idx].orderNum || 'ØªØ¹Ø¯ÙŠÙ„');
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function clearOrderForm(){ 
  document.getElementById('orderNum').value=''; 
  document.getElementById('supplyNum').value=''; 
  document.getElementById('orderDate').value=getTodayDate(); 
  setMultiSelectValues('orderPerson',''); renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value=''; 
  editingOrderId=null; 
  document.getElementById('addOrderBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±'; 
}

function moveToTrashOrder(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† orders Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    const deletedOrder = orders.splice(idx,1)[0];
    trash.orders.unshift(deletedOrder);
    saveAll();
    renderOrderTable();
    renderTrash();
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø£Ù…Ø± Ø´Ø±Ø§Ø¡
    notifyAction('order_deleted', 'order', deletedOrder.orderNum || 'Ø­Ø°Ù');
    showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }
}

function restoreOrder(id){
  const o = trash.orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ orders Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    orders.unshift(trash.orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
  }
}
function permanentDeleteOrder(id){
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  stopTrashSync();

  // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  trash.orders.splice(idx,1);
  saveAll(); renderTrash();
  console.log('âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ù…Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§:', id);

  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  apiPost({ kind: 'order', op: 'delete', data: { id } })
    .then(res => {
      console.log('âœ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('âœ“ ØªÙ… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      else console.warn('âš  Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø­Ø°Ù:', res.text || res.statusText);
    })
    .catch(err => console.error('âš  Ø®Ø·Ø£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', err))
    .finally(() => startTrashSync());
}

// function permanentDeleteOrder(id){ const idx=trash.orders.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.orders.splice(idx,1); saveAll(); renderTrash(); }

/* MAINTENANCE CRUD */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù„Ù„ØµÙŠØ§Ù†Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingMaintenanceId = null;
document.getElementById('addMaintenanceBtn').addEventListener('click', ()=> {
  if(editingMaintenanceId) return saveEditMaintenance(); addMaintenance();});
document.getElementById('clearMaintenanceBtn').addEventListener('click', clearMaintenanceForm);

function addMaintenance(){
  const selMainML = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const mainDateVal = formatDateOnly(document.getElementById('mainDate').value);
  if(selMainML.line === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const customName = document.getElementById('customMainName').value.trim();
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.');
      return; 
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©)
    if(!mainDateVal){
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.');
      return;
    }
  } else if(selMainML.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±ÙŠ"ØŒ ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
    const place = document.getElementById('customMainPlace').value.trim();
    const customName = document.getElementById('customMainName').value.trim();
    if(!place) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.');
      return; 
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø­Ø§Ù„Ø© "Ø£Ø®Ø±ÙŠ"
    if(!mainDateVal){
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.');
      return;
    }
  } else {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ ÙŠØ¬Ø¨:
    // 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    // 2. Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©
    if(!selMainML.machine) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.');
      return; 
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙŠØ¶Ø§Ù‹ (Ø¹Ø§Ù…)
    if(!mainDateVal){
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.');
      return;
    }
  }
  
  const partChanged = document.getElementById('mainPartChanged').value;
  const m = { 
    id: uid(), 
    machine: selMainML.machine, 
    line: selMainML.line, 
    person: getSelectedValues('mainPerson').join(', '), 
    date: formatDateOnly(document.getElementById('mainDate').value), 
    partChanged: partChanged,
    lcode: partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '', 
    partName: partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '', 
    partQty: partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '', 
    type: document.getElementById('mainType').value.trim(), 
    notes: document.getElementById('mainNotes').value.trim() 
  };
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'add', data: m })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    }).catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    });
  
  maintenance.unshift(m); 
  saveAll();
  clearMaintenanceForm(); 
  currentPageMaintenance = 1;
  renderMaintenanceTable(); 
  renderTrash();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©
  notifyAction('maintenance_added', 'maintenance', m.machine);
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
  try{ if(typeof enableEditFor === 'function') enableEditFor(m.id, 60*1000); }catch(e){}
  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
  showLatestMaintenanceNotification();
}

function startEditMaintenance(id){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØ§Ù†Ø©ØŸ')) return;
  const m = maintenance.find(x=>x.id===id); 
  if(!m) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); 
  editingMaintenanceId=id; 
  setGroupSelection('mainGroup','mainItem', m.machine, m.line);
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ù…Ù„Ø£ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(m.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† m.machine
    const parts = m.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMainPlace').value = parts[0].trim();
      document.getElementById('customMainName').value = parts[1].trim();
    } else {
      document.getElementById('customMainPlace').value = '';
      document.getElementById('customMainName').value = m.machine;
    }
  } else {
    document.getElementById('customMainPlace').value = '';
    document.getElementById('customMainName').value = '';
  }
  setMultiSelectValues('mainPerson', m.person);
  renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=m.date; 
  document.getElementById('mainPartChanged').value = m.partChanged || 'no';
  document.getElementById('mainLcode').value=m.lcode || ''; 
  document.getElementById('mainPartName').value=m.partName || ''; 
  document.getElementById('mainPartQty').value=m.partQty || '0'; 
  document.getElementById('mainPartFieldsContainer').style.display = (m.partChanged === 'yes') ? 'block' : 'none';
  document.getElementById('mainType').value=m.type; 
  document.getElementById('mainNotes').value=m.notes; 
  document.getElementById('addMaintenanceBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

function saveEditMaintenance(){
  const idx = maintenance.findIndex(x=>x.id===editingMaintenanceId); 
  if(idx===-1) return;

  const selMainML2 = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  const partChanged = document.getElementById('mainPartChanged').value;
  maintenance[idx].machine  = selMainML2.machine;
  maintenance[idx].line     = selMainML2.line;
  maintenance[idx].person   = getSelectedValues('mainPerson').join(', ');
  maintenance[idx].date     = formatDateOnly(document.getElementById('mainDate').value);
  maintenance[idx].partChanged = partChanged;
  maintenance[idx].lcode    = partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '';
  maintenance[idx].partName = partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '';
  maintenance[idx].partQty  = partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '';
  maintenance[idx].type     = document.getElementById('mainType').value.trim();
  maintenance[idx].notes    = document.getElementById('mainNotes').value.trim();

  // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Sheet
  const m = maintenance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: m })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§ØªØ­ÙØ¸ Local Ø¨Ø³');
    });

  editingMaintenanceId=null; 
  clearMaintenanceForm(); 
  renderMaintenanceTable();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ§Ù†Ø©
  notifyAction('maintenance_edited', 'maintenance', maintenance[idx].machine);
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function clearMaintenanceForm(){ 
  document.getElementById('mainGroup').value = '';
  populateItemsForGroup('', 'mainItem');
  document.getElementById('customMainPlace').value = '';
  document.getElementById('customMainName').value = '';
  setMultiSelectValues('mainPerson',''); renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=getTodayDate(); 
  document.getElementById('mainPartChanged').value='no';
  document.getElementById('mainLcode').value=''; 
  document.getElementById('mainPartName').value=''; 
  document.getElementById('mainPartQty').value='0'; 
  document.getElementById('mainPartFieldsContainer').style.display='none';
  document.getElementById('mainType').value='Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©'; 
  document.getElementById('mainNotes').value=''; 
  editingMaintenanceId=null; 
  document.getElementById('addMaintenanceBtn').innerText='Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©'; 
}

function moveToTrashMaintenance(id){
  const idx = maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // Ø¹Ù„Ù‘Ù… ÙƒÙ€ deleted = true (soft delete)
  maintenance[idx].deleted = true;
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server ÙƒÙ€ update (ÙŠØ®Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø¨Ù€ deleted = true)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: maintenance[idx] })
  }).then(r=>r.json())
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', err));
  
  // Ø§Ø³Ø­Ø¨ Ù…Ù† maintenance ÙˆØ­Ø·Ù‡Ø§ ÙÙŠ trash
  const movedItem = maintenance.splice(idx,1)[0];
  trash.maintenance.unshift(movedItem);
  
  saveAll();
  renderMaintenanceTable();
  renderTrash();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù ØµÙŠØ§Ù†Ø©
  notifyAction('maintenance_deleted', 'maintenance', movedItem.machine);
  showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

function restoreMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // Ø§Ø³Ø­Ø¨ Ù…Ù† trash ÙˆØ¹Ù„Ù‘Ù… deleted = false
  const restoredItem = trash.maintenance.splice(idx,1)[0];
  restoredItem.deleted = false;
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server ÙƒÙ€ update (ÙŠØ®Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø¨Ù€ deleted = false)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: restoredItem })
  }).then(r=>r.json())
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹:', err));
  
  maintenance.unshift(restoredItem);
  saveAll();
  renderMaintenanceTable();
  renderTrash();
}

function permanentDeleteMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  stopTrashSync();

  // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  trash.maintenance.splice(idx,1);
  saveAll(); renderTrash();
  console.log('âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§:', id);

  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  apiPost({ kind: 'maintenance', op: 'delete', data: { id } })
    .then(res => {
      console.log('âœ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('âœ“ ØªÙ… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      else console.warn('âš  Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø­Ø°Ù:', res.text || res.statusText);
    })
    .catch(err => console.error('âš  Ø®Ø·Ø£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', err))
    .finally(() => startTrashSync());
}

/* MAINTENANCE FILTERS */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. ØªØµÙÙŠØ© ÙˆÙÙ„ØªØ±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('applyMaintenanceFilterBtn').addEventListener('click', applyMaintenanceFilters);
function applyMaintenanceFilters(){ 
  const q=(document.getElementById('searchMaintenance').value||'').toLowerCase();
  const filterType = (document.getElementById('filterMaintenanceType')?.value||'').trim();
  const dateFrom = document.getElementById('dateFromMaintenance')?.value;
  const dateTo = document.getElementById('dateToMaintenance')?.value;

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
  const cardsContainer = document.getElementById('maintenanceCards');
  if(cardsContainer) cardsContainer.style.display = '';

  // Ø­Ø¯Ù‘Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const active = Boolean(q || filterType || dateFrom || dateTo);
  isFilteredMaintenance = active;
  currentPageMaintenance = 1;
  document.getElementById('maintenancePagination').style.display = isFilteredMaintenance ? 'none' : '';

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (filtered vs normal)
  renderMaintenanceTable();
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterMaintenanceBtn')?.addEventListener('click', applyMaintenanceFilters);
document.getElementById('searchMaintenance')?.addEventListener('input', applyMaintenanceFilters);

/* MAINTENANCE EXPORTS */
document.getElementById('exportMaintenanceCsv').addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','machine','line','person','date','lcode','partName','partQty','type','notes'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      date: cells[4].textContent,
      lcode: cells[5].textContent,
      partName: cells[6].textContent,
      partQty: cells[7].textContent,
      type: cells[8].textContent,
      notes: cells[9].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `maintenance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportMaintenanceDoc').addEventListener('click', ()=>{
  if(!maintenance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©';
  const headers = ['#','Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©','Ø§Ù„Ø®Ø·','Ø§Ù„Ù‚Ø§Ø¦Ù…','Ø§Ù„ØªØ§Ø±ÙŠØ®','L Number','Ø§Ù„Ù‚Ø·Ø¹Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredMaintenance){
    const allMaintenance = maintenance.filter(m => !m.deleted);
    if(!allMaintenance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    allMaintenance.forEach((m,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(m.machine||'')}</td><td>${escapeHtml(m.line||'')}</td><td>${escapeHtml(m.person||'')}</td><td>${escapeHtml(m.date||'')}</td><td>${escapeHtml(m.lcode||'')}</td><td>${escapeHtml(m.partName||'')}</td><td>${escapeHtml(m.partQty||'')}</td><td>${escapeHtml(m.type||'')}</td><td>${escapeHtml(m.notes||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `maintenance_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td><td>${escapeHtml(cells[5]?.textContent||'')}</td><td>${escapeHtml(cells[6]?.textContent||'')}</td><td>${escapeHtml(cells[7]?.textContent||'')}</td><td>${escapeHtml(cells[8]?.textContent||'')}</td><td>${escapeHtml(cells[9]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `maintenance_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print Current Page - Maintenance */
document.getElementById('printMaintenanceCurrentPage')?.addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedRows = visibleRows.slice().sort((a, b) => {
    const dateA = new Date(a.querySelectorAll('td')[4]?.textContent?.trim() || '').getTime();
    const dateB = new Date(b.querySelectorAll('td')[4]?.textContent?.trim() || '').getTime();
    return dateA - dateB;
  });

  // Ù…Ù„Ø®Øµ Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const totalMaint = sortedRows.length;
  const uniqueMachines = Array.from(new Set(sortedRows.map(tr=>tr.querySelectorAll('td')[1]?.textContent?.trim()).filter(Boolean)));
  let summaryHtml = '';
  if(totalMaint){
    summaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª: <span style="color:#00796b">${totalMaint}</span> | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
  }

  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += summaryHtml;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
  sortedRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Maintenance (print plain full table, no grouped summary) */
document.getElementById('printMaintenanceBtn').removeEventListener('click', null);
document.getElementById('printMaintenanceBtn').addEventListener('click', ()=>{
  if(!maintenance || !maintenance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
  const allMaintenance = maintenance.filter(m => !m.deleted);
  if(!allMaintenance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedMaintenance = allMaintenance.slice().sort((a, b) => {
    const dateA = new Date(a.date || '').getTime();
    const dateB = new Date(b.date || '').getTime();
    return dateA - dateB;
  });

  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  // Ø§Ø­Ø³Ø¨ Ù…Ù„Ø®Øµ Ø¨Ø³ÙŠØ· (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª ÙˆØ£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©)
  const uniqueMachines = Array.from(new Set(sortedMaintenance.map(m => (m.machine||'').trim()).filter(Boolean)));
  const weeklyCount = sortedMaintenance.filter(m => m.type === 'Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©').length;
  const monthlyCount = sortedMaintenance.filter(m => m.type === 'Ø´Ù‡Ø±ÙŠØ©').length;
  const quarterCount = sortedMaintenance.filter(m => m.type === 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ').length;
  const yearlyCount = sortedMaintenance.filter(m => m.type === 'Ø³Ù†ÙˆÙŠØ©').length;
  html += `<div style="text-align:center;margin:8px 0 14px 0;font-weight:700">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª: <span style="color:#00796b">${uniqueMachines.length}</span> | Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <span style="color:#00796b">${weeklyCount}</span> | Ø´Ù‡Ø±ÙŠØ©: <span style="color:#00796b">${monthlyCount}</span> | Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ: <span style="color:#00796b">${quarterCount}</span> | Ø³Ù†ÙˆÙŠØ©: <span style="color:#00796b">${yearlyCount}</span></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
  sortedMaintenance.forEach((m, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(m.machine)}</td><td>${escapeHtml(m.line)}</td><td>${escapeHtml(m.person)}</td><td>${escapeHtml(m.date)}</td><td>${escapeHtml(m.lcode)}</td><td>${escapeHtml(m.partName)}</td><td>${escapeHtml(m.partQty)}</td><td>${escapeHtml(m.type)}</td><td>${escapeHtml(m.notes||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),300);
});

            document.getElementById('emptyTrashBtn').addEventListener('click', () => {
  confirmPasswordAndRun('emptyTrashAll');
});

function emptyTrashAll(){
  // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ù€ IDs Ø§Ù„Ù„ÙŠ Ù‡ØªØªÙ…Ø³Ø­ Ù…Ù† Ø§Ù„Ø´ÙŠØª
  const faultIds = (trash.faults || []).map(f => f.id);
  const orderIds = (trash.orders || []).map(o => o.id);
  const maintenanceIds = (trash.maintenance || []).map(m => m.id);
  const attendanceIds = (trash.attendance || []).map(a => a.id);
  
  const totalItems = faultIds.length + orderIds.length + maintenanceIds.length + attendanceIds.length;
  console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ - Ø§Ù„Ø£Ø¹Ø·Ø§Ù„:', faultIds.length, 'Ø§Ù„Ø£ÙˆØ§Ù…Ø±:', orderIds.length, 'Ø§Ù„ØµÙŠØ§Ù†Ø§Øª:', maintenanceIds.length, 'Ø§Ù„Ø­Ø¶ÙˆØ±:', attendanceIds.length, 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', totalItems);

  if (totalItems === 0) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ø­Ø°Ù');
    return;
  }

  // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  trash = { faults: [], orders: [], maintenance: [], attendance: [] };
  saveAll(); renderTrash();
  console.log('âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ ' + totalItems + ' Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§');
  alert('ØªÙ… Ø­Ø°Ù ' + totalItems + ' Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§!');

  // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±)
  const allIds = [];
  faultIds.forEach(id=> allIds.push({ kind: 'fault', id }));
  orderIds.forEach(id=> allIds.push({ kind: 'order', id }));
  maintenanceIds.forEach(id=> allIds.push({ kind: 'maintenance', id }));
  attendanceIds.forEach(id=> allIds.push({ kind: 'attendance', id }));

  allIds.forEach(x => {
    apiPost({ kind: x.kind, op: 'delete', data: { id: x.id } })
      .then(res => console.log('âœ“ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', x.kind, x.id, res))
      .catch(err => console.warn('âš  Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ±ÙØ±:', x.kind, x.id, err));
  });

  // Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
  setTimeout(() => {
    loadTrashFromServer().catch(e => console.log('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', e));
  }, 2000);
}

/* ATTENDANCE: CRUD, render, exports */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. Ø¹Ù…Ù„ÙŠØ§Øª CRUD ÙˆØªØµØ¯ÙŠØ± Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingAttendanceId = null;

// Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
const arabicDayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function calculateVacationDays(startDateStr, numDays) {
  const startDate = new Date(startDateStr);
  const dayNames = [];
  
  for (let i = 0; i < numDays; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    const dayIndex = currentDate.getDay();
    dayNames.push(arabicDayNames[dayIndex]);
  }
  
  return dayNames.join(', ');
}

document.getElementById('addAttendanceBtn').addEventListener('click', ()=>{ if(editingAttendanceId) return saveEditAttendance(); addAttendance(); });
document.getElementById('clearAttendanceBtn').addEventListener('click', clearAttendanceForm);

function clearAttendanceForm(){
  editingAttendanceId = null;
  document.getElementById('workerName').value=''; 
  document.getElementById('workerNum').value=''; 
  document.getElementById('absenceDate').value=getTodayDate(); 
  document.getElementById('daysCount').value=1;
  document.getElementById('vacationType').value='';
  document.getElementById('addAttendanceBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„';
}

function addAttendance(){
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  const vacationType = document.getElementById('vacationType').value.trim();
  
  if (!startDate) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©');
    return;
  }
  
  if (!vacationType) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©');
    return;
  }
  
  // Ø§Ø­Ø³Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  const a = { 
    id: uid(), 
    workerName: document.getElementById('workerName').value.trim(), 
    workerNum: document.getElementById('workerNum').value.trim(), 
    absenceDate: startDate, 
    daysCount: daysCount, 
    absenceDay: daysName,  // Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    vacationType: vacationType
  };
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'add', data: a })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    }).catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    });
  
  attendance.unshift(a);
  // Unlock attendance for this session and mark that only the newly added record should be visible
  try{ sessionStorage.setItem('attendanceUnlocked','true'); sessionStorage.setItem('attendanceVisibleOnlyId', a.id); }catch(e){}
  clearAttendanceForm(); currentPageAttendance = 1; renderAttendanceTable(); show('attendance');
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø£Ø¬Ø§Ø²Ø©
  notifyAction('attendance_added', 'attendance', a.workerName);
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
  try{ if(typeof enableEditFor === 'function') enableEditFor(a.id, 60*1000); }catch(e){}
}

function startEditAttendance(id){ 
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¬Ø§Ø²Ø©ØŸ')) return;
  const a = attendance.find(x=>x.id===id); 
  if(!a) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); 
  editingAttendanceId = id; 
  document.getElementById('workerName').value=a.workerName; 
  // trigger the change event to auto-fill the worker number
  document.getElementById('workerName').dispatchEvent(new Event('change'));
  document.getElementById('absenceDate').value=a.absenceDate; 
  document.getElementById('daysCount').value=a.daysCount;
  document.getElementById('vacationType').value=a.vacationType || '';
  document.getElementById('addAttendanceBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; 
}

function saveEditAttendance(){ 
  const idx = attendance.findIndex(x=>x.id===editingAttendanceId); 
  if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  const vacationType = document.getElementById('vacationType').value.trim();
  
  if (!vacationType) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©');
    return;
  }
  
  // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  attendance[idx].workerName = document.getElementById('workerName').value.trim(); 
  attendance[idx].workerNum = document.getElementById('workerNum').value.trim(); 
  attendance[idx].absenceDate = startDate; 
  attendance[idx].daysCount = daysCount;
  attendance[idx].absenceDay = daysName;
  attendance[idx].vacationType = vacationType;
  
  // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Server
  const a = attendance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: a })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance update error', err));
  
  editingAttendanceId = null; 
  clearAttendanceForm(); 
  renderAttendanceTable(); 
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¬Ø§Ø²Ø©
  notifyAction('attendance_edited', 'attendance', attendance[idx].workerName);
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function deleteAttendance(id){
  const idx = attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance move to trash error', err));
  
  // move to trash.attendance
  const movedItem = attendance.splice(idx,1)[0];
  if(!trash.attendance) trash.attendance = [];
  trash.attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø£Ø¬Ø§Ø²Ø©
  notifyAction('attendance_deleted', 'attendance', movedItem.workerName);
}

function restoreAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = trash.attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance restore error', err));
  
  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ attendance Ù…Ø­Ù„ÙŠÙ‹Ø§
  const movedItem = trash.attendance.splice(idx,1)[0];
  attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function permanentDeleteAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  stopTrashSync();

  // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  trash.attendance.splice(idx,1);
  saveAll(); renderTrash();
  console.log('âœ“ ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ø­Ù„ÙŠÙ‹Ø§:', id);

  // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  apiPost({ kind: 'attendance', op: 'delete', data: { id } })
    .then(res => {
      console.log('âœ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('âœ“ ØªÙ… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      else console.warn('âš  Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø­Ø°Ù:', res.text || res.statusText);
    })
    .catch(err => console.error('âš  Ø®Ø·Ø£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', err))
    .finally(() => startTrashSync());
}

function renderAttendanceTable(){ 
  const tbody = document.querySelector('#attendanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('attendanceCards'); 
  cardsDiv.innerHTML=''; 
  const attendanceUnlocked = (sessionStorage.getItem('attendanceUnlocked') === 'true');
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª/Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ù‚ÙÙ„Ø©ØŒ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
  if(!attendanceUnlocked){
    try{ document.getElementById('attendancePagination').style.display = 'none'; }catch(e){}
    // leave table and cards empty while locked
    saveAll();
    return;
  }
  // Ø§Ù‚Ø±Ø£ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const searchBy = 'name';
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;

  let dataToRender = [];
  let totalPages = 1;
  const visibleOnlyId = sessionStorage.getItem('attendanceVisibleOnlyId');
  if(visibleOnlyId){
    const found = attendance.find(x=>x.id === visibleOnlyId && !x.deleted);
    if(found){ dataToRender = [found]; totalPages = 1; }
    else {
      // If the requested visible-only record isn't loaded yet, do not fall back
      // to showing all records (this prevents unlocking from exposing all cards
      // before data arrives). Hide pagination and return early.
      try{ document.getElementById('attendancePagination').style.display = 'none'; }catch(e){}
      saveAll();
      return;
    }
  }
  
  if(isFilteredAttendance){
    if(!visibleOnlyId){
      dataToRender = attendance.filter(a => {
      if(a.deleted) return false;
      const name = (a.workerName || a.personName || a.empName || a.emp || '').toString();
      const num = (a.workerNum || a.personId || '').toString();
      const text = `${name} ${num} ${a.absenceDate||a.date||''} ${a.notes||''}`.toLowerCase();
      const rowDate = (a.absenceDate || a.date || '').toString();
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      // respect searchBy: 'name'|'num'|'all'
      let match = true;
      if(q){
        if(searchBy === 'name') match = name.toLowerCase().includes(q);
        else if(searchBy === 'num') match = num.toLowerCase().includes(q);
        else match = text.includes(q);
      }
      return match && dateMatch;
    });
    totalPages = 1;
    }
  } else {
    if(!visibleOnlyId){
      const paginationData = paginate(attendance, currentPageAttendance);
      dataToRender = paginationData.items;
      totalPages = paginationData.totalPages;
    }
  }

  dataToRender.forEach((a, pageIndex)=>{
    const globalIndex = isFilteredAttendance ? pageIndex + 1 : (currentPageAttendance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    const tr=document.createElement('tr'); 
    const name = escapeHtml(a.workerName || a.personName || a.empName || a.emp || '');
    const num = escapeHtml(a.workerNum || a.personId || '');
    const date = escapeHtml(a.absenceDate || a.date || '');
    const days = escapeHtml(a.daysCount || a.days || '');
    const dayName = escapeHtml(a.absenceDay || a.dayType || '');
    const vacationType = escapeHtml(a.vacationType || '');
    tr.innerHTML = `<td>${globalIndex}</td><td>${name}</td><td>${num}</td><td>${date}</td><td>${days}</td><td>${dayName}</td><td>${vacationType}</td><td class="no-print actions"><button class="btn ghost" onclick="confirmEditAndRun('startEditAttendance','${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="confirmPasswordAndRun('deleteAttendance','${a.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr);

    const card = document.createElement('div');
    card.className = 'order-card';
    // Minimal attendance card for mobile: show same columns as desktop table
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø¥Ø¬Ø§Ø²Ø© #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:</div><div class="order-card-value">${displayValue(name)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:</div><div class="order-card-value">${displayValue(num)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…:</div><div class="order-card-value">${displayValue(days)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(dayName)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©:</div><div class="order-card-value">${displayValue(vacationType)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="confirmEditAndRun('startEditAttendance','${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="confirmPasswordAndRun('deleteAttendance','${a.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    if(attendanceUnlocked){
      cardsDiv.appendChild(card);
    }
  }); 

  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination - Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ„ØªØ±Ø©
  if(!isFilteredAttendance) {
    updatePaginationButtons('#attendancePagination', totalPages, currentPageAttendance, (pageNum) => {
      currentPageAttendance = pageNum;
      renderAttendanceTable();
    });
  }

  saveAll(); 
}

// Show order details in modal
function showOrderDetails(id){
  const modal = document.getElementById('orderDetailsModal');
  const content = document.getElementById('orderDetailsContent');
  const editBtn = document.getElementById('orderDetailsEdit');
  if(!modal || !content) return;
  const o = orders.find(x=>x.id===id);
  if(!o) { alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  // display full fields (including any time part in date)
  const html = `
    <div style="text-align:left;direction:rtl">
      <p><strong>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${escapeHtml(o.orderNum||'-')}</p>
      <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ±ÙŠØ¯:</strong> ${escapeHtml(o.supplyNum||'-')}</p>
      <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® / Ø§Ù„ÙˆÙ‚Øª:</strong> ${escapeHtml(o.date||'-')}</p>
      <p><strong>Ø§Ù„Ù‚Ø§Ø¦Ù…:</strong> ${escapeHtml(o.person||'-')}</p>
      <p><strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù…Ø±:</strong><br>${escapeHtml(o.details||'-')}</p>
      <p><strong>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø³Ø¬Ù„:</strong> ${escapeHtml(o.id||'-')}</p>
    </div>`;
  content.innerHTML = html;
  modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
  // wire edit button to open the edit form for this order
  if(editBtn){ editBtn.onclick = function(){ closeOrderDetailsModal(); startEditOrder(id); }; }
  document.getElementById('orderDetailsClose')?.addEventListener('click', closeOrderDetailsModal);
}

function closeOrderDetailsModal(){ const modal = document.getElementById('orderDetailsModal'); if(!modal) return; modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }

/* Attendance password modal and controls */
const ATTENDANCE_PASSWORD = 'CBE_ELEC@2026'; // <-- ØºÙŠÙ‘Ø± Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

function showAttendancePasswordModal(){
  const modal = document.getElementById('attendancePasswordModal');
  const input = document.getElementById('attendancePasswordInput');
  if(!modal) return;
  modal.classList.add('active');
  modal.setAttribute('aria-hidden','false');
  input.value = '';
  setTimeout(()=>input.focus(),50);
}

function closeAttendancePasswordModal(){
  const modal = document.getElementById('attendancePasswordModal');
  if(!modal) return;
  modal.classList.remove('active');
  modal.setAttribute('aria-hidden','true');
}

function unlockAttendanceCards(){
  sessionStorage.setItem('attendanceUnlocked','true');
  // Re-render to show cards
  renderAttendanceTable();
  closeAttendancePasswordModal();
}

function checkAttendancePassword(){
  const val = document.getElementById('attendancePasswordInput').value || '';
  if(val === ATTENDANCE_PASSWORD){ unlockAttendanceCards(); }
  else { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'); }
}

document.getElementById('attendancePasswordSubmit')?.addEventListener('click', checkAttendancePassword);
document.getElementById('attendancePasswordCancel')?.addEventListener('click', closeAttendancePasswordModal);
document.getElementById('attendancePasswordInput')?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') checkAttendancePassword(); if(e.key==='Escape') closeAttendancePasswordModal(); });

// Add a small placeholder button to allow opening modal when locked
function ensureAttendanceLockedPlaceholder(){
  const cardsDiv = document.getElementById('attendanceCards');
  if(!cardsDiv) return;
  // remove existing placeholder if any
  const existing = document.getElementById('attendanceCardsLockedPlaceholder');
  if(existing) existing.remove();
  const unlocked = (sessionStorage.getItem('attendanceUnlocked') === 'true');
  if(!unlocked){
    const ph = document.createElement('div');
    ph.id = 'attendanceCardsLockedPlaceholder';
    ph.className = 'box';
    ph.style.textAlign = 'center';
    ph.style.padding = '12px';
    ph.style.marginTop = '8px';
    ph.innerHTML = `<div style="margin-bottom:8px;font-weight:600">Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù‚ÙÙ„</div><button class="btn" id="openAttendancePasswordBtn">ÙØªØ­ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</button>`;
    cardsDiv.parentNode.insertBefore(ph, cardsDiv.nextSibling);
    document.getElementById('openAttendancePasswordBtn')?.addEventListener('click', showAttendancePasswordModal);
    // hide the cards container itself so it won't appear via CSS rules
    cardsDiv.style.display = 'none';
    // also hide the table view and disable related controls to prevent desktop exposure
    const tableView = document.querySelector('#attendanceTable')?.closest('.table-view');
    if(tableView) tableView.style.display = 'none';
    const idsToHide = ['exportAttendanceCsv','exportAttendanceDoc','applyAttendanceFilterBtn','applyDateFilterAttendanceBtn','printAttendanceCurrentPage','printAttendanceBtn','attendancePagination','searchAttendance','attendanceSummary'];
    idsToHide.forEach(id=>{ const el = document.getElementById(id); if(el) el.style.display = 'none'; });
  } else {
    cardsDiv.style.display = '';
    const tableView = document.querySelector('#attendanceTable')?.closest('.table-view');
    if(tableView) tableView.style.display = '';
    const idsToShow = ['exportAttendanceCsv','exportAttendanceDoc','applyAttendanceFilterBtn','applyDateFilterAttendanceBtn','printAttendanceCurrentPage','printAttendanceBtn','attendancePagination','searchAttendance','attendanceSummary'];
    idsToShow.forEach(id=>{ const el = document.getElementById(id); if(el) el.style.display = ''; });
  }
}

// call placeholder updater after render
const _origRenderAttendanceTable = renderAttendanceTable;
renderAttendanceTable = function(){ _origRenderAttendanceTable(); ensureAttendanceLockedPlaceholder(); }

function populateAttendanceSearchNames(){
  try{
    const namesSet = new Set();
    // from workerName select
    const workerSel = document.getElementById('workerName');
    if(workerSel){ Array.from(workerSel.options).forEach(o=>{ const v=(o.value||'').trim(); if(v) namesSet.add(v); }); }
    // from attendance records
    (attendance||[]).forEach(a=>{ if(a && a.workerName) namesSet.add(a.workerName); });

    const names = Array.from(namesSet).sort((a,b)=> a.localeCompare(b,'ar'));

    // If searchAttendance is a select, populate it
    const searchEl = document.getElementById('searchAttendance');
    if(searchEl && searchEl.tagName === 'SELECT'){
      const first = document.createElement('option'); first.value = ''; first.textContent = 'Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„';
      searchEl.innerHTML = '';
      searchEl.appendChild(first);
      names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; searchEl.appendChild(opt); });
      return;
    }

    // Otherwise, try to populate a datalist if present
    const dl = document.getElementById('attendanceNamesList');
    if(dl){ dl.innerHTML = ''; names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); }); }
  }catch(e){ console.error('populateAttendanceSearchNames error', e); }
}

/* Attendance filters & exports */
document.getElementById('applyAttendanceFilterBtn').addEventListener('click', applyAttendanceFilters);
function applyAttendanceFilters(){ 
  const q=(document.getElementById('searchAttendance').value||'').toLowerCase();
  const searchBy = 'name';
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;

  // Ensure card-view is visible on mobile
  // Update locked placeholder / visibility
  ensureAttendanceLockedPlaceholder();

  // Set filtered state based on inputs
  const active = Boolean(q || dateFrom || dateTo);
  isFilteredAttendance = active;
  currentPageAttendance = 1;
  document.getElementById('attendancePagination').style.display = isFilteredAttendance ? 'none' : '';

  // If user filtered by a name (text in search), compute total vacations and days for matching worker(s)
  try{
    const summaryEl = document.getElementById('attendanceSummary');
    if(summaryEl){
      const qTrim = (q||'').trim();
      if(qTrim){
        const matched = (attendance||[]).filter(a => {
          if(a.deleted) return false;
          const name = (a.workerName||'').toLowerCase();
          const num = (a.workerNum||'').toLowerCase();
          if(searchBy === 'name') return name.includes(qTrim);
          if(searchBy === 'num') return num.includes(qTrim);
          return name.includes(qTrim) || num.includes(qTrim);
        });
        const total = matched.length;
        const totalDays = matched.reduce((sum, a) => sum + (parseInt(a.daysCount) || parseInt(a.days) || 0), 0);
        const uniqNames = Array.from(new Set(matched.map(m=>m.workerName).filter(Boolean)));
        const displayName = uniqNames.length===1 ? uniqNames[0] : qTrim;
        summaryEl.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù„Ù€ ${displayName}: ${total} Ø³Ø¬Ù„ â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…: ${totalDays} ÙŠÙˆÙ…`;
        summaryEl.style.display = total? 'block' : 'none';
      } else {
        summaryEl.innerText = '';
        summaryEl.style.display = 'none';
      }
    }
  }catch(e){ console.error('attendance summary error', e); }

  // Re-render table (renderAttendanceTable will use the filter inputs when isFilteredAttendance=true)
  renderAttendanceTable();
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterAttendanceBtn')?.addEventListener('click', applyAttendanceFilters);
// apply filter immediately when a name is selected from the select
document.getElementById('searchAttendance')?.addEventListener('input', applyAttendanceFilters);

document.getElementById('exportAttendanceCsv').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ± Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;
  let filtered = attendance.filter(a => {
    if(a.deleted) return false;
    const name = (a.workerName || '').toLowerCase();
    const rowDate = (a.absenceDate || a.date || '').toString();
    let dateMatch = true;
    if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
    else if(dateFrom) dateMatch = (rowDate >= dateFrom);
    else if(dateTo) dateMatch = (rowDate <= dateTo);
    return (!q || name.includes(q)) && dateMatch;
  });
  if(!filtered.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','workerName','workerNum','absenceDate','daysCount','absenceDay','vacationType'];
  const rows = [];
  filtered.forEach((a, i) => {
    rows.push({
      '#': i+1,
      workerName: a.workerName || '',
      workerNum: a.workerNum || '',
      absenceDate: a.absenceDate || a.date || '',
      daysCount: a.daysCount || a.days || '',
      absenceDay: a.absenceDay || a.dayType || '',
      vacationType: a.vacationType || ''
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `attendance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportAttendanceDoc').addEventListener('click', ()=>{
  if(!attendance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨';
  const headers = ['#','Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„','Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„','ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨','Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…','ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨','Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}.summary{background:#f0f0f0;padding:10px;margin:15px 0;border-radius:4px;font-weight:bold}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredAttendance){
    const allAttendance = attendance.filter(a => !a.deleted);
    if(!allAttendance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    allAttendance.forEach((a,i)=> {
      html += `<tr><td>${i+1}</td><td>${escapeHtml(a.workerName || '')}</td><td>${escapeHtml(a.workerNum || '')}</td><td>${escapeHtml(a.absenceDate || a.date || '')}</td><td>${escapeHtml(a.daysCount || a.days || '')}</td><td>${escapeHtml(a.absenceDay || a.dayType || '')}</td><td>${escapeHtml(a.vacationType || '')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `attendance_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td><td>${escapeHtml(cells[5]?.textContent||'')}</td><td>${escapeHtml(cells[6]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `attendance_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print Current Page - Attendance */
document.getElementById('printAttendanceCurrentPage')?.addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ± Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;
  let filtered = attendance.filter(a => {
    if(a.deleted) return false;
    const name = (a.workerName || '').toLowerCase();
    const rowDate = (a.absenceDate || a.date || '').toString();
    let dateMatch = true;
    if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
    else if(dateFrom) dateMatch = (rowDate >= dateFrom);
    else if(dateTo) dateMatch = (rowDate <= dateTo);
    return (!q || name.includes(q)) && dateMatch;
  });
  if(!filtered.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  filtered = filtered.slice().sort((a, b) => {
    const dateA = new Date(a.absenceDate || a.date || '').getTime();
    const dateB = new Date(b.absenceDate || b.date || '').getTime();
    return dateA - dateB;
  });
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨'; 
  const totalDays = filtered.reduce((sum, a) => sum + (parseInt(a.daysCount) || parseInt(a.days) || 0), 0);
  const uniqNames = Array.from(new Set(filtered.map(m=>m.workerName).filter(Boolean)));
  const workerName = uniqNames.length===1 ? uniqNames[0] : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}.summary{background:#f0f0f0;padding:10px;margin:15px 0;border-radius:4px;font-weight:bold}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<div class="summary">Ø§Ù„Ù…ÙˆØ¸Ù: ${escapeHtml(workerName)} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„ØªØºÙŠØ¨: ${totalDays} ÙŠÙˆÙ…</div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</th></tr></thead><tbody>`;
  filtered.forEach((a, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(a.workerName || '')}</td><td>${escapeHtml(a.workerNum || '')}</td><td>${escapeHtml(a.absenceDate || a.date || '')}</td><td>${escapeHtml(a.daysCount || a.days || '')}</td><td>${escapeHtml(a.absenceDay || a.dayType || '')}</td><td>${escapeHtml(a.vacationType || '')}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Attendance (all data regardless of pagination) */
document.getElementById('printAttendanceBtn').removeEventListener('click', null);
document.getElementById('printAttendanceBtn').addEventListener('click', ()=>{
  if(!attendance || !attendance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ø§Ù„ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
  const allAttendance = attendance.filter(a => !a.deleted);
  if(!allAttendance.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedAttendance = allAttendance.slice().sort((a, b) => {
    const dateA = new Date(a.absenceDate || a.date || '').getTime();
    const dateB = new Date(b.absenceDate || b.date || '').getTime();
    return dateA - dateB;
  });
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</th></tr></thead><tbody>`;
  sortedAttendance.forEach((a, i)=> {
    const name = escapeHtml(a.workerName || a.personName || '');
    const num = escapeHtml(a.workerNum || a.personId || '');
    const date = escapeHtml(a.absenceDate || a.date || '');
    const days = escapeHtml(a.daysCount || a.days || '');
    const dayName = escapeHtml(a.absenceDay || a.dayType || '');
    const vacationType = escapeHtml(a.vacationType || '');
    html += `<tr><td>${i+1}</td><td>${name}</td><td>${num}</td><td>${date}</td><td>${days}</td><td>${dayName}</td><td>${vacationType}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* filters */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© Ù„Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', ()=>{ 
  document.getElementById('search').value=''; 
  document.getElementById('filterStatus').value=''; 
  document.getElementById('dateFromFault').value=''; 
  document.getElementById('dateToFault').value=''; 
  applyFilters(); 
});

function applyFilters(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const st = (document.getElementById('filterStatus').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault').value;
  const dateTo = document.getElementById('dateToFault').value;

  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('faultCards');
  if(cardsContainer) cardsContainer.style.display = '';

  // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¸Ù‡ÙˆØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØµÙØ­Ø©

  // Set filtered flag and re-render via data arrays (render will handle correct date logic)
  const active = Boolean(q || st || dateFrom || dateTo);
  isFilteredFaults = active;
  currentPageFaults = 1;
  document.getElementById('faultsPagination').style.display = isFilteredFaults ? 'none' : '';
  renderFaultTable();
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterFaultBtn')?.addEventListener('click', applyFilters);

/* order filter */
document.getElementById('applyOrderFilterBtn').addEventListener('click', applyOrderFilters);
function applyOrderFilters(){ 
  const q=(document.getElementById('searchOrder').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder').value;
  const dateTo = document.getElementById('dateToOrder').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('orderCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Set filtered flag and re-render via data arrays (render will handle correct date logic)
  const active = Boolean(q || dateFrom || dateTo);
  isFilteredOrders = active;
  currentPageOrders = 1;
  document.getElementById('ordersPagination').style.display = isFilteredOrders ? 'none' : '';
  renderOrderTable();
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterOrderBtn')?.addEventListener('click', applyOrderFilters);

/* exports: CSV and Word (table) and print */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 14. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© (CSV, Word, PDF)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function arrayToCsv(headers, rows){
  const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
  const lines = [headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(',')));
  return lines.join('\r\n');
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* Faults exports (filtered only) */
document.getElementById('exportCsvAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers = ['#','machine','line','person','description','solution','shift','date','lcode','partName','partQty','status'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      description: cells[4].textContent,
      solution: cells[5].textContent,
      shift: cells[6].textContent,
      date: cells[7].textContent,
      lcode: cells[8].textContent,
      partName: cells[9].textContent,
      partQty: cells[10].textContent,
      status: cells[11].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `faults_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

/* Word export as table (filtered faults only) */
document.getElementById('exportDocAll').addEventListener('click', ()=> {
  // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠØ´ ÙÙ„ØªØ± Ù…ÙØ¹Ù„ Ù†ØµØ¯Ø± ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©)ØŒ ÙˆØ¥Ù„Ø§ Ù†ØµØ¯Ø± Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙ‚Ø·
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  const headers = ['#','Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©','Ø§Ù„Ø®Ø·','Ø§Ù„Ù‚Ø§Ø¦Ù…','Ø§Ù„ÙˆØµÙ','Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„','Ø§Ù„ÙˆØ±Ø¯ÙŠØ©','Ø§Ù„ØªØ§Ø±ÙŠØ®','L Number','Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø­Ø§Ù„Ø©'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredFaults){
    // ØµØ¯Ù‘Ø± ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
    const allFaults = faults.filter(f => !f.deleted);
    if(!allFaults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    allFaults.forEach((f,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(f.machine||'')}</td><td>${escapeHtml(f.line||'')}</td><td>${escapeHtml(f.person||'')}</td><td>${escapeHtml(f.description||'')}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift||'')}</td><td>${escapeHtml(f.date||'')}</td><td>${escapeHtml(f.lcode||'')}</td><td>${escapeHtml(f.partName||'')}</td><td>${escapeHtml(f.partQty||'')}</td><td>${escapeHtml(f.status||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `faults_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  // Ø¨Ø®Ù„Ø§Ù Ø°Ù„ÙƒØŒ ØµØ¯Ù‘Ø± Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©)
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    html += `<tr>` +
            `<td>${i+1}</td>` +
            `<td>${escapeHtml(cells[1]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[2]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[3]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[4]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[5]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[6]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[7]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[8]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[9]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[10]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[11]?.textContent||'')}</td>` +
            `</tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `faults_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Orders exports (filtered only) */
document.getElementById('exportOrdersCsv').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','orderNum','supplyNum','date','person','details'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      orderNum: cells[0].textContent,
      supplyNum: cells[1].textContent,
      date: cells[2].textContent,
      person: cells[3].textContent,
      details: cells[4].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `orders_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});
document.getElementById('exportOrdersDoc').addEventListener('click', ()=> {
  if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡';
  const headers = ['#','Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡','ØªÙˆØ±ÙŠØ¯','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù‚Ø§Ø¦Ù…','ØªÙØ§ØµÙŠÙ„'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredOrders){
    const allOrders = orders.filter(o => !o.deleted);
    if(!allOrders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    allOrders.forEach((o,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(o.orderNum||'')}</td><td>${escapeHtml(o.supplyNum||'')}</td><td>${escapeHtml(o.date||'')}</td><td>${escapeHtml(o.person||'')}</td><td>${escapeHtml(o.details||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `orders_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0]?.textContent||'')}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `orders_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});
/* Print Current Page - Faults */
document.getElementById('printPdfCurrentPage')?.addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedRows = visibleRows.slice().sort((a, b) => {
    const dateA = new Date(a.querySelectorAll('td')[7]?.textContent?.trim() || '').getTime();
    const dateB = new Date(b.querySelectorAll('td')[7]?.textContent?.trim() || '').getTime();
    return dateA - dateB;
  });

  // Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·
  const q = (document.getElementById('search').value||'').toLowerCase();
  let searchSummaryHtml = '';
  if(q.trim()){
    const matched = sortedRows;
    const totalFaults = matched.length;
    const uniqueMachines = Array.from(new Set(matched.map(tr=>tr.querySelectorAll('td')[1]?.textContent?.trim()).filter(Boolean)));
    if(totalFaults){
      searchSummaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: <span style="color:#00796b">${q}</span> â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„: <span style="color:#00796b">${totalFaults}</span> | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
    }
  }

  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += searchSummaryHtml;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
  sortedRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td><td>${escapeHtml(cells[11].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Print ALL - Faults (all data regardless of pagination) */
document.getElementById('printPdfAll').removeEventListener('click', null);
document.getElementById('printPdfAll').addEventListener('click', ()=> {
  if(!faults || !faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
  const allFaults = faults.filter(f => !f.deleted);
  if(!allFaults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedFaults = allFaults.slice().sort((a, b) => {
    const dateA = new Date(a.date || '').getTime();
    const dateB = new Date(b.date || '').getTime();
    return dateA - dateB;
  });

  // Ù…Ù„Ø®Øµ Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const totalFaults = sortedFaults.length;
  const uniqueMachines = Array.from(new Set(sortedFaults.map(f=>f.machine).filter(Boolean)));
  let summaryHtml = '';
  if(totalFaults){
    summaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„: <span style="color:#00796b">${totalFaults}</span> | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
  }

  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += summaryHtml;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
  sortedFaults.forEach((f, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td>${escapeHtml(f.status)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Print Current Page - Orders */
document.getElementById('printOrdersCurrentPage')?.addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedRows = visibleRows.slice().sort((a, b) => {
    const dateA = new Date(a.querySelectorAll('td')[2]?.textContent?.trim() || '').getTime();
    const dateB = new Date(b.querySelectorAll('td')[2]?.textContent?.trim() || '').getTime();
    return dateA - dateB;
  });

  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  sortedRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Orders (all data regardless of pagination) */
document.getElementById('printOrdersBtn').removeEventListener('click', null);
document.getElementById('printOrdersBtn').addEventListener('click', ()=> {
  if(!orders || !orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
  const allOrders = orders.filter(o => !o.deleted);
  if(!allOrders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
  const sortedOrders = allOrders.slice().sort((a, b) => {
    const dateA = new Date(a.date || '').getTime();
    const dateB = new Date(b.date || '').getTime();
    return dateA - dateB;
  });

  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  sortedOrders.forEach((o, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* dashboard */

// Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 15. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('printFaultsSummaryBtn')?.addEventListener('click', function() {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ù…Ø§ÙƒÙŠÙ†Ø©ØŒ Ø£Ø¶Ù Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const q = (document.getElementById('search').value||'').toLowerCase();
    let searchSummaryHtml = '';
    if(q.trim()){
      const matched = faults.filter(f => !f.deleted && f.machine.toLowerCase().includes(q));
      const totalFaults = matched.length;
      const uniqueMachines = Array.from(new Set(matched.map(f=>f.machine)));
      if(totalFaults){
        searchSummaryHtml = `<div style=\"background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px\">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: <span style=\"color:#00796b\">${q}</span> â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„: <span style=\"color:#00796b\">${totalFaults}</span> | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: <span style=\"color:#00796b\">${uniqueMachines.length}</span></div>`;
      }
    }
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù„ÙƒÙ„ Ù…Ø§ÙƒÙŠÙ†Ø©
  const faultsSummary = {};
  faults.filter(f => !f.deleted).forEach(f => {
    const key = `${f.machine} (${f.line})`;
    if (!faultsSummary[key]) faultsSummary[key] = 0;
    faultsSummary[key]++;
  });
  let totalFaults = Object.values(faultsSummary).reduce((a,b)=>a+b,0);
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  const faultsByGroup = {};
  faults.filter(f => !f.deleted).forEach(f => {
    const group = f.line || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    if (!faultsByGroup[group]) faultsByGroup[group] = [];
    faultsByGroup[group].push({ machine: f.machine, count: 1 });
  });
  // Ø¯Ù…Ø¬ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  Object.keys(faultsByGroup).forEach(group => {
    const machines = {};
    faultsByGroup[group].forEach(item => {
      if (!machines[item.machine]) machines[item.machine] = 0;
      machines[item.machine] += item.count;
    });
    faultsByGroup[group] = machines;
  });
  let html = `<html dir=\"rtl\"><head><meta charset=\"utf-8\"><title>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</title><style>
    body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:32px}
    /* ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ */
    .summary-title{color:#0A4C88;text-align:center;font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:1px}
    .summary-desc{text-align:center;color:#444;font-size:16px;margin-bottom:10px}
    .summary-date{color:#666;text-align:center;font-size:15px;margin-bottom:18px}
    .summary-total{background:#e8f7e8;color:#00796b;font-size:18px;font-weight:700;text-align:center;padding:10px 0;margin-bottom:18px;border-radius:8px;box-shadow:0 1px 6px #0001}
    .group-section{margin-bottom:32px}
    .group-title{background:#0A4C88;color:#fff;font-size:22px;font-weight:700;padding:10px 0 10px 0;border-radius:10px;text-align:center;margin-bottom:18px;box-shadow:0 1px 6px #0001}
    .cards-wrap{display:flex;flex-wrap:wrap;gap:18px;justify-content:center}
    .summary-card{background:#fff;border-radius:14px;box-shadow:0 2px 12px #0001;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow .2s}
    .summary-card:hover{box-shadow:0 4px 18px #0077b633}
    .card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}
    .card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}
    .footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}
  </style></head><body>`;
  html += `<div class=\"header-logo\"></div>`;
  // html += `<div class=\"header-logo\"></div>`;
  html += `<div class=\"summary-title\">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</div>`;
  html += `<div class=\"summary-desc\">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆØ¶Ø­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙ…Ø§ÙƒÙŠÙ†Ø§ØªÙ‡Ø§ (Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«)</div>`;
  html += `<div class=\"summary-date\">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString()}</div>`;
  html += `<div class=\"summary-total\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„: ${totalFaults.toLocaleString('ar-EG')}</div>`;
  html += searchSummaryHtml;
  const groupOrder = Object.keys(MACHINE_GROUPS).concat(Object.keys(faultsByGroup).filter(g=>!Object.keys(MACHINE_GROUPS).includes(g)));
  const orderedGroups = Object.keys(MACHINE_GROUPS);
  orderedGroups.forEach(group => {
    if(!faultsByGroup[group]) return;
    html += `<div class=\"group-section\"><div class=\"group-title\">${group}</div><div class=\"cards-wrap\">`;
    let machinesOrder = MACHINE_GROUPS[group] || [];
    // Ø¹Ø±Ø¶ Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    machinesOrder.forEach(machineName => {
      if(faultsByGroup[group][machineName]){
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machineName}</div><div class=\"card-count\">${faultsByGroup[group][machineName].toLocaleString('ar-EG')}</div></div>`;
      }
    });
    // Ø¹Ø±Ø¶ Ø£ÙŠ Ù…Ø§ÙƒÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯Ù‡Ù…
    Object.entries(faultsByGroup[group]).forEach(([machine, count]) => {
      if(!machinesOrder.includes(machine)){
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machine}</div><div class=\"card-count\">${count.toLocaleString('ar-EG')}</div></div>`;
      }
    });
    html += `</div></div>`;
  });
  html += `<div class=\"footer\">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ | ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†ÙŠØ©</div>`;
  html += '</body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
});

// Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª
document.getElementById('printMaintenanceSummaryBtn')?.addEventListener('click', function() {
  // Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø©: Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ Ø´Ù‡Ø±ÙŠØ©ØŒ Ø³Ù†ÙˆÙŠØ©
  const types = ['Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©','Ø´Ù‡Ø±ÙŠØ©','Ø³Ù†ÙˆÙŠØ©'];
  const summary = {};
  types.forEach(type => { summary[type] = 0; });
  maintenance.filter(m => !m.deleted).forEach(m => {
    if (types.includes(m.type)) summary[m.type]++;
  });
  let totalMaint = maintenance.filter(m => !m.deleted).length;
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  const maintByGroup = {};
  maintenance.filter(m => !m.deleted).forEach(m => {
    const group = m.line || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    if (!maintByGroup[group]) maintByGroup[group] = [];
    maintByGroup[group].push({ machine: m.machine, type: m.type });
  });
  // Ø¯Ù…Ø¬ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  Object.keys(maintByGroup).forEach(group => {
    const machines = {};
    maintByGroup[group].forEach(item => {
      if (!machines[item.machine]) machines[item.machine] = {};
      if (!machines[item.machine][item.type]) machines[item.machine][item.type] = 0;
      machines[item.machine][item.type]++;
    });
    maintByGroup[group] = machines;
  });
  let html = `<html dir=\"rtl\"><head><meta charset=\"utf-8\"><title>Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø©</title><style>
    body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:32px}
    .header-logo{display:block;margin:0 auto 10px auto;width:80px;height:80px;border-radius:50%;background:#0A4C88 url('https://i.imgur.com/1Q9Z1Zy.png') no-repeat center/60px;box-shadow:0 2px 12px #0002}
    .summary-title{color:#0A4C88;text-align:center;font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:1px}
    .summary-desc{text-align:center;color:#444;font-size:16px;margin-bottom:10px}
    .summary-date{color:#666;text-align:center;font-size:15px;margin-bottom:18px}
    .summary-total{background:#e8f7e8;color:#00796b;font-size:18px;font-weight:700;text-align:center;padding:10px 0;margin-bottom:18px;border-radius:8px;box-shadow:0 1px 6px #0001}
    .group-section{margin-bottom:32px}
    .group-title{background:#0A4C88;color:#fff;font-size:22px;font-weight:700;padding:10px 0 10px 0;border-radius:10px;text-align:center;margin-bottom:18px;box-shadow:0 1px 6px #0001}
    .cards-wrap{display:flex;flex-wrap:wrap;gap:18px;justify-content:center}
    .summary-card{background:#fff;border-radius:14px;box-shadow:0 2px 12px #0001;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow .2s}
    .summary-card:hover{box-shadow:0 4px 18px #0077b633}
    .card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}
    .card-type{font-size:15px;color:#0077b6;margin-bottom:8px}
    .card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}
    .footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}
  </style></head><body>`;
  html += `<div class=\"summary-title\">Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</div>`;
  html += `<div class=\"summary-desc\">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆØ¶Ø­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙ…Ø§ÙƒÙŠÙ†Ø§ØªÙ‡Ø§ ÙˆØ£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«)</div>`;
  html += `<div class=\"summary-date\">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString()}</div>`;
  html += `<div class=\"summary-total\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©: ${totalMaint.toLocaleString('ar-EG')}</div>`;
  Object.entries(maintByGroup).forEach(([group, machines]) => {
    html += `<div class=\"group-section\"><div class=\"group-title\">${group}</div><div class=\"cards-wrap\">`;
    Object.entries(machines).forEach(([machine, typesObj]) => {
      Object.entries(typesObj).forEach(([type, count]) => {
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machine}</div><div class=\"card-type\">${type}</div><div class=\"card-count\">${count.toLocaleString('ar-EG')}</div></div>`;
      });
    });
    html += `</div></div>`;
  });
  html += `<div class=\"footer\">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ | ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†ÙŠØ©</div>`;
  html += '</body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
});
function applyDashboardTile(title){
  // faults statuses
  const faultStatuses = ['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  // maintenance types mapping
  const maintMap = {
    'ØµÙŠØ§Ù†Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©':'Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©',
    'ØµÙŠØ§Ù†Ø© Ø´Ù‡Ø±ÙŠØ©':'Ø´Ù‡Ø±ÙŠØ©',
    'Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©':'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ',
    'ØµÙŠØ§Ù†Ø© Ø³Ù†ÙˆÙŠØ©':'Ø³Ù†ÙˆÙŠØ©',
    'ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©':'Ø·Ø§Ø±Ø¦Ø©'
  };

  // Faults tiles
  if(title.includes('Ø£Ø¹Ø·Ø§Ù„') || faultStatuses.some(s=> title.includes(s) )){
    // clear search/date filters
    const statusTitle = faultStatuses.find(s=> title.includes(s));
    if(statusTitle){ document.getElementById('filterStatus').value = statusTitle; }
    else { document.getElementById('filterStatus').value = ''; }
    document.getElementById('search').value = '';
    document.getElementById('dateFromFault').value = '';
    document.getElementById('dateToFault').value = '';
    show('faults');
    applyFilters();
    return;
  }

  // Maintenance tiles
  if(title.includes('ØµÙŠØ§Ù†Ø©') || title.includes('Ø§Ù„ØµÙŠØ§Ù†Ø§Øª')){
    const mapped = maintMap[title] || '';
    document.getElementById('filterMaintenanceType').value = mapped;
    document.getElementById('searchMaintenance').value = '';
    document.getElementById('dateFromMaintenance').value = '';
    document.getElementById('dateToMaintenance').value = '';
    show('maintenance');
    applyMaintenanceFilters();
    return;
  }
}

function drawDashboard(){
  const total = faults.length;
  const done = faults.filter(f=>f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const working = faults.filter(f=>f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const testing = faults.filter(f=>f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©').length;
  const waitC = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©').length;
  const waitP = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±').length;

  const maintenanceTotal = maintenance.length;
  const mainWeekly = maintenance.filter(m=>m.type==='Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©').length;
  const mainMonthly = maintenance.filter(m=>m.type==='Ø´Ù‡Ø±ÙŠØ©').length;
  const mainQuarterAll = maintenance.filter(m=>m.type==='Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ').length;
  const mainYearly = maintenance.filter(m=>m.type==='Ø³Ù†ÙˆÙŠØ©').length;
  const mainEmergency = maintenance.filter(m=>m.type==='Ø·Ø§Ø±Ø¦Ø©').length;

  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentQuarter = Math.floor(now.getMonth()/3) + 1;
  function quarterOf(dateStr){
    const d = new Date(dateStr);
    if(isNaN(d)) return { year: null, quarter: null };
    return { year: d.getFullYear(), quarter: Math.floor(d.getMonth()/3) + 1 };
  }
  const mainQuarterCurrent = maintenance.filter(m => {
    if(m.type !== 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ') return false;
    const q = quarterOf(m.date);
    return q.year === currentYear && q.quarter === currentQuarter;
  }).length;

  const tiles = document.getElementById('tiles'); tiles.innerHTML='';
  function tileColor(title){
    // Ø£Ø®Ø¶Ø± Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬ÙŠØ¯Ø© / Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ Ø£ØµÙØ± Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©/ØªØ­Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±/Ø¨Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø£Ø²Ø±Ù‚ Ù„Ù„ØµÙŠØ§Ù†Ø§Øª
    const greenRegex = /ØªÙ…\s?Ø§Ù„Ø¥ØµÙ„Ø§Ø­|Ø¥Ø¬Ù…Ø§Ù„ÙŠ\s?Ø§Ù„Ø£Ø¹Ø·Ø§Ù„/;
    const yellowRegex = /Ø¬Ø§Ø±ÙŠ\s?Ø§Ù„Ø¥ØµÙ„Ø§Ø­|ØªØ­Øª\s?Ø§Ù„ØªØ¬Ø±Ø¨Ø©|ØªØ­Øª\s?Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±|Ø¨Ø§Ù†ØªØ¸Ø§Ø±/;
    const blueRegex = /ØµÙŠØ§Ù†Ø©|Ø§Ù„ØµÙŠØ§Ù†Ø§Øª|ØµÙŠØ§Ù†Ø©\s?Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©|ØµÙŠØ§Ù†Ø©\s?Ø´Ù‡Ø±ÙŠØ©|Ø±Ø¨Ø¹\s?Ø³Ù†ÙˆÙŠ|ØµÙŠØ§Ù†Ø©\s?Ø³Ù†ÙˆÙŠØ©|ØµÙŠØ§Ù†Ø©\s?Ø·Ø§Ø±Ø¦Ø©/;
    if(greenRegex.test(title)) return { bg: '#e8f7e8', fg: '#08365F' };
    if(yellowRegex.test(title)) return { bg: '#fff8dc', fg: '#08365F' };
    if(blueRegex.test(title)) return { bg: '#e6f0ff', fg: '#08365F' };
    return { bg: '#fff', fg: '#000' };
  }
  const addTile = (title,val)=> {
    const d=document.createElement('div'); d.className='tile';
    d.innerHTML=`<h4 style="margin:0 0 6px 0">${title}</h4><div style="font-weight:700;font-size:20px">${val}</div>`;
    // apply color for tiles (bg + foreground)
    const clr = tileColor(title);
    d.style.background = clr.bg;
    d.style.color = clr.fg;
    // make tile clickable: apply filter and navigate
    d.style.cursor = 'pointer';
    d.addEventListener('click', function(){
      try{ applyDashboardTile(title); }catch(e){ console.error('tile click error', e); }
    });
    tiles.appendChild(d);
  };
  addTile('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„', total);
  addTile('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', done);
  addTile('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', working);
  addTile('Ø£Ø¹Ø·Ø§Ù„ ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©', testing);
  addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©', waitC);
  addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±', waitP);
  addTile('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª', maintenanceTotal);
  addTile('ØµÙŠØ§Ù†Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', mainWeekly);
  addTile('ØµÙŠØ§Ù†Ø© Ø´Ù‡Ø±ÙŠØ©', mainMonthly);
  addTile('Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©', mainQuarterAll);
  addTile('ØµÙŠØ§Ù†Ø© Ø³Ù†ÙˆÙŠØ©', mainYearly);
  addTile('ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©', mainEmergency);

  const canvas = document.getElementById('pie'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const data = [done, working, testing, waitC, waitP]; const colors=['#8ed08e','#ffd966','#fff3b0','#ffd59e','#ffb4b4']; const labels=['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-20;
  let start=0; const totalSum = data.reduce((a,b)=>a+b,0);
  for(let i=0;i<data.length;i++){
    const slice = totalSum===0?0:(data[i]/totalSum)*(Math.PI*2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i]; ctx.arc(cx,cy,r,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
  }
  ctx.font='13px Arial'; let ly=10; for(let i=0;i<labels.length;i++){ ctx.fillStyle=colors[i]; ctx.fillRect(10,ly,12,12); ctx.fillStyle='#000'; ctx.fillText(` ${labels[i]} (${data[i]})`, 28, ly+10); ly+=18; }
  const tbody = document.querySelector('#dashTable tbody'); tbody.innerHTML=''; labels.forEach((lab,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${data[i]}</td>`; tbody.appendChild(tr);});
  try{ if(typeof resizeAndRedraw === 'function') setTimeout(resizeAndRedraw,50); }catch(e){}
}

// Render dashboard chart/table for a provided fault list
function applyDashboardData(faultArray){
  const done = faultArray.filter(f=>f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const working = faultArray.filter(f=>f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const testing = faultArray.filter(f=>f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©').length;
  const waitC = faultArray.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©').length;
  const waitP = faultArray.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±').length;
  const data = [done, working, testing, waitC, waitP]; const colors=['#8ed08e','#ffd966','#fff3b0','#ffd59e','#ffb4b4']; const labels=['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  const canvas = document.getElementById('pie'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-20;
  let start=0; const totalSum = data.reduce((a,b)=>a+b,0);
  for(let i=0;i<data.length;i++){
    const slice = totalSum===0?0:(data[i]/totalSum)*(Math.PI*2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i]; ctx.arc(cx,cy,r,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
  }
  ctx.font='13px Arial'; let ly=10; for(let i=0;i<labels.length;i++){ ctx.fillStyle=colors[i]; ctx.fillRect(10,ly,12,12); ctx.fillStyle='#000'; const pct = totalSum===0?0:Math.round((data[i]/totalSum)*100); ctx.fillText(` ${labels[i]} (${data[i]}) - ${pct}%`, 28, ly+10); ly+=18; }
  const tbody = document.querySelector('#dashTable tbody'); tbody.innerHTML=''; labels.forEach((lab,i)=>{
    const tr=document.createElement('tr');
    const pct = totalSum===0 ? '0%' : Math.round((data[i]/totalSum)*100) + '%';
    tr.innerHTML = `<td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${lab}</td><td data-label="Ø§Ù„Ø¹Ø¯Ø¯">${data[i]}</td><td data-label="Ø§Ù„Ù†Ø³Ø¨Ø©">${pct}</td>`;
    tbody.appendChild(tr);
  });
  // Update summary: show selected machine/group total and percentage relative to date-range total
  try{
    const summaryEl = document.getElementById('dashSummary');
    if(summaryEl){
      const from = document.getElementById('dashDateFrom')?.value || '';
      const to = document.getElementById('dashDateTo')?.value || '';
      // compute total faults within the date range (ignore machine/group filters)
      const totalByDate = (faults||[]).filter(f=>{
        if(f.deleted) return false;
        if(from && (!f.date || f.date < from)) return false;
        if(to && (!f.date || f.date > to)) return false;
        return true;
      });
      const totalByDateCount = totalByDate.length || 0;
      const selMachine = (document.getElementById('dashMachineItem')?.value||'').trim();
      const selGroup = (document.getElementById('dashMachineGroup')?.value||'').trim();
      if(selMachine){
        const machineCount = totalByDate.filter(f=>f.machine === selMachine).length;
        const pct = totalByDateCount? Math.round((machineCount/totalByDateCount)*100) : 0;
        summaryEl.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù„Ù„Ù…Ø§ÙƒÙŠÙ†Ø© "${selMachine}": ${machineCount} â€” Ù†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©: ${pct}%`;
      } else if(selGroup){
        const groupCount = totalByDate.filter(f=>f.line === selGroup).length;
        const pct = totalByDateCount? Math.round((groupCount/totalByDateCount)*100) : 0;
        summaryEl.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${selGroup}": ${groupCount} â€” Ù†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©: ${pct}%`;
      } else {
        // if no machine/group selected, clear or show total for the date range
        if(totalByDateCount > 0){
          summaryEl.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©: ${totalByDateCount}`;
        } else {
          summaryEl.innerText = '';
        }
      }
    }
  }catch(e){ console.error('dash summary error', e); }
}

// Return faults filtered by dashboard controls (date range and machine)
function getFilteredFaultsForDashboard(){
  const from = document.getElementById('dashDateFrom').value;
  const to = document.getElementById('dashDateTo').value;
  const group = (document.getElementById('dashMachineGroup')?.value||'').trim();
  const machine = (document.getElementById('dashMachineItem')?.value||'').trim();
  return faults.filter(f=>{
    if(f.deleted) return false;
    if(from){ if(!f.date || f.date < from) return false; }
    if(to){ if(!f.date || f.date > to) return false; }
    if(machine){ if((f.machine||'') !== machine) return false; }
    else if(group){ if((f.line||'') !== group) return false; }
    return true;
  });
}

// Wire buttons
document.getElementById('dashFilterBtn')?.addEventListener('click', function(){ const list = getFilteredFaultsForDashboard(); applyDashboardData(list); resizeAndRedraw(); });
document.getElementById('dashResetBtn')?.addEventListener('click', function(){ document.getElementById('dashDateFrom').value=''; document.getElementById('dashDateTo').value=''; if(document.getElementById('dashMachineGroup')) document.getElementById('dashMachineGroup').value=''; if(document.getElementById('dashMachineItem')) document.getElementById('dashMachineItem').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; applyDashboardData(faults); resizeAndRedraw(); });

// Resize canvas to container and redraw dashboard
function resizeAndRedraw(){
  try{
    const container = document.querySelector('#page_dash .box');
    const canvas = document.getElementById('pie');
    if(!canvas || !container) return;
    // set pixel size for canvas to container width with 0.45 ratio height
    const w = Math.max(300, Math.min(1000, container.clientWidth));
    const h = Math.round(w * 0.38);
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    // choose current filter set if any
    const list = getFilteredFaultsForDashboard();
    applyDashboardData(list.length?list:faults);
  }catch(e){ console.error('resizeAndRedraw error', e); }
}

// debounce resize
let _dashResizeTimer = null;
window.addEventListener('resize', function(){ if(_dashResizeTimer) clearTimeout(_dashResizeTimer); _dashResizeTimer = setTimeout(resizeAndRedraw, 200); });
// initial sizing
setTimeout(resizeAndRedraw,50);

/* init render */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 16. Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ«/Ø±ÙŠÙØ±Ø´ Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
try{ sessionStorage.removeItem('attendanceUnlocked'); }catch(e){}
// Ø£ÙŠØ¶Ø§Ù‹ Ø£Ø²Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙØ±Ø´ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
try{ sessionStorage.removeItem('attendanceVisibleOnlyId'); }catch(e){}
renderFaultTable(); renderOrderTable(); renderMaintenanceTable(); renderAttendanceTable(); renderTrash(); drawDashboard();

function loadFromServer() {
  // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=faults')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
      // ÙØµÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      faults = data.filter(f => !f.deleted && f.deleted !== 'Yes' && f.deleted !== 'TRUE' && f.deleted !== true);
      const deletedFaults = data.filter(f => f.deleted === 'Yes' || f.deleted === 'TRUE' || f.deleted === true);
      
      trash.faults = deletedFaults;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderFaultTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      drawDashboard();            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ Dashboard
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 2) ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=orders')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
      // ÙØµÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      orders = data.filter(o => !o.deleted && o.deleted !== 'Yes' && o.deleted !== 'TRUE' && o.deleted !== true);
      const deletedOrders = data.filter(o => o.deleted === 'Yes' || o.deleted === 'TRUE' || o.deleted === true);
      
      trash.orders = deletedOrders;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderOrderTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 3) ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=maintenance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
      // ÙØµÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ "deleted"
      maintenance = data.filter(m => !m.deleted && m.deleted !== 'Yes' && m.deleted !== 'TRUE' && m.deleted !== true);
      const deletedMaintenance = data.filter(m => m.deleted === 'Yes' || m.deleted === 'TRUE' || m.deleted === true);
      
      trash.maintenance = deletedMaintenance;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderMaintenanceTable();             // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();                        // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      drawDashboard();                      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ Dashboard
      saveAll();                            // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 4) ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=attendance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
      // ÙØµÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ "deleted"
      attendance = data.filter(a => !a.deleted && a.deleted !== 'Yes' && a.deleted !== 'TRUE' && a.deleted !== true);
      const deletedAttendance = data.filter(a => a.deleted === 'Yes' || a.deleted === 'TRUE' || a.deleted === true);
      
      trash.attendance = deletedAttendance;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderAttendanceTable();            // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();                      // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                          // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 5) ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ)
  if(typeof fetch !== 'undefined'){
    fetch(API_URL + '?kind=catalog')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        // ÙØµÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        catalog = data.filter(c => !c.deleted && c.deleted !== 'Yes' && c.deleted !== 'TRUE' && c.deleted !== true);
        const deletedCatalog = data.filter(c => c.deleted === 'Yes' || c.deleted === 'TRUE' || c.deleted === true);
        
        catalogTrash = deletedCatalog;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
        renderCatalogTable();           // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù†Ø´Ø·
        renderTrash();                  // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
        saveAll();                      // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
      })
      .catch(err => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', err);
      });
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø¹Ù…Ù„ Ø±Ù†Ø¯Ø± Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† localStorage (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
loadFromServer();

function renderFaultTable(){ 
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 17. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØµÙŠÙŠØ± (Render) Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const tbody = document.querySelector('#faultTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('faultCards');
  cardsDiv.innerHTML = '';
  
  // Ø§Ù‚Ø±Ø£ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const q = (document.getElementById('search')?.value||'').toLowerCase();
  const st = (document.getElementById('filterStatus')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault')?.value;
  const dateTo = document.getElementById('dateToFault')?.value;

  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredFaults){
    dataToRender = faults.filter(f => {
      if(f.deleted) return false;
      const text = `${f.machine||''} ${f.line||''} ${f.person||''} ${f.description||''} ${f.solution||''} ${f.status||''}`.toLowerCase();
      const statusMatch = !st || text.includes(st);
      const rowDate = f.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return ((!q || text.includes(q)) && statusMatch && dateMatch);
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(faults, currentPageFaults);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }
  
  dataToRender.forEach((f, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = isFilteredFaults ? pageIndex + 1 : (currentPageFaults - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td class="status-cell">${escapeHtml(f.status)}</td><td class="no-print actions"><button class="btn ghost" onclick="confirmEditAndRun('startEditFault','${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="confirmPasswordAndRun('moveToTrashFault','${f.id}')">Ø­Ø°Ù</button></td>`; 
    const sc = tr.querySelector('.status-cell'); 
    if(f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­') sc.classList.add('status-okay'); 
    else if(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' || f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©') sc.classList.add('status-working'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©') sc.classList.add('status-wait-company'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±') sc.classList.add('status-wait-part'); 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'fault-card';
    const statusClass = f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'?'status-okay':(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­'||f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©')?'status-working':(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©')?'status-wait-company':'status-wait-part';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${globalIndex} - ${escapeHtml(f.machine)}</div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ø®Ø·:</div><div class="fault-card-value">${displayValue(f.line)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="fault-card-value">${displayValue(f.person)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØµÙ:</div><div class="fault-card-value">${displayValue(f.description)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„:</div><div class="fault-card-value">${displayValue(f.solution)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.shift)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">L Number:</div><div class="fault-card-value">${displayValue(f.lcode)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©:</div><div class="fault-card-value">${displayValue(f.partName)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.partQty)}</div></div>
      <div class="fault-card-row" style="margin-top:14px"><div class="fault-card-label">Ø§Ù„Ø­Ø§Ù„Ø©:</div><div class="fault-card-value"><div class="card-status-badge ${statusClass}">${escapeHtml(f.status)}</div></div></div>
      <div class="fault-card-actions">
        <button class="btn ghost" onclick="confirmEditAndRun('startEditFault','${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="confirmPasswordAndRun('moveToTrashFault','${f.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination - Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ„ØªØ±Ø©
  if(!isFilteredFaults) {
    updatePaginationButtons('#faultsPagination', totalPages, currentPageFaults, (pageNum) => {
      currentPageFaults = pageNum;
      renderFaultTable();
    });
  }
  
  saveAll(); 
}

function renderOrderTable(){ 
  const tbody = document.querySelector('#orderTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('orderCards');
  cardsDiv.innerHTML = '';
  
  // Ø§Ù‚Ø±Ø£ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const q=(document.getElementById('searchOrder')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder')?.value;
  const dateTo = document.getElementById('dateToOrder')?.value;

  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredOrders){
    dataToRender = orders.filter(o => {
      if(o.deleted) return false;
      const text = `${o.orderNum||''} ${o.supplyNum||''} ${o.person||''} ${o.details||''}`.toLowerCase();
      const rowDate = o.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return (!q || text.includes(q)) && dateMatch;
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(orders, currentPageOrders);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }
  
  dataToRender.forEach((o, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = isFilteredOrders ? pageIndex + 1 : (currentPageOrders - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td><td class="no-print actions"><button class="btn ghost" onclick="showOrderDetails('${o.id}')">Ø¹Ø±Ø¶</button><button class="btn ghost" onclick="confirmEditAndRun('startEditOrder','${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="confirmPasswordAndRun('moveToTrashOrder','${o.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø£Ù…Ø± #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙˆØ±ÙŠØ¯:</div><div class="order-card-value">${displayValue(o.supplyNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="order-card-value">${displayValue(o.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</div><div class="order-card-value">${displayValue(o.details)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="showOrderDetails('${o.id}')">Ø¹Ø±Ø¶</button>
        <button class="btn ghost" onclick="confirmEditAndRun('startEditOrder','${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="confirmPasswordAndRun('moveToTrashOrder','${o.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  }); 
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination - Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ„ØªØ±Ø©
  if(!isFilteredOrders) {
    updatePaginationButtons('#ordersPagination', totalPages, currentPageOrders, (pageNum) => {
      currentPageOrders = pageNum;
      renderOrderTable();
    });
  }
  
  saveAll(); 
}

function renderMaintenanceTable(){ 
  const tbody = document.querySelector('#maintenanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('maintenanceCards');
  cardsDiv.innerHTML = '';
  
  // Ù‚Ø±Ø§Ø¡Ø© Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶)
  const q = (document.getElementById('searchMaintenance')?.value||'').toLowerCase();
  const filterType = (document.getElementById('filterMaintenanceType')?.value||'').trim();
  const dateFrom = document.getElementById('dateFromMaintenance')?.value;
  const dateTo = document.getElementById('dateToMaintenance')?.value;

  // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶Ø› Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ÙÙ„ØªØ± Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredMaintenance){
    dataToRender = maintenance.filter(m => {
      if(m.deleted) return false;
      const text = `${m.machine||''} ${m.line||''} ${m.person||''} ${m.partName||''} ${m.notes||''} ${m.type||''}`.toLowerCase();
      const typeMatch = !filterType || ((m.type||'') === filterType);
      const rowDate = m.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return ((!q || text.includes(q)) && typeMatch && dateMatch);
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(maintenance, currentPageMaintenance);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }

  dataToRender.forEach((m, pageIndex)=>{
    const globalIndex = isFilteredMaintenance ? pageIndex + 1 : (currentPageMaintenance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(m.machine)}</td><td>${escapeHtml(m.line)}</td><td>${escapeHtml(m.person)}</td><td>${escapeHtml(m.date)}</td><td>${escapeHtml(m.lcode)}</td><td>${escapeHtml(m.partName)}</td><td>${escapeHtml(m.partQty)}</td><td>${escapeHtml(m.type)}</td><td>${escapeHtml(m.notes)}</td><td class="no-print actions"><button class="btn ghost" onclick="confirmEditAndRun('startEditMaintenance','${m.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="confirmPasswordAndRun('moveToTrashMaintenance','${m.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);

    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">ØµÙŠØ§Ù†Ø© #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©:</div><div class="order-card-value">${displayValue(m.machine)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ø®Ø·:</div><div class="order-card-value">${displayValue(m.line)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="order-card-value">${displayValue(m.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(m.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">L Number:</div><div class="order-card-value">${displayValue(m.lcode)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø·Ø¹Ø©:</div><div class="order-card-value">${displayValue(m.partName)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="order-card-value">${displayValue(m.partQty)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù†ÙˆØ¹:</div><div class="order-card-value">${displayValue(m.type)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div><div class="order-card-value">${displayValue(m.notes)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="confirmEditAndRun('startEditMaintenance','${m.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="confirmPasswordAndRun('moveToTrashMaintenance','${m.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });

  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination - Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ„ØªØ±Ø©
  if(!isFilteredMaintenance){
    updatePaginationButtons('#maintenancePagination', totalPages, currentPageMaintenance, (pageNum) => {
      currentPageMaintenance = pageNum;
      renderMaintenanceTable();
    });
  }

  saveAll(); 
}

function renderTrash(){
  // FAULTS
  const tf = document.querySelector('#trashFaults tbody');
  const tfCards = document.getElementById('trashFaultsCards');
  
  if(tf) {
    tf.innerHTML='';
    if(tfCards) tfCards.innerHTML='';
    
    (trash.faults || []).forEach((f,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
      restoreBtn.addEventListener('click', () => restoreFault(f.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ';
            permBtn.addEventListener('click', () => confirmPasswordAndRun('permanentDeleteFault', f.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      tf.appendChild(tr);

      // Card for mobile
      if(tfCards){
        const card = document.createElement('div');
        card.className = 'fault-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø¹Ø·Ù„ #${i+1}</div>
          <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©:</div><div class="fault-card-value">${displayValue(f.machine)}</div></div>
          <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
          <div class="fault-card-actions">
            <button class="btn" onclick="restoreFault('${f.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
            <button class="btn ghost" onclick="confirmPasswordAndRun('permanentDeleteFault','${f.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
          </div>
        `;
        tfCards.appendChild(card);
      }
    });
  }

  // ORDERS
  const to = document.querySelector('#trashOrders tbody');
  const toCards = document.getElementById('trashOrdersCards');
  
  if(to) {
    to.innerHTML='';
    if(toCards) toCards.innerHTML='';
    
    (trash.orders || []).forEach((o,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
      restoreBtn.addEventListener('click', () => restoreOrder(o.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ';
      permBtn.addEventListener('click', () => confirmPasswordAndRun('permanentDeleteOrder', o.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      to.appendChild(tr);

      // Card for mobile
      if(toCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø£Ù…Ø± #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreOrder('${o.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
            <button class="btn ghost" onclick="confirmPasswordAndRun('permanentDeleteOrder','${o.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
          </div>
        `;
        toCards.appendChild(card);
      }
    });
  }

  // MAINTENANCE
  const tm = document.querySelector('#trashMaintenance tbody');
  const tmCards = document.getElementById('trashMaintenanceCards');
  
  if(tm){
    tm.innerHTML='';
    if(tmCards) tmCards.innerHTML='';
    
    (trash.maintenance||[]).forEach((m,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${i+1} - ${escapeHtml(m.machine)} (${escapeHtml(m.date)})`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
      restoreBtn.addEventListener('click', () => restoreMaintenance(m.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ';
      permBtn.addEventListener('click', () => confirmPasswordAndRun('permanentDeleteMaintenance', m.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      tm.appendChild(tr);

      // Card for mobile
      if(tmCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">ØµÙŠØ§Ù†Ø© #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©:</div><div class="order-card-value">${displayValue(m.machine)}</div></div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(m.date)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreMaintenance('${m.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
            <button class="btn ghost" onclick="confirmPasswordAndRun('permanentDeleteMaintenance','${m.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
          </div>
        `;
        tmCards.appendChild(card);
      }
    });
  }

  // CATALOG
  const tc = document.querySelector('#trashCatalog tbody');
  if(tc){
    tc.innerHTML='';
    (catalogTrash||[]).forEach((item,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1} - ${escapeHtml(item.machine)} (${escapeHtml(item.description)})</td><td class="no-print actions"><button class="btn" onclick="restoreCatalog('${item.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="confirmPasswordAndRun('permanentDeleteCatalog','${item.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      tc.appendChild(tr);
    });
  }

  // ATTENDANCE
  const ta = document.querySelector('#trashAttendance tbody');
  const taCards = document.getElementById('trashAttendanceCards');
  
  if(ta){
    ta.innerHTML='';
    if(taCards) taCards.innerHTML='';
    
    (trash.attendance||[]).forEach((a,i)=>{
      const tr=document.createElement('tr');
      const tdIndex = document.createElement('td'); tdIndex.textContent = i+1;
      const tdInfo = document.createElement('td'); tdInfo.innerHTML = `${escapeHtml(a.workerName)} / ${escapeHtml(a.workerNum)}`;
      const tdDate = document.createElement('td'); tdDate.textContent = escapeHtml(a.absenceDate);

      const tdActions = document.createElement('td'); tdActions.className = 'no-print actions';
      const restoreBtn = document.createElement('button'); restoreBtn.className = 'btn'; restoreBtn.textContent = 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹'; restoreBtn.addEventListener('click', ()=> restoreAttendance(a.id));
      const permBtn = document.createElement('button'); permBtn.className = 'btn ghost'; permBtn.textContent = 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ'; permBtn.addEventListener('click', ()=> confirmPasswordAndRun('permanentDeleteAttendance', a.id));
      tdActions.appendChild(restoreBtn); tdActions.appendChild(permBtn);

      tr.appendChild(tdIndex); tr.appendChild(tdInfo); tr.appendChild(tdDate); tr.appendChild(tdActions);
      ta.appendChild(tr);

      // Card for mobile
      if(taCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø­Ø¶ÙˆØ± #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ø§Ø³Ù…:</div><div class="order-card-value">${displayValue(a.workerName)}</div></div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ø±Ù‚Ù…:</div><div class="order-card-value">${displayValue(a.workerNum)}</div></div>
          <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(a.absenceDate)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreAttendance('${a.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
            <button class="btn ghost" onclick="confirmPasswordAndRun('permanentDeleteAttendance','${a.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
          </div>
        `;
        taCards.appendChild(card);
      }
    });
  }
}

/* wire inputs for live filters & actions */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 18. Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('input', applyFilters);
document.getElementById('searchOrder').addEventListener('input', applyOrderFilters);

/* ensure exports buttons exist even if no data */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 19. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('exportCsvAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} /* handled above */ });
document.getElementById('exportDocAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersCsv').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersDoc').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('printPdfAll').addEventListener('click', ()=>{/* handled above */});
document.getElementById('printOrdersBtn').addEventListener('click', ()=>{/* handled above */});

/* final save */
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 20. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
saveAll();
</script>
</script>
<script>
  (function(){
    function showAlert(msg, el){
      alert(msg);
      if(el && typeof el.focus === 'function') el.focus();
    }

    function hasSelection(selectEl){
      if(!selectEl) return false;
      if(selectEl.multiple){
        return Array.from(selectEl.options).some(function(o){ return o.selected && o.value.trim() !== ''; });
      }
      return selectEl.value && selectEl.value.trim() !== '';
    }

    function validateFault(){
      var machineGroup = document.getElementById('machineGroup');
      var machineItem = document.getElementById('machineItem');
      var person = document.getElementById('person');
      var personChips = document.getElementById('personChips');
      var description = document.getElementById('description');
      var solution = document.getElementById('solution');
      var shift = document.getElementById('shift');
      var date = document.getElementById('date');
      var partChanged = document.getElementById('partChanged');
      var lcode = document.getElementById('lcode');
      var partName = document.getElementById('partName');
      var partQty = document.getElementById('partQty');
      var status = document.getElementById('status');

      if(!machineGroup || machineGroup.value.trim()==='') { showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø®Ø·).', machineGroup); return false; }
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„
      if(machineGroup && machineGroup.value === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©'){
        var customName = document.getElementById('customMachineName');
        if(!customName || customName.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customName); return false; }
        if(!(hasSelection(person) || (personChips && personChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.', person); return false; }
      } else if(machineGroup && machineGroup.value === 'Ø£Ø®Ø±ÙŠ'){
        var customPlace = document.getElementById('customMachinePlace');
        var customName = document.getElementById('customMachineName');
        if(!customPlace || customPlace.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customPlace || machineGroup); return false; }
        if(!customName || customName.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customName); return false; }
      } else {
        if(!machineItem || machineItem.value.trim()==='') { showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', machineItem); return false; }
      }
      if(!(hasSelection(person) || (personChips && personChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.', person); return false; }
      if(!description || description.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„.', description); return false; }
      if(!solution || solution.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø´Ø±Ø­ Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„.', solution); return false; }
      if(!shift || shift.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©.', shift); return false; }
      if(!date || date.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.', date); return false; }
      if(!partChanged || partChanged.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±.', partChanged); return false; }
      if(partChanged && partChanged.value === 'yes'){
        if(!lcode || lcode.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number).', lcode); return false; }
        if(!partName || partName.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', partName); return false; }
        if(!partQty || partQty.value === '' || Number(partQty.value) <= 0){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', partQty); return false; }
      }
      if(!status || status.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„.', status); return false; }
      return true;
    }

    function validateMaintenance(){
      var mainGroup = document.getElementById('mainGroup');
      var mainItem = document.getElementById('mainItem');
      var mainPerson = document.getElementById('mainPerson');
      var mainPersonChips = document.getElementById('mainPersonChips');
      var mainDate = document.getElementById('mainDate');
      var mainPartChanged = document.getElementById('mainPartChanged');
      var mainLcode = document.getElementById('mainLcode');
      var mainPartName = document.getElementById('mainPartName');
      var mainPartQty = document.getElementById('mainPartQty');
      var mainType = document.getElementById('mainType');

      if(!mainGroup || mainGroup.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø®Ø·).', mainGroup); return false; }
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"ØŒ Ø§Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©
      if(mainGroup && mainGroup.value === 'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©'){
        var customMainName = document.getElementById('customMainName');
        if(!customMainName || customMainName.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customMainName); return false; }
        if(!(hasSelection(mainPerson) || (mainPersonChips && mainPersonChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.', mainPerson); return false; }
      } else if(mainGroup && mainGroup.value === 'Ø£Ø®Ø±ÙŠ'){
        var customMainPlace = document.getElementById('customMainPlace');
        var customMainName = document.getElementById('customMainName');
        if(!customMainPlace || customMainPlace.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customMainPlace || mainGroup); return false; }
        if(!customMainName || customMainName.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customMainName); return false; }
      } else {
        if(!mainItem || mainItem.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', mainItem); return false; }
      }
      if(!(hasSelection(mainPerson) || (mainPersonChips && mainPersonChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.', mainPerson); return false; }
      if(!mainDate || mainDate.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.', mainDate); return false; }
      if(!mainPartChanged || mainPartChanged.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±.', mainPartChanged); return false; }
      if(mainPartChanged && mainPartChanged.value === 'yes'){
        if(!mainLcode || mainLcode.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number).', mainLcode); return false; }
        if(!mainPartName || mainPartName.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', mainPartName); return false; }
        if(!mainPartQty || mainPartQty.value === '' || Number(mainPartQty.value) <= 0){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', mainPartQty); return false; }
      }
      if(!mainType || mainType.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©.', mainType); return false; }
      return true;
    }

    function validateOrder(){
      var orderNum = document.getElementById('orderNum');
      var orderDate = document.getElementById('orderDate');
      var orderPerson = document.getElementById('orderPerson');
      var orderPersonChips = document.getElementById('orderPersonChips');
      var orderDetails = document.getElementById('orderDetails');

      if(!orderNum || orderNum.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderNum); return false; }
      if(!orderDate || orderDate.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderDate); return false; }
      if(!(hasSelection(orderPerson) || (orderPersonChips && orderPersonChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderPerson); return false; }
      if(!orderDetails || orderDetails.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderDetails); return false; }
      return true;
    }

    // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ø­Ø°ÙˆÙ - ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ addMaintenance)
    var addOrderBtn = document.getElementById('addOrderBtn');
    if(addOrderBtn) addOrderBtn.addEventListener('click', function(e){ if(!validateOrder()){ e.stopImmediatePropagation(); e.preventDefault(); } }, true);

    function togglePartFields(selectElId, containerId){
      var sel = document.getElementById(selectElId);
      var container = document.getElementById(containerId);
      if(!sel || !container) return;
      sel.addEventListener('change', function(){
        var required = sel.value === 'yes';
        Array.from(container.querySelectorAll('input')).forEach(function(inp){
          if(required) inp.setAttribute('required','required'); else inp.removeAttribute('required');
        });
        container.style.display = required ? 'block' : 'none';
      });
    }
    togglePartFields('partChanged','partFieldsContainer');
    togglePartFields('mainPartChanged','mainPartFieldsContainer');
  })();
</script>
<!-- Success toast (centered) -->
<style>
  .success-toast{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .18s ease;z-index:9999}
  .success-toast.show{opacity:1;pointer-events:auto}
  .success-box{background:rgba(255,255,255,0.98);padding:18px 22px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,0.15);min-width:220px;max-width:90%;direction:rtl;text-align:center}
  .check-circle{width:48px;height:48px;border-radius:50%;background:#28a745;display:flex;align-items:center;justify-content:center;flex:0 0 48px}
  .check-circle svg{width:24px;height:24px;fill:#fff}
  .success-text{font-size:16px;color:#08365F;font-weight:600;white-space:pre-wrap;line-height:1.6}
  @media (max-width:480px){ .success-box{padding:12px 14px} .success-text{font-size:15px} .check-circle{width:44px;height:44px} }
</style>
<div id="successToast" class="success-toast" role="status" aria-live="polite" aria-hidden="true">
  <div class="success-box">
    <div class="check-circle" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.00039 16.2L4.80039 12L3.40039 13.4L9.00039 19L21.0004 7L19.6004 5.6L9.00039 16.2Z"/></svg>
    </div>
    <div id="successToastMsg" class="success-text">ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</div>
  </div>
</div>
<script>
  (function(){
    var toast = document.getElementById('successToast');
    var toastMsg = document.getElementById('successToastMsg');
    var hideTimer = null;
    function hide(){ if(!toast) return; toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } }
    window.showSuccess = function(msg){
      if(!toast) return; toastMsg.textContent = msg || 'ØªÙ…'; toast.classList.add('show'); toast.setAttribute('aria-hidden','false');
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(function(){ hide(); }, 4000); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø© Ù…Ù† 1600ms Ø¥Ù„Ù‰ 4000ms (4 Ø«ÙˆØ§Ù†)
    };
    // allow click to dismiss
    toast.addEventListener('click', function(){ hide(); });
  })();
</script>
<script>
  (function(){
    const btn = document.getElementById('printMaintenanceSummaryBtn');
    if(!btn) return;
    // replace existing listeners by cloning the button
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.addEventListener('click', function(){
      const maint = (typeof maintenance !== 'undefined' ? maintenance : []).filter(m => !m.deleted);
      const totalMaint = maint.length;
      const maintByGroup = {};
      maint.forEach(m => {
        const group = m.line || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if(!maintByGroup[group]) maintByGroup[group] = [];
        maintByGroup[group].push({ machine: m.machine, type: m.type });
      });
      Object.keys(maintByGroup).forEach(group => {
        const machines = {};
        maintByGroup[group].forEach(item => {
          if(!machines[item.machine]) machines[item.machine] = {};
          if(!machines[item.machine][item.type]) machines[item.machine][item.type] = 0;
          machines[item.machine][item.type]++;
        });
        maintByGroup[group] = machines;
      });

      const orderedGroups = Object.keys(MACHINE_GROUPS).concat(Object.keys(maintByGroup).filter(g => !Object.keys(MACHINE_GROUPS).includes(g)));

      const style = `<style>body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:24px}.summary-title{color:#0A4C88;text-align:center;font-size:22px;font-weight:700;margin-bottom:8px}.summary-desc{text-align:center;color:#444;font-size:14px;margin-bottom:8px}.summary-date{text-align:center;color:#666;margin-bottom:12px}.summary-total{background:#e8f7e8;color:#00796b;padding:10px;border-radius:6px;text-align:center;font-weight:700;margin-bottom:12px}.group-section{margin-bottom:20px}.group-title{background:#0A4C88;color:#fff;padding:10px;border-radius:8px;text-align:center;margin-bottom:12px}.cards-wrap{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}.summary-card{background:#fff;border-radius:8px;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center}.card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}.card-type{font-size:15px;color:#0077b6;margin-bottom:8px}.card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}.footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}</style>`;

      let html = `<html dir="rtl"><head><meta charset="utf-8"><title>Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø©</title>${style}</head><body>`;
      html += `<div class="summary-title">Ù…Ù„Ø®Øµ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</div>`;
      html += `<div class="summary-desc">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆØ¶Ø­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙ…Ø§ÙƒÙŠÙ†Ø§ØªÙ‡Ø§ ÙˆØ£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</div>`;
      html += `<div class="summary-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString()}</div>`;
      html += `<div class="summary-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©: ${totalMaint.toLocaleString('ar-EG')}</div>`;

      orderedGroups.forEach(group => {
        if(!maintByGroup[group]) return;
        const machines = maintByGroup[group];
        html += `<div class="group-section"><div class="group-title">${group}</div><div class="cards-wrap">`;
        Object.entries(machines).forEach(([machine, typesObj]) => {
          Object.entries(typesObj).forEach(([type, count]) => {
            html += `<div class="summary-card"><div class="card-title">${escapeHtml(machine)}</div><div class="card-type">${escapeHtml(type)}</div><div class="card-count">${count.toLocaleString('ar-EG')}</div></div>`;
          });
        });
        html += `</div></div>`;
      });

      html += `<div style="text-align:center;color:#888;margin-top:18px;font-size:13px">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</div>`;
      html += `</body></html>`;
      const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
    });
  })();

  /* ============ ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø© ============ */
  let editingCatalogId = null;

  document.getElementById('addCatalogBtn').addEventListener('click', ()=>{ 
    if(editingCatalogId) return saveEditCatalog(); 
    addCatalog();
  });
  document.getElementById('clearCatalogBtn').addEventListener('click', clearCatalogForm);
  document.getElementById('applyCatalogFilterBtn').addEventListener('click', applyCatalogFilters);
  document.getElementById('clearCatalogFilterBtn').addEventListener('click', ()=>{ 
    document.getElementById('searchCatalog').value=''; 
    applyCatalogFilters(); 
  });
  document.getElementById('searchCatalog').addEventListener('input', applyCatalogFilters);
  document.getElementById('exportCatalogCsv').addEventListener('click', exportCatalogCsv);
  document.getElementById('printCatalogCurrentPage').addEventListener('click', printCatalogCurrentPage);
  document.getElementById('printCatalogAll').addEventListener('click', printCatalogAll);

  function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
  function getTodayDate(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function saveCatalogData(){ localStorage.setItem('catalog_v1',JSON.stringify(catalog)); localStorage.setItem('catalog_trash',JSON.stringify(catalogTrash)); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function displayValue(value){ const v=String(value||'').trim(); return !v||v==='undefined'||v==='null'?'<span style="color:#999">â€”</span>':escapeHtml(v); }
  function fixUrl(url){ const u = String(url||'').trim(); if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; if(/^www\./i.test(u)) return 'https://' + u; if(u.includes('.') && !u.includes(' ')) return 'https://' + u; return u; }

  function clearCatalogForm(){ 
    editingCatalogId=null; 
    document.getElementById('catalogMachine').value=''; 
    document.getElementById('catalogDescription').value=''; 
    document.getElementById('catalogUrl').value=''; 
    document.getElementById('addCatalogBtn').innerText='Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ù„ÙˆØ¬'; 
  }

  function addCatalog(){
    const machine = document.getElementById('catalogMachine').value.trim();
    const description = document.getElementById('catalogDescription').value.trim();
    const url = document.getElementById('catalogUrl').value.trim();

    if(!machine){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©'); return; }

    const item = {
      id: uid(),
      machine: machine,
      description: description,
      url: url
    };

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ kind: 'catalog', op: 'add', data: item })
    }).then(r => r.json())
      .then(res => {
        if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒØ§ØªØ§Ù„ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
      }).catch(err => {
        console.error(err);
        alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
      });

    catalog.unshift(item);
    saveCatalogData();
    clearCatalogForm();
    currentPageCatalog = 1;
    renderCatalogTable();
    notifyAction('catalog_added', 'catalog', item.machine);
    showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    try{ if(typeof enableEditFor === 'function') enableEditFor(item.id, 60*1000); }catch(e){}

    setTimeout(function() {
      showLatestCatalogNotification();
    }, 500);
  }

  function startEditCatalog(id){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ØŸ')) return;
    const item = catalog.find(x=>x.id===id);
    if(!item) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    editingCatalogId = id;
    document.getElementById('catalogMachine').value = item.machine;
    document.getElementById('catalogDescription').value = item.description;
    document.getElementById('catalogUrl').value = item.url;
    document.getElementById('addCatalogBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  }

  function saveEditCatalog(){
    const idx = catalog.findIndex(x=>x.id===editingCatalogId);
    if(idx===-1) return alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');

    catalog[idx].machine = document.getElementById('catalogMachine').value.trim();
    catalog[idx].description = document.getElementById('catalogDescription').value.trim();
    catalog[idx].url = document.getElementById('catalogUrl').value.trim();

    const item = catalog[idx];
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ kind: 'catalog', op: 'update', data: item })
    }).then(r=>r.json())
      .then(res => {
        if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
      })
      .catch(err => console.error('catalog update error', err));

    editingCatalogId = null;
    clearCatalogForm();
    renderCatalogTable();
    notifyAction('catalog_edited', 'catalog', item.machine);
    showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  }

  function moveToTrashCatalog(id){
    const item = catalog.find(x=>x.id===id);
    if(!item) return;

    item.deleted = true;
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ kind: 'catalog', op: 'update', data: item })
    }).then(r=>r.json())
      .then(res => {
        if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
      })
      .catch(err => console.error('catalog move to trash error', err));

    const idx = catalog.findIndex(x=>x.id===id);
    if(idx !== -1) {
      const deletedItem = catalog.splice(idx,1)[0];
      catalogTrash.unshift(deletedItem);
      saveCatalogData();
      renderCatalogTable();
      renderTrash();
      notifyAction('catalog_deleted', 'catalog', deletedItem.machine);
      showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
    }
  }

  function deleteCatalog(id){
    moveToTrashCatalog(id);
  }

  function restoreCatalog(id){
    const item = catalogTrash.find(x=>x.id===id);
    if(!item) return;

    item.deleted = false;
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ kind: 'catalog', op: 'update', data: item })
    }).then(r=>r.json())
      .then(res => {
        if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      })
      .catch(err => console.error('catalog restore error', err));

    const idx = catalogTrash.findIndex(x=>x.id===id);
    if(idx !== -1) {
      catalog.unshift(catalogTrash.splice(idx,1)[0]);
      saveCatalogData();
      renderCatalogTable();
      renderTrash();
    }
  }

  function permanentDeleteCatalog(id){
    const idx = catalogTrash.findIndex(x=>x.id===id);
    if(idx===-1) return;
    if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
    stopTrashSync();

    catalogTrash.splice(idx,1);
    saveCatalogData();
    renderTrash();
    console.log('âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØ§ØªØ§Ù„ÙˆØ¬ Ù…Ø­Ù„ÙŠÙ‹Ø§:', id);

    apiPost({ kind: 'catalog', op: 'delete', data: { id } })
      .then(res => {
        console.log('âœ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', res);
        if(res.ok || (res.json && res.json.ok)) console.log('âœ“ ØªÙ… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
        else console.warn('âš  Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø­Ø°Ù:', res.text || res.statusText);
      })
      .catch(err => console.error('âš  Ø®Ø·Ø£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', err))
      .finally(() => startTrashSync());
  }

  function renderCatalogTable(){
    const tbody = document.querySelector('#catalogTable tbody');
    tbody.innerHTML = '';
    const cardsDiv = document.getElementById('catalogCards');
    cardsDiv.innerHTML = '';

    const reversed = catalog.slice().reverse();
    const pageSize = 10;
    const start = (currentPageCatalog - 1) * pageSize;
    const end = start + pageSize;
    const items = reversed.slice(start, end);
    const totalPages = Math.ceil(reversed.length / pageSize);

    items.forEach((item, idx)=>{
      const num = (currentPageCatalog - 1) * pageSize + idx + 1;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${num}</td><td>${escapeHtml(item.machine)}</td><td>${escapeHtml(item.description)}</td><td><a href="${fixUrl(item.url)}" target="_blank">${item.url?'ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·':'â€”'}</a></td><td class="no-print actions"><button class="btn ghost" onclick="confirmEditAndRun('startEditCatalog','${item.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="confirmPasswordAndRun('deleteCatalog','${item.id}')">Ø­Ø°Ù</button></td>`;
      tbody.appendChild(tr);

      const card = document.createElement('div');
      card.className = 'order-card';
      card.innerHTML = `
        <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${num} - ${escapeHtml(item.machine)}</div>
        <div class="order-card-row"><div class="order-card-label">Ø§Ù„ÙˆØµÙ:</div><div class="order-card-value">${displayValue(item.description)}</div></div>
        <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ø±Ø§Ø¨Ø·:</div><div class="order-card-value">${item.url?'<a href="'+fixUrl(item.url)+'" target="_blank">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>':'â€”'}</div></div>
        <div class="order-card-actions">
          <button class="btn ghost" onclick="confirmEditAndRun('startEditCatalog','${item.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn" onclick="confirmPasswordAndRun('deleteCatalog','${item.id}')">Ø­Ø°Ù</button>
        </div>
      `;
      cardsDiv.appendChild(card);
    });

    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination
    const paginationDiv = document.getElementById('catalogPagination');
    paginationDiv.innerHTML = '';
    if(totalPages > 1){
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn ghost';
      prevBtn.textContent = 'Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©';
      prevBtn.disabled = currentPageCatalog === 1;
      prevBtn.onclick = ()=>{ currentPageCatalog--; renderCatalogTable(); };
      paginationDiv.appendChild(prevBtn);

      const pageSpan = document.createElement('span');
      pageSpan.style.cssText = 'margin:0 8px;display:inline-block;color:#666';
      pageSpan.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPageCatalog} Ù…Ù† ${totalPages}`;
      paginationDiv.appendChild(pageSpan);

      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn ghost';
      nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠØ©';
      nextBtn.disabled = currentPageCatalog === totalPages;
      nextBtn.onclick = ()=>{ currentPageCatalog++; renderCatalogTable(); };
      paginationDiv.appendChild(nextBtn);
    }
  }

  function applyCatalogFilters(){
    const q = (document.getElementById('searchCatalog').value||'').toLowerCase();
    document.querySelectorAll('#catalogTable tbody tr').forEach(tr=>{
      const text = tr.innerText.toLowerCase();
      tr.style.display = !q || text.includes(q) ? '' : 'none';
    });

    document.querySelectorAll('#catalogCards .order-card').forEach(card=>{
      const text = card.innerText.toLowerCase();
      card.style.display = !q || text.includes(q) ? '' : 'none';
    });
  }

  function exportCatalogCsv(){
    const visibleRows = Array.from(document.querySelectorAll('#catalogTable tbody tr')).filter(tr=>tr.style.display!=='none');
    if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }

    let csv = '"#","Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©","Ø§Ù„ÙˆØµÙ","Ø§Ù„Ø±Ø§Ø¨Ø·"\n';
    visibleRows.forEach((tr,i)=>{
      const cells = tr.querySelectorAll('td');
      csv += `"${i+1}","${cells[1].textContent}","${cells[2].textContent}","${cells[3].textContent}"\n`;
    });

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `catalog_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  }

  function printCatalogCurrentPage(){
    const visibleRows = Array.from(document.querySelectorAll('#catalogTable tbody tr')).filter(tr=>tr.style.display!=='none');
    if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù…Ø¹ÙƒÙˆØ³ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ visibleRows
    const sortedRows = visibleRows.slice().reverse();

    let html = `<html dir="rtl"><head><meta charset="utf-8"><title>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø©</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
    html += `<div style="text-align:center"><h2>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
    html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th></tr></thead><tbody>`;

    sortedRows.forEach((tr,i)=>{
      const cells = tr.querySelectorAll('td');
      const linkElement = cells[3].querySelector('a');
      const linkUrl = linkElement ? linkElement.href : '';
      html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(linkUrl)}</td></tr>`;
    });

    html += '</tbody></table></body></html>';
    const w = window.open('','_blank');
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),400);
  }

  function printCatalogAll(){
    if(!catalog.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø« (Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ)
    const sortedCatalog = catalog.slice().reverse();

    let html = `<html dir="rtl"><head><meta charset="utf-8"><title>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø©</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
    html += `<div style="text-align:center"><h2>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„ØµÙŠØ§Ù†Ø© - ÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
    html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th></tr></thead><tbody>`;

    sortedCatalog.forEach((item,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(item.machine)}</td><td>${escapeHtml(item.description)}</td><td>${escapeHtml(item.url)}</td></tr>`;
    });

    html += '</tbody></table></body></html>';
    const w = window.open('','_blank');
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),400);
  }

  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ù†Ø¯Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ
  renderCatalogTable();

</script>

<!-- Password confirmation modal for delete actions -->
<div id="passwordModalOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pwdModalTitle">
    <h3 id="pwdModalTitle">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
    <div class="modal-row">
      <div class="pwd-toggle">
        <input id="deletePasswordInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <span class="eye-icon" onclick="togglePassword('deletePasswordInput')">ğŸ‘ï¸</span>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost btn" onclick="cancelPasswordModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-primary btn" onclick="submitPassword()">ØªØ£ÙƒÙŠØ¯</button>
    </div>
    
  </div>
</div>

<script>
  // pending actions stored until password validated
  let _pendingDeleteAction = null;
  let _pendingEditAction = null;
  const _DELETE_PWD_KEY = 'appDeletePassword';

  // Open delete-password modal for deletion actions
  function confirmPasswordAndRun(fnName, id){
    _pendingDeleteAction = { fnName: fnName, id: id };
    const overlay = document.getElementById('passwordModalOverlay');
    document.getElementById('deletePasswordInput').value = '';
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=>document.getElementById('deletePasswordInput').focus(),50);
  }

  // Wrapper for edit actions: if editing window active, call immediately,
  // otherwise prompt for password (reuses same password modal).
  function confirmEditAndRun(fnName, id){
    try{
      try{
        const mapJson = localStorage.getItem('editAllowedUntilMap') || '{}';
        const map = JSON.parse(mapJson || '{}');
        const until = parseInt(map[id] || '0', 10);
        if(Date.now() <= until){
          const fn = window[fnName];
          if(typeof fn === 'function') { fn(id); return; }
        }
      }catch(e){}
    }catch(e){}
    _pendingEditAction = { fnName: fnName, id: id };
    const overlay = document.getElementById('passwordModalOverlay');
    document.getElementById('deletePasswordInput').value = '';
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=>document.getElementById('deletePasswordInput').focus(),50);
  }

  function cancelPasswordModal(){
    _pendingDeleteAction = null;
    const overlay = document.getElementById('passwordModalOverlay');
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden','true');
  }

  function submitPassword(){
    const entered = document.getElementById('deletePasswordInput').value || '';
    const stored = localStorage.getItem(_DELETE_PWD_KEY) || 'CBE@2026';
    if(entered === stored){
      // Prefer edit action if present
      if(_pendingEditAction){
        const action = _pendingEditAction;
        _pendingEditAction = null;
        cancelPasswordModal();
        try{ if(typeof window.enableEditFor === 'function') window.enableEditFor(action.id, 5*60*1000); }catch(e){ console.error(e); }
        const fn = window[action.fnName];
        const id = action.id;
        if(typeof fn === 'function'){
          try{ fn(id); }catch(e){ console.error('error executing edit action', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØªØ­ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„'); }
        } else {
          console.error('function not found', action);
          alert('Ø®Ø·Ø£: Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }
        return;
      }

      // Otherwise handle delete action
      const action = _pendingDeleteAction;
      _pendingDeleteAction = null;
      cancelPasswordModal();
      if(action){
        const fn = window[action.fnName];
        const id = action.id;
        if(typeof fn === 'function'){
          try{ fn(id); }catch(e){ console.error('error executing delete action', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù'); }
        } else {
          console.error('function not found', action);
          alert('Ø®Ø·Ø£: Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø°Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }
      }
    } else {
      alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    }
  }

  // Helper to allow programmatic calls (for example: confirmPasswordAndRun('emptyTrashAll'))
  // If you want to change the default password, run in Console:
  // localStorage.setItem('appDeletePassword','newpass')

  function togglePassword(inputId){
    const input = document.getElementById(inputId);
    if(input.type === 'password'){
      input.type = 'text';
    } else {
      input.type = 'password';
    }
  }
</script>

<!-- Change delete-password modal and handlers -->
<div id="changePwdModalOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="changePwdTitle">
    <h3 id="changePwdTitle">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù</h3>
    <p style="font-size:12px;color:#666;margin:8px 0">Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</p>
    <div class="modal-row">
      <label style="display:block;margin-bottom:6px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <div class="pwd-toggle">
        <input id="currentDeletePwd" type="password" placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" />
        <span class="eye-icon" onclick="togglePassword('currentDeletePwd')">ğŸ‘ï¸</span>
      </div>
    </div>
    <div class="modal-row">
      <label style="display:block;margin-top:10px;margin-bottom:6px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
      <div class="pwd-toggle">
        <input id="newDeletePwd" type="password" placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
        <span class="eye-icon" onclick="togglePassword('newDeletePwd')">ğŸ‘ï¸</span>
      </div>
    </div>
    <div class="modal-row">
      <label style="display:block;margin-top:10px;margin-bottom:6px">Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
      <div class="pwd-toggle">
        <input id="confirmDeletePwd" type="password" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
        <span class="eye-icon" onclick="togglePassword('confirmDeletePwd')">ğŸ‘ï¸</span>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost btn" onclick="cancelChangePwdModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-primary btn" onclick="submitChangePassword()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>
    </div>

    <script>
      // Global helper to enable edit window for a duration (ms) per-item
      (function(){
        const EDIT_MAP_KEY = 'editAllowedUntilMap';
        window._editExpireTimers = window._editExpireTimers || {};
        window.enableEditFor = function(id, ms){
          try{
            if(!id) return;
            const mapJson = localStorage.getItem(EDIT_MAP_KEY) || '{}';
            const map = JSON.parse(mapJson || '{}');
            const newUntil = Date.now() + (ms||0);
            map[id] = newUntil;
            localStorage.setItem(EDIT_MAP_KEY, JSON.stringify(map));
            if(window._editExpireTimers[id]) clearTimeout(window._editExpireTimers[id]);
            const remaining = newUntil - Date.now();
            if(remaining > 0){
              window._editExpireTimers[id] = setTimeout(function(){
                try{ showNotification('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„','Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù. Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'); }catch(e){}
                try{
                  const m = JSON.parse(localStorage.getItem(EDIT_MAP_KEY) || '{}');
                  delete m[id];
                  localStorage.setItem(EDIT_MAP_KEY, JSON.stringify(m));
                }catch(e){}
                delete window._editExpireTimers[id];
              }, remaining);
            }
            try{ showNotification('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØ§Ø­', `ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„ØµÙ†Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù…Ø¯Ø© ${Math.round((ms||0)/1000)} Ø«Ø§Ù†ÙŠØ©`); }catch(e){}
            try{ showSuccess('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); }catch(e){}
          }catch(e){ console.error('enableEditFor error', e); }
        };
        // initialize timers on load if needed
        try{
          const map = JSON.parse(localStorage.getItem(EDIT_MAP_KEY) || '{}');
          Object.keys(map).forEach(id=>{
            try{
              const until = parseInt(map[id] || '0', 10);
              const rem = until - Date.now();
              if(rem > 0){
                window._editExpireTimers[id] = setTimeout(function(){
                  try{ showNotification('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„','Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù. Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'); }catch(e){}
                  try{
                    const m = JSON.parse(localStorage.getItem(EDIT_MAP_KEY) || '{}');
                    delete m[id];
                    localStorage.setItem(EDIT_MAP_KEY, JSON.stringify(m));
                  }catch(e){}
                  delete window._editExpireTimers[id];
                }, rem);
              } else {
                delete map[id];
              }
            }catch(e){}
          });
          localStorage.setItem(EDIT_MAP_KEY, JSON.stringify(map));
        }catch(e){ console.error('enableEditFor init error', e); }
      })();
    </script>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login System)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§)
  let LOGIN_CREDENTIALS = {
    'admin': 'admin123',
    '204733': '204733',
    '201256': '201256',
    '201415': '201415',
    '205616': '205616',
    '207478': '207478',
    '207487': '207487',
    '207053': '207053',
    '207533': '207533',
    '207070': '207070',
    '208568': '208568',
    '207252': '207252',
    '207081': '207081',
    '207106': '207106',
    '207230': '207230',
    '207097': '207097',
    '207061': '207061',
  };
  
  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage
  function loadSavedPasswords() {
    const savedPasswords = localStorage.getItem('app_saved_passwords');
    if (savedPasswords) {
      try {
        const parsedPasswords = JSON.parse(savedPasswords);
        // Ø¯Ù…Ø¬ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        LOGIN_CREDENTIALS = { ...LOGIN_CREDENTIALS, ...parsedPasswords };
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
      } catch(e) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', e);
      }
    }
  }
  
  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  loadSavedPasswords();
  
  // Ø§Ù„Ù…ÙØªØ§Ø­ Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  // Ù†Ø³ØªØ®Ø¯Ù… sessionStorage Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
  // sessionStorage ÙŠÙØ­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­
  const LOGIN_KEY = 'app_login_state';
  
  // ØªØ³Ø¬ÙŠÙ„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
  let PASSWORD_UPDATES_LOG = [];
  
  // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† localStorage
  function loadPasswordUpdatesLog() {
    const savedLog = localStorage.getItem('app_password_updates_log');
    if (savedLog) {
      try {
        PASSWORD_UPDATES_LOG = JSON.parse(savedLog);
        console.log('ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:', PASSWORD_UPDATES_LOG);
      } catch(e) {
        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', e);
        PASSWORD_UPDATES_LOG = [];
      }
    }
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  loadPasswordUpdatesLog();
  
  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹)
  window.getPasswordsList = function() {
    console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:');
    console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    const usernames = Object.keys(LOGIN_CREDENTIALS);
    usernames.forEach((username, index) => {
      console.log(`${index + 1}. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username} | ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${LOGIN_CREDENTIALS[username]}`);
    });
    console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    return LOGIN_CREDENTIALS;
  };
  
  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
  window.getPasswordUpdatesLog = function() {
    console.log('ğŸ“‹ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“‹ Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:');
    console.log('ğŸ“‹ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    PASSWORD_UPDATES_LOG.forEach((update, index) => {
      console.log(`${index + 1}. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${update.username}`);
      console.log(`   Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª: ${update.timestamp}`);
      console.log(`   ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${update.oldPassword}`);
      console.log(`   ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${update.newPassword}`);
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    });
    console.log('ğŸ“‹ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    return PASSWORD_UPDATES_LOG;
  };
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
    
    // Ø§ÙƒØªØ´Ø§Ù F5 - Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    // Ù„ÙƒÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù ØªØ£ÙƒØ¯ Ø£Ù† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ø§Ù„Ø¢Ù†
    let isLoginInProgress = false;
    
    // ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', function() {
        isLoginInProgress = true;
        setTimeout(() => {
          isLoginInProgress = false;
        }, 1000);
      });
    }
    
    // Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© (F5)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F5' && !isLoginInProgress) {
        sessionStorage.removeItem(LOGIN_KEY);
      }
    });
  });

  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = event.target;
    
    if (field.type === 'password') {
      field.type = 'text';
      icon.textContent = 'ğŸ™ˆ';
    } else {
      field.type = 'password';
      icon.textContent = 'ğŸ‘ï¸';
    }
  }

  // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function openChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'flex';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('changePasswordError').style.display = 'none';
    document.getElementById('changePasswordSuccess').style.display = 'none';
    document.getElementById('currentPassword').type = 'password';
    document.getElementById('newPassword').type = 'password';
    document.getElementById('confirmPassword').type = 'password';
    resetPasswordRequirements();
  }

  // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ù…ÙˆØ°Ø¬ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'none';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('changePasswordError').style.display = 'none';
    document.getElementById('changePasswordSuccess').style.display = 'none';
    resetPasswordRequirements();
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function updatePasswordRequirements() {
    const pwd = document.getElementById('newPassword').value;
    const reqLength = document.getElementById('req-length');
    const reqUpper = document.getElementById('req-upper');
    const reqLower = document.getElementById('req-lower');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');
    
    // ÙØ­Øµ Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (pwd.length >= 8) {
      reqLength.classList.remove('pwd-requirement-unmet');
      reqLength.classList.add('pwd-requirement-met');
      reqLength.textContent = 'âœ“ 8 characters minimum';
    } else {
      reqLength.classList.remove('pwd-requirement-met');
      reqLength.classList.add('pwd-requirement-unmet');
      reqLength.textContent = 'âœ— 8 characters minimum';
    }
    
    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø­Ø±Ù ÙƒØ¨ÙŠØ±
    if (/[A-Z]/.test(pwd)) {
      reqUpper.classList.remove('pwd-requirement-unmet');
      reqUpper.classList.add('pwd-requirement-met');
      reqUpper.textContent = 'âœ“ Uppercase letter (A-Z)';
    } else {
      reqUpper.classList.remove('pwd-requirement-met');
      reqUpper.classList.add('pwd-requirement-unmet');
      reqUpper.textContent = 'âœ— Uppercase letter (A-Z)';
    }
    
    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø­Ø±Ù ØµØºÙŠØ±
    if (/[a-z]/.test(pwd)) {
      reqLower.classList.remove('pwd-requirement-unmet');
      reqLower.classList.add('pwd-requirement-met');
      reqLower.textContent = 'âœ“ Lowercase letter (a-z)';
    } else {
      reqLower.classList.remove('pwd-requirement-met');
      reqLower.classList.add('pwd-requirement-unmet');
      reqLower.textContent = 'âœ— Lowercase letter (a-z)';
    }
    
    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù…
    if (/[0-9]/.test(pwd)) {
      reqNumber.classList.remove('pwd-requirement-unmet');
      reqNumber.classList.add('pwd-requirement-met');
      reqNumber.textContent = 'âœ“ Number (0-9)';
    } else {
      reqNumber.classList.remove('pwd-requirement-met');
      reqNumber.classList.add('pwd-requirement-unmet');
      reqNumber.textContent = 'âœ— Number (0-9)';
    }
    
    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø±Ù…Ø² Ø®Ø§Øµ
    if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd)) {
      reqSpecial.classList.remove('pwd-requirement-unmet');
      reqSpecial.classList.add('pwd-requirement-met');
      reqSpecial.textContent = 'âœ“ Special character (!@#$%^&*)';
    } else {
      reqSpecial.classList.remove('pwd-requirement-met');
      reqSpecial.classList.add('pwd-requirement-unmet');
      reqSpecial.textContent = 'âœ— Special character (!@#$%^&*)';
    }
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function resetPasswordRequirements() {
    ['req-length', 'req-upper', 'req-lower', 'req-number', 'req-special'].forEach(id => {
      const elem = document.getElementById(id);
      elem.classList.remove('pwd-requirement-met');
      elem.classList.add('pwd-requirement-unmet');
    });
    document.getElementById('req-length').textContent = 'âœ— 8 characters minimum';
    document.getElementById('req-upper').textContent = 'âœ— Uppercase letter (A-Z)';
    document.getElementById('req-lower').textContent = 'âœ— Lowercase letter (a-z)';
    document.getElementById('req-number').textContent = 'âœ— Number (0-9)';
    document.getElementById('req-special').textContent = 'âœ— Special character (!@#$%^&*)';
  }

  // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø³ØªÙ‚Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù)
  function saveNewPassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const errorDiv = document.getElementById('changePasswordError');
    const successDiv = document.getElementById('changePasswordSuccess');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const loginData = sessionStorage.getItem(LOGIN_KEY);
    if (!loginData) {
      errorDiv.textContent = 'âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
      errorDiv.style.display = 'block';
      return;
    }
    
    const parsedData = JSON.parse(loginData);
    const username = parsedData.username;
    const storedPassword = parsedData.password;
    
    // ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    console.log('ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', { username, storedPassword });
    console.log('ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:', currentPassword);
    console.log('ğŸ” Ù‡Ù„ ØªØ·Ø§Ø¨Ù‚ØªØŸ', storedPassword === currentPassword);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    if (!currentPassword) {
      errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
      errorDiv.style.display = 'block';
      return;
    }
    
    if (!newPassword) {
      errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
      errorDiv.style.display = 'block';
      return;
    }
    
    if (!confirmPassword) {
      errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
      errorDiv.style.display = 'block';
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (storedPassword !== currentPassword) {
      errorDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
      errorDiv.style.display = 'block';
      console.error('âŒ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: Ø§Ù„Ù…ØªÙˆÙ‚Ø¹=' + storedPassword + ' Ø§Ù„Ù…Ø¯Ø®Ù„=' + currentPassword);
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    if (newPassword === currentPassword) {
      errorDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©';
      errorDiv.style.display = 'block';
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯
    if (newPassword !== confirmPassword) {
      errorDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ Ù„Ø§ ØªØªØ·Ø§Ø¨Ù‚Ø§Ù†';
      errorDiv.style.display = 'block';
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const hasLength = newPassword.length >= 8;
    const hasUpper = /[A-Z]/.test(newPassword);
    const hasLower = /[a-z]/.test(newPassword);
    const hasNumber = /[0-9]/.test(newPassword);
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
    
    if (!hasLength || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
      errorDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø© ÙˆØ£Ø±Ù‚Ø§Ù… ÙˆØ±Ù…ÙˆØ² Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 8 Ø£Ø­Ø±Ù';
      errorDiv.style.display = 'block';
      return;
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const oldPassword = LOGIN_CREDENTIALS[username];
    LOGIN_CREDENTIALS[username] = newPassword;
    
    // Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ localStorage Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
    const savedPasswords = localStorage.getItem('app_saved_passwords');
    let passwordsToSave = savedPasswords ? JSON.parse(savedPasswords) : {};
    passwordsToSave[username] = newPassword;
    localStorage.setItem('app_saved_passwords', JSON.stringify(passwordsToSave));
    
    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ sessionStorage
    sessionStorage.setItem(LOGIN_KEY, JSON.stringify({
      username: username,
      password: newPassword,
      time: new Date().getTime()
    }));
    
    console.log('âœ… ØªÙ… Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ localStorage');
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
    const updateRecord = {
      username: username,
      timestamp: new Date().toLocaleString('ar-EG'),
      oldPassword: oldPassword,
      newPassword: newPassword,
      recordId: Date.now()
    };
    
    PASSWORD_UPDATES_LOG.push(updateRecord);
    
    // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ localStorage
    localStorage.setItem('app_password_updates_log', JSON.stringify(PASSWORD_UPDATES_LOG));
    
    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    console.log('ğŸ“‹ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:', PASSWORD_UPDATES_LOG);
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', {
      username: username,
      time: new Date().toLocaleString('ar-EG'),
      newPassword: newPassword
    });
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    successDiv.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ - Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    successDiv.style.display = 'block';
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    setTimeout(() => {
      sessionStorage.removeItem(LOGIN_KEY);
      console.log('ğŸ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
      window.location.reload();
    }, 2000);
  }
  
  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function checkLoginStatus() {
    const isLoggedIn = sessionStorage.getItem(LOGIN_KEY);
    const loginModal = document.getElementById('loginModal');
    const navButtons = document.querySelector('nav');
    const mainSection = document.querySelector('section');
    
    if (!isLoggedIn) {
      // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      if (loginModal) loginModal.style.display = 'flex';
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      if (navButtons) navButtons.style.display = 'none';
      if (mainSection) mainSection.style.display = 'none';
    } else {
      // Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„
      if (loginModal) loginModal.classList.add('hidden');
      if (navButtons) navButtons.style.display = 'flex';
      if (mainSection) mainSection.style.display = 'block';
      
      // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø®Ø±ÙˆØ¬ Ù„Ù„Ù€ header Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      addLogoutButton();
    }
  }
  
  // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function handleLogin(event) {
    event.preventDefault();
    
    const userCode = document.getElementById('userCode').value.trim();
    const userPassword = document.getElementById('userPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (LOGIN_CREDENTIALS[userCode] && LOGIN_CREDENTIALS[userCode] === userPassword) {
      // Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ sessionStorage
      // sessionStorage ÙŠÙØ­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­
      sessionStorage.setItem(LOGIN_KEY, JSON.stringify({
        username: userCode,
        password: userPassword,
        time: new Date().getTime()
      }));
      
      console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:', {
        username: userCode,
        password: userPassword,
        time: new Date().toLocaleString('ar-EG')
      });
      
      // Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      const loginModal = document.getElementById('loginModal');
      loginModal.style.display = 'none';
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
      const navButtons = document.querySelector('nav');
      const mainSection = document.querySelector('section');
      if (navButtons) navButtons.style.display = 'flex';
      if (mainSection) mainSection.style.display = 'block';
      
      // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('userCode').value = '';
      document.getElementById('userPassword').value = '';
      errorDiv.classList.remove('show');
      
      // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
      addLogoutButton();
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
      try {
        showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‘‹');
      } catch(e) {}
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
      setTimeout(() => {
        location.reload();
      }, 500);
      
    } else {
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
      errorDiv.classList.add('show');
      document.getElementById('userPassword').value = '';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 3000);
    }
  }
  
  // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  function logoutUser() {
    sessionStorage.removeItem(LOGIN_KEY);
    location.reload();
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù€ header
  function addLogoutButton() {
    const header = document.querySelector('header');
    if (!header) return;
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø²Ø± Ø®Ø±ÙˆØ¬ Ø³Ø§Ø¨Ù‚
    if (document.getElementById('logoutBtn')) return;
    
    // Ø¥Ù†Ø´Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø±
    let buttonContainer = document.getElementById('headerButtons');
    if (!buttonContainer) {
      buttonContainer = document.createElement('div');
      buttonContainer.id = 'headerButtons';
      buttonContainer.style.cssText = 'display:flex;gap:10px;margin-right:auto';
      header.appendChild(buttonContainer);
    }
    
    // Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const changePasswordBtn = document.createElement('button');
    changePasswordBtn.id = 'changePasswordBtn';
    changePasswordBtn.className = 'btn ghost';
    changePasswordBtn.style.cssText = 'background:#2196F3;color:#fff;cursor:pointer;padding:8px 10px;border-radius:6px;border:0;font-weight:600';
    changePasswordBtn.textContent = 'ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
    changePasswordBtn.onclick = openChangePasswordModal;
    buttonContainer.appendChild(changePasswordBtn);
    
    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    const logoutBtn = document.createElement('button');
    logoutBtn.id = 'logoutBtn';
    logoutBtn.className = 'btn ghost';
    logoutBtn.style.cssText = 'background:#e53935;color:#fff;cursor:pointer;padding:8px 10px;border-radius:6px;border:0;font-weight:600';
    logoutBtn.textContent = 'ğŸšª Ø®Ø±ÙˆØ¬';
    logoutBtn.onclick = logoutUser;
    buttonContainer.appendChild(logoutBtn);
  }
</script>

<script>
  function openChangePwdModal(){
    document.getElementById('currentDeletePwd').value = '';
    document.getElementById('newDeletePwd').value = '';
    document.getElementById('confirmDeletePwd').value = '';
    const ov = document.getElementById('changePwdModalOverlay');
    ov.classList.add('active'); ov.setAttribute('aria-hidden','false');
    setTimeout(()=>document.getElementById('currentDeletePwd').focus(),50);
  }
  function cancelChangePwdModal(){
    const ov = document.getElementById('changePwdModalOverlay');
    ov.classList.remove('active'); ov.setAttribute('aria-hidden','true');
  }
  function submitChangePassword(){
    const cur = document.getElementById('currentDeletePwd').value || '';
    const nw = document.getElementById('newDeletePwd').value || '';
    const cf = document.getElementById('confirmDeletePwd').value || '';
    const key = 'appDeletePassword';
    const stored = localStorage.getItem(key) || 'CBE@2026';
    
    if(cur !== stored){ 
      alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); 
      return; 
    }
    
    if(!nw || nw.length < 4){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ØµØ­ÙŠØ­Ø© (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)'); 
      return; 
    }
    
    if(nw !== cf){ 
      alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©'); 
      return; 
    }
    
    localStorage.setItem(key, nw);
    
    // ØªØ³Ø¬ÙŠÙ„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù
    console.log('ğŸ” ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù:', {
      time: new Date().toLocaleString('ar-EG'),
      oldPassword: stored,
      newPassword: nw
    });
    
    cancelChangePwdModal();
    alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
  }

  // wire the header button
  (function(){
    const btn = document.getElementById('changeDeletePasswordBtn');
    if(btn) btn.addEventListener('click', openChangePwdModal);
  })();
</script>

</body>
</html>
