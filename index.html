<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
<style>
  :root{--primary:#0A4C88;--accent:#08365F;--muted:#666}
  body{font-family:Arial, Tahoma, sans-serif;margin:0;background:#f4f6f8;color:#111}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  nav{display:flex;gap:6px;background:var(--accent);padding:8px}
  nav button{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
  nav button.active{background:#0d5aa2}
  section{padding:16px}
  .box{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.05);margin-bottom:12px}
  label{display:block;margin-top:8px;font-size:14px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  input[type="date"]{font-size:14px;color:#333;min-height:40px;padding:10px}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer}
  textarea{min-height:70px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.ghost{background:#eee;color:#111}
  .row{display:flex;gap:8px;align-items:center}
  .row .flex{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #ddd;padding:10px;text-align:right;vertical-align:top;min-height:40px}
  th{background:#0A4C88;color:#fff}
  .actions button{margin-left:6px}
  .status-okay{background:#c4f7c4}
  .status-working{background:#fff3b0}
  .status-wait-company{background:#ffd59e}
  .status-wait-part{background:#ffb4b4}
  #tiles{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tile{flex:1 1 140px;background:#fff;padding:10px;border-radius:6px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
  canvas{background:#fff;border-radius:6px;padding:8px}
  /* Responsive helpers */
  .table-responsive{overflow-x:auto}
  canvas{max-width:100%;height:auto}
  /* Mobile card view */
  .card-view{display:none;margin-bottom:12px;padding:8px}
  .fault-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .fault-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .fault-card-row:last-child{border-bottom:none}
  .fault-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .fault-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .fault-card-value.empty{color:#999;font-style:italic}
  .fault-card-actions{display:flex;gap:8px;margin-top:16px}
  .fault-card-actions button{flex:1;padding:8px;font-size:13px}
  .fault-card-actions button.btn{font-size:12px}
  .table-view{display:block}
  /* Order card styles */
  .order-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .order-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .order-card-row:last-child{border-bottom:none}
  .order-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .order-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .order-card-value.empty{color:#999;font-style:italic}
  .order-card-actions{display:flex;gap:8px;margin-top:16px}
  .order-card-actions button{flex:1;padding:8px;font-size:13px}
  .order-card-actions button.btn{font-size:12px}
  /* Status badge styling */
  .card-status-badge{display:inline-block;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;text-align:center;width:100%}

  @media (max-width:800px){
    header{padding:10px}
    header h1{font-size:16px}
    nav{flex-wrap:wrap}
    nav button{padding:6px 8px;font-size:14px}
    .row{flex-direction:column;align-items:stretch}
    .row .flex{order:99;height:0}
    .tile{flex:1 1 45%}
    .box{padding:10px}
    .table-responsive table{min-width:700px}
  }

  @media (max-width:600px){
    header h1{font-size:15px}
    nav button{font-size:13px;padding:6px}
    .tile{flex-basis:100%}
    .row .flex{display:block;height:auto}
    .row input[type="date"]{flex:1 !important;max-width:none !important;min-width:auto}
    /* Show cards on mobile, hide table */
    .table-view{display:none !important}
    .card-view{display:block !important}
  }
  
  @media (max-width:480px){
    .fault-card-label{flex:0 0 35%}
    .fault-card-actions button{font-size:11px;padding:5px}
    .row input[type="date"]{flex:0 0 45% !important;margin:4px}
    .row label{flex:0 0 100%;margin-bottom:4px;font-size:12px}
    .row button{flex:1;margin:4px 0}
  }
  @media print{
    nav,.no-print,.actions,.controls{display:none!important}
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
  <div style="font-size:13px;color:#fff">ÙˆØ¶Ø¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
</header>

<nav>
  <button id="navFaults">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</button>
  <button id="navMaintenance">Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
  <button id="navOrders">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</button>
  <button id="navAttendance">Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª</button>
  <button id="navTrash">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
  <button id="navDash">Dashboard</button>
</nav>

<section>
  <!-- FAULTS -->
  <div id="page_faults" class="page">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø·Ù„</h3>
      <div id="form">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="machineGroup">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <div id="machineItemContainer">
          <label style="margin-top:6px">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <select id="machineItem" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
          </select>
        </div>
        <div id="customMachineGroupContainer" style="display:none">
          <label style="margin-top:6px">Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMachinePlace" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
          <label style="margin-top:6px">Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMachineName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
        </div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="personToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="personChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="person" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>Ø­Ø³Ù† Ù…Ø³Ø¹Ø¯</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø¬ÙˆØ¯Ø©</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</option>
                  <option>Ø¹Ù„ÙŠ Ù…Ø±Ø³ÙŠ</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                </select>
        <label>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„</label><textarea id="description"placeholder="Ø´Ø±Ø­ ÙˆØµÙ  Ø§Ù„Ø¹Ø·Ù„"></textarea>
        <label>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</label><textarea id="solution" placeholder="Ø´Ø±Ø­ Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„"></textarea>
        <label>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label><select id="shift"><option>ØµØ¨Ø§Ø­ÙŠØ©</option><option>Ù…Ø³Ø§Ø¦ÙŠØ©</option><option>Ù„ÙŠÙ„ÙŠØ©</option></select>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date" />
        <label>Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±ØŸ</label>
        <select id="partChanged">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
        <div id="partFieldsContainer" style="display:none">
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number)</label><input id="lcode" />
          <label>Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input id="partName" placeholder="Ø£Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±" />
          <label>ÙƒÙ…ÙŠØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input type="number" id="partQty" min="0" value="0" />
        </div>
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„</label>
        <select id="status">
          <option>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button id="addBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„</button>
          <button class="btn ghost" id="clearBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportCsvAll">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportDocAll">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©ØŒ ÙˆØµÙØŒ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <input id="filterStatus" placeholder="ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)" style="width:220px;max-width:40%" />
        <button class="btn ghost" id="applyFiltersBtn">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="btn ghost" id="clearFiltersBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromFault" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToFault" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterFaultBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="faultTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="faultCards" class="card-view"></div>

      <div id="faultsPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF button placed below table as requested (B) -->
      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printPdfAll">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- MAINTENANCE -->
  <div id="page_maintenance" class="page" style="display:none">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ ØµÙŠØ§Ù†Ø©</h3>
      <div id="maintenanceForm">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
        <select id="mainGroup">
          <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
        </select>
        <div id="mainItemContainer">
          <label style="margin-top:6px">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <select id="mainItem" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
          </select>
        </div>
        <div id="customMainGroupContainer" style="display:none">
          <label style="margin-top:6px">Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMainPlace" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
          <label style="margin-top:6px">Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <input type="text" id="customMainName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" />
        </div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="mainPersonToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="mainPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="mainPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>KBA Egypt</option>
                  <option>CBE Team</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                  
                </select>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="mainDate" />
       <label>Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±ØŸ</label>
        <select id="mainPartChanged">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
        <div id="mainPartFieldsContainer" style="display:none">
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number)</label><input id="mainLcode" />
          <label>Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input id="mainPartName" placeholder="Ø§Ø³Ù… Ù‚Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±" />
          <label>ÙƒÙ…ÙŠØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input type="number" id="mainPartQty" min="0" value="0" />
        </div>
        <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
        <select id="mainType">
          <option>Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
          <option>Ø´Ù‡Ø±ÙŠØ©</option>
          <option>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
          <option>Ø³Ù†ÙˆÙŠØ©</option>
          <option>Ø·Ø§Ø±Ø¦Ø©</option>
        </select>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="mainNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ÙˆØµÙ Ø§Ù„ØµÙŠØ§Ù†Ø©"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addMaintenanceBtn">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©</button>
          <button class="btn ghost" id="clearMaintenanceBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportMaintenanceCsv">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportMaintenanceDoc">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchMaintenance" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyMaintenanceFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterMaintenanceBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="maintenanceTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="maintenanceCards" class="card-view"></div>

      <div id="maintenancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printMaintenanceBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- ORDERS -->
  <div id="page_orders" class="page" style="display:none">
    <div class="box">
      <h3>Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ / ØªÙˆØ±ÙŠØ¯</h3>
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="orderNum" />
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label><input id="supplyNum" />
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="orderDate" />
      <label>Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="orderPersonToggle" class="btn ghost" style="width:auto">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù…(ÙŠÙ†)</button>
          <div id="orderPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="orderPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…</option>
                  <option>Ø­Ø³Ù† Ù…Ø³Ø¹Ø¯</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø¬ÙˆØ¯Ø©</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</option>
                  <option>Ø¹Ù„ÙŠ Ù…Ø±Ø³ÙŠ</option>
                  <option>Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
                  <option>Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
                  <option>Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
                  <option>Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
                  <option>Ø§Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
                  <option>Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
                  <option>Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
                  <option>Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
                </select>
      <label>ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><textarea id="orderDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ ÙˆØµÙ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="addOrderBtn">Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±</button>
        <button class="btn ghost" id="clearOrderBtn">Ù…Ø³Ø­</button>
        <div class="flex"></div>
        <button class="btn" id="exportOrdersCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="exportOrdersDoc">ØªØµØ¯ÙŠØ± Word</button>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchOrder" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø± Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyOrderFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterOrderBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="orderTable">
        <thead><tr><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù…Ø±</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="orderCards" class="card-view"></div>

      <div id="ordersPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF button placed below table as requested (B) -->
      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printOrdersBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div id="page_attendance" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
      <div id="attendanceForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label>
        <select id="workerName">
          <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</option>
          <option value="Ø¹Ù…Ø± Ø­Ù…Ø²Ø©">Ø¹Ù…Ø± Ø­Ù…Ø²Ø©</option>
          <option value="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ">Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ</option>
          <option value="Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯">Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</option>
          <option value="Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡">Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡</option>
          <option value="Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„">Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„</option>
          <option value="Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±">Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±</option>
          <option value="Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ">Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ</option>
          <option value="Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ">Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ</option>
          <option value="Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯">Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯</option>
          <option value="Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…">Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…</option>
        </select>
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label><input id="workerNum" disabled />
        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="date" id="absenceDate" />
        <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="number" id="daysCount" min="1" value="1" />
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addAttendanceBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„</button>
          <button class="btn ghost" id="clearAttendanceBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportAttendanceCsv">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportAttendanceDoc">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchAttendance" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyAttendanceFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterAttendanceBtn" style="flex:0 0 auto;margin:0 4px">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="attendanceCards" class="card-view"></div>

      <div id="attendancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printAttendanceBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- TRASH -->
  <div id="page_trash" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h3>
      <div style="margin-bottom:8px">
        <button class="btn ghost" id="emptyTrashBtn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
      </div>
      <h4>Ø£Ø¹Ø·Ø§Ù„ Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashFaults"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø£ÙˆØ§Ù…Ø± Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashOrders"><thead><tr><th>Ø£Ù…Ø±</th><th>ØªÙˆØ±ÙŠØ¯</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashAttendance"><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ / Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashMaintenance"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="page_dash" class="page" style="display:none">
    <div id="tiles" style="margin-bottom:12px"></div>
    <input type="hidden" id="filterMaintenanceType" value="" />
    <div class="box" style="max-width:800px;margin:0 auto">
      <canvas id="pie" width="800" height="300"></canvas>
      <div style="margin-top:12px">
        <div class="table-responsive">
        <table id="dashTable" style="width:100%"><thead><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxWMv2GRW8wd4xAoi6X7N3jF781CxEUP2WQsF4_mb805GsAuXPOFsAo1fA5ZyRHlez5/exec';
/* storage keys */
const K_FAULTS='faults_v2_final', K_ORDERS='orders_v2_final', K_TRASH='trash_v2_final', K_ATT='attendance_v1', K_MAINTENANCE='maintenance_v1';
// worker name â†’ worker number mapping (persisted)
const K_WORKERS = 'worker_map_v1';
let WORKER_MAP = JSON.parse(localStorage.getItem(K_WORKERS) || '{}');
function saveWorkerMap(){ localStorage.setItem(K_WORKERS, JSON.stringify(WORKER_MAP)); }
// merge user-provided worker mappings (overwrite or add)
const NEW_WORKERS = {
  "Ø­Ø³Ù† Ø¨Ù‡Ø§Ø¡": "207487",
  "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø¯ÙŠÙˆÙŠ": "207070",
  "Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯": "207478",
  "Ø¹Ù…Ø± Ø­Ù…Ø²Ø©": "207053",
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆØ§Ø¦Ù„": "207533",
  "Ù…Ø­Ù…ÙˆØ¯ Ù†Ø§Ø¬ÙŠ": "207252",
  "Ø¥Ø³Ù„Ø§Ù… Ù…ØµØ·ÙÙŠ Ø³Ù…ÙŠØ±": "207081",
  "Ù…Ø­Ù…Ø¯ ØµØ¨Ø­ÙŠ": "207230",
  "Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯": "207097",
  "Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­ÙƒÙŠÙ…": "207106"
};
Object.assign(WORKER_MAP, NEW_WORKERS);
saveWorkerMap();

/* load */
let faults = JSON.parse(localStorage.getItem(K_FAULTS)||'[]');
let orders = JSON.parse(localStorage.getItem(K_ORDERS)||'[]');
let maintenance = JSON.parse(localStorage.getItem(K_MAINTENANCE)||'[]');
let trash = JSON.parse(localStorage.getItem(K_TRASH)||'{"faults":[],"orders":[],"attendance":[],"maintenance":[]}');
let attendance = JSON.parse(localStorage.getItem(K_ATT)||'[]');

// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† trash.maintenance Ù…ÙˆØ¬ÙˆØ¯Ø©
if(!trash.maintenance) trash.maintenance = [];

// ØªÙ†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø²Ø§Ø¦Ø¯
faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
maintenance.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
trash.faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
trash.orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
trash.maintenance?.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });

/* PAGINATION SETUP */
const ITEMS_PER_PAGE = 10;
let currentPageFaults = 1;
let currentPageOrders = 1;
let currentPageMaintenance = 1;
let currentPageAttendance = 1;

function getPaginatedData(data) {
  // Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø¢Ø®Ø± Ø¹Ù†ØµØ± Ø£ÙˆÙ„Ø§Ù‹)
  return data.slice().reverse();
}

function paginate(data, pageNum) {
  const reversed = getPaginatedData(data);
  const start = (pageNum - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  return {
    items: reversed.slice(start, end),
    totalPages: Math.ceil(reversed.length / ITEMS_PER_PAGE),
    totalItems: reversed.length,
    currentPage: pageNum
  };
}

function updatePaginationButtons(containerSelector, totalPages, currentPage, onPageChange) {
  const container = document.querySelector(containerSelector);
  if (!container) return;
  
  container.innerHTML = '';
  
  // Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
  const firstBtn = document.createElement('button');
  firstBtn.className = 'btn ghost';
  firstBtn.textContent = '|< Ø£ÙˆÙ„ ØµÙØ­Ø©';
  firstBtn.disabled = currentPage === 1;
  firstBtn.onclick = () => onPageChange(1);
  container.appendChild(firstBtn);
  
  // Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn ghost';
  prevBtn.textContent = '< Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => onPageChange(currentPage - 1);
  container.appendChild(prevBtn);
  
  // Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©
  const pageInfo = document.createElement('span');
  pageInfo.style.cssText = 'margin:0 8px;display:inline-block;color:#666';
  pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}`;
  container.appendChild(pageInfo);
  
  // Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn ghost';
  nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠØ© >';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => onPageChange(currentPage + 1);
  container.appendChild(nextBtn);
  
  // Ø²Ø±Ø§Ø± Ø¢Ø®Ø± ØµÙØ­Ø©
  const lastBtn = document.createElement('button');
  lastBtn.className = 'btn ghost';
  lastBtn.textContent = 'Ø¢Ø®Ø± ØµÙØ­Ø© >|';
  lastBtn.disabled = currentPage === totalPages;
  lastBtn.onclick = () => onPageChange(totalPages);
  container.appendChild(lastBtn);
}
attendance.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
trash.attendance?.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
saveAll();

/* Trash sync interval - declare early to avoid ReferenceError */
let trashSyncInterval = null;

/* ui refs */
const navFaults = document.getElementById('navFaults');
const navMaintenance = document.getElementById('navMaintenance');
const navOrders = document.getElementById('navOrders');
const navAttendance = document.getElementById('navAttendance');
const navTrash = document.getElementById('navTrash');
const navDash = document.getElementById('navDash');

navFaults.onclick = ()=>show('faults');
navMaintenance.onclick = ()=>show('maintenance');
navOrders.onclick = ()=>show('orders');
navAttendance.onclick = ()=>show('attendance');
navTrash.onclick = ()=>show('trash');
navDash.onclick = ()=>show('dash');

function show(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  if(page==='faults'){ document.getElementById('page_faults').style.display='block'; navFaults.classList.add('active'); stopTrashSync(); }
  if(page==='maintenance'){ document.getElementById('page_maintenance').style.display='block'; navMaintenance.classList.add('active'); stopTrashSync(); }
  if(page==='orders'){ document.getElementById('page_orders').style.display='block'; navOrders.classList.add('active'); stopTrashSync(); }
  if(page==='attendance'){ document.getElementById('page_attendance').style.display='block'; navAttendance.classList.add('active'); stopTrashSync(); }
  if(page==='trash'){ document.getElementById('page_trash').style.display='block'; navTrash.classList.add('active'); startTrashSync(); }
  if(page==='dash'){ document.getElementById('page_dash').style.display='block'; navDash.classList.add('active'); drawDashboard(); stopTrashSync(); }
}
show('faults');

/* helpers */
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getTodayDate(){ 
  const d = new Date(); 
  const year = d.getFullYear(); 
  const month = String(d.getMonth()+1).padStart(2,'0'); 
  const day = String(d.getDate()).padStart(2,'0'); 
  return `${year}-${month}-${day}`; 
}
function formatDateOnly(dateStr) {
  if (!dateStr) return '';
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙŠØºØ© YYYY-MM-DD ÙÙ‚Ø·ØŒ Ø£Ø±Ø¬Ø¹Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆÙ‚ØªØŒ Ø´ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
  return dateStr.split('T')[0].split(' ')[0];
}
function saveAll(){ 
  localStorage.setItem(K_FAULTS, JSON.stringify(faults)); 
  localStorage.setItem(K_ORDERS, JSON.stringify(orders)); 
  localStorage.setItem(K_MAINTENANCE, JSON.stringify(maintenance)); 
  localStorage.setItem(K_TRASH, JSON.stringify(trash)); 
  localStorage.setItem(K_ATT, JSON.stringify(attendance)); 
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£Ùˆ Dash Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
function getSelectedMachineLine(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return { machine: '', line: '' };
  const opt = sel.options[sel.selectedIndex];
  if(!opt) return { machine: '', line: '' };
  const machine = opt.text || '';
  const line = opt.parentElement && opt.parentElement.label ? opt.parentElement.label : '';
  return { machine: machine.trim(), line: line.trim() };
}

function setSelectMachineLine(selectId, machine, line){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  for(let i=0;i<sel.options.length;i++){
    const o = sel.options[i];
    const grp = o.parentElement && o.parentElement.label ? o.parentElement.label : '';
    if(o.text === (machine||'') && grp === (line||'')){
      sel.selectedIndex = i; return;
    }
  }
  // fallback: try match by machine text only
  for(let i=0;i<sel.options.length;i++) if(sel.options[i].text === (machine||'')){ sel.selectedIndex = i; return; }
  sel.selectedIndex = 0;
}

// -- Grouped selection support (group -> items)
const MACHINE_GROUPS = {
  "Ø®Ø· Ù¡": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¡","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¡","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¢","Ù†ÙˆØªØ§Ø³ÙƒØ±ÙŠÙ† Ù¡","ØªØ±Ù‚ÙŠÙ… Ù¡"],
  "Ø®Ø· Ù¢": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¢","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù£","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¤","Ù†ÙˆØªØ§Ø³ÙƒØ±ÙŠÙ† Ù¢","ØªØ±Ù‚ÙŠÙ… Ù¢"],
  "Ø®Ø· Ù£": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù£","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¥","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¦","Ø§ÙˆØ¨ØªÙŠ Ù†ÙˆØªØ§","ØªØ±Ù‚ÙŠÙ… Ù£"],
  "Ø®Ø· Ù¤": ["Ø³ÙŠÙ…ÙˆÙ„ØªØ§Ù† Ù¤","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù§","Ø§Ù†ØªØ§Ù„ÙŠÙˆ Ù¨","Foil SPM 140","ØªØ±Ù‚ÙŠÙ… Ù¤"],
  "ØªØ´Ø·ÙŠØ¨": ["BPS 1","BPS 2","Cutlink 1","Cutlink 2","Cutpak 1","Cutpak 2","Kallfas Shrink Offline 1","Kallfas Shrink Offline 2","Bars"],
  "Ø§Ù„ÙØ±Ù…": ["BDS 1","BDS 2","Silo 1","Silo 2"],
  "Ø§Ù„ØªØ¬Ù‡ÙŠØ²Ø§Øª": [
    "lathe machine 1","lathe machine 2","plastirota 1","plastirota 2","plastmix 1","plastmix 2",
    "plate grinding 1","plate grinding 2","plate coat 1","plate coat 2","pilfora lv","Plate Shear","plate Bright",
    "Ø­ÙˆØ¶ Ø§Ù„Ù†ÙŠÙƒÙ„ 1+ Rectifier 1","Ø­ÙˆØ¶ Ø§Ù„Ù†ÙŠÙƒÙ„ 2+ Rectifier 2","Ø­ÙˆØ¶ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ù„ØªÙ†Ø´ÙŠØ· + Rectifier 3","Ø¬Ù‡Ø§Ø² Ù†Ø²Ø¹ Ø§Ù„Ø§Ù…Ù„Ø§Ø­ Ù…Ù† Ø§Ù„Ù…ÙŠØ§Ù‡","scrubber",
    "CToP 1","CToP 2","PolyWash 1","PolyWash 2","PolyExpose 1","PolyExpose 2","Plate Bender","Plate Punch IV",
    "Vertical burning-in oven","Vertical drying cabinet","Gravograph 1","Gravograph 2","plate check","Mathemat digital","Ùˆ Ù…Ù„Ø­Ù‚Ø§ØªÙ‡ CTiP",
    "Galvano Lab","Ù‚Ø³Ù… Ø§Ù„Ø§Ø­Ø¨Ø§Ø±","tensiometer","microscopes","Plate Inspection","Ø§Ù„Ù„ÙˆØ±Ø¬ÙŠ","Ø­ÙˆØ¶ Ø§Ù„ØµÙŠØ§Ù†Ù‡","ÙˆØ­Ø¯Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ù‡","Mathemat digital 2","Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©"
  ],
  "Ø£Ø®Ø±ÙŠ": ["__custom__"]
};

function initGroupSelects(){
  const groups = Object.keys(MACHINE_GROUPS);
  const mg = document.getElementById('machineGroup');
  const mg2 = document.getElementById('mainGroup');
  if(mg){ mg.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg.appendChild(o); }); }
  if(mg2){ mg2.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg2.appendChild(o); }); }
}

function populateItemsForGroup(groupName, itemSelectId){
  const items = MACHINE_GROUPS[groupName] || [];
  const sel = document.getElementById(itemSelectId);
  if(!sel) return;
  
  // Ø­Ø¯Ø¯ Ø£ÙŠ Ø­Ø§ÙˆÙŠØ§Øª Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡Ø§
  let itemContainer = null;
  let customContainer = null;
  
  if(itemSelectId === 'machineItem') {
    itemContainer = document.getElementById('machineItemContainer');
    customContainer = document.getElementById('customMachineGroupContainer');
  } else if(itemSelectId === 'mainItem') {
    itemContainer = document.getElementById('mainItemContainer');
    customContainer = document.getElementById('customMainGroupContainer');
  }
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ø®ÙÙ select ÙˆØ§Ø¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(groupName === 'Ø£Ø®Ø±ÙŠ') {
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>';
    sel.disabled = true;
    if(itemContainer) itemContainer.style.display = 'none';
    if(customContainer) customContainer.style.display = 'block';
    // Ø§Ø¬Ø¹Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø± Ù…Ø·Ù„ÙˆØ¨Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ø£Ø®Ø±ÙŠ"
    const placeEl = document.getElementById('customMachinePlace');
    const nameEl = document.getElementById('customMachineName');
    if(placeEl) placeEl.setAttribute('required','required');
    if(nameEl) nameEl.setAttribute('required','required');
    return;
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø± select ÙˆØ¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(itemContainer) itemContainer.style.display = 'block';
  if(customContainer) customContainer.style.display = 'none';
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© ØµÙØ© required Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©
  const placeEl = document.getElementById('customMachinePlace');
  const nameEl = document.getElementById('customMachineName');
  if(placeEl) placeEl.removeAttribute('required');
  if(nameEl) nameEl.removeAttribute('required');
  
  if(!groupName || items.length===0){ sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>'; sel.disabled = true; return; }
  sel.disabled = false; sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>';
  items.forEach(it=>{ const o = document.createElement('option'); o.value = it; o.textContent = it; sel.appendChild(o); });
}

function getSelectedMachineLineFromGroups(groupId, itemId){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  const line = g ? (g.value||'') : '';
  let machine = it ? (it.value||'') : '';
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(line === 'Ø£Ø®Ø±ÙŠ') {
    if(itemId === 'machineItem') {
      const place = document.getElementById('customMachinePlace');
      const name = document.getElementById('customMachineName');
      machine = (name ? name.value.trim() : '');
      // Ø§Ø³ØªØ®Ø¯Ù… place ÙƒÙ€ machine Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø©
      if(place && place.value.trim()) {
        machine = place.value.trim() + ' - ' + machine;
      }
    } else if(itemId === 'mainItem') {
      const place = document.getElementById('customMainPlace');
      const name = document.getElementById('customMainName');
      machine = (name ? name.value.trim() : '');
      // Ø§Ø³ØªØ®Ø¯Ù… place ÙƒÙ€ machine Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø©
      if(place && place.value.trim()) {
        machine = place.value.trim() + ' - ' + machine;
      }
    }
  }
  
  return { machine: machine.trim(), line: line.trim() };
}

function setGroupSelection(groupId, itemId, machine, line){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  if(!g || !it) return;
  g.value = line || '';
  populateItemsForGroup(g.value, itemId);
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© "Ø£Ø®Ø±ÙŠ"ØŒ Ù„Ø§ ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  if(line === 'Ø£Ø®Ø±ÙŠ') {
    return;
  }
  
  if(machine){ for(let i=0;i<it.options.length;i++){ if(it.options[i].value === machine){ it.selectedIndex = i; break; } } }
}

document.addEventListener('DOMContentLoaded', function(){ initGroupSelects();
  document.getElementById('machineGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'machineItem'); });
  document.getElementById('mainGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'mainItem'); });
});

// Auto-fill worker number when a worker name is selected in attendance
document.addEventListener('DOMContentLoaded', function(){
  const workerNameSelect = document.getElementById('workerName');
  const workerNumInput = document.getElementById('workerNum');
  if(!workerNameSelect) return;
  
  // Function to update worker number based on selected name
  function updateWorkerNum(){
    const name = (workerNameSelect.value||'').trim();
    if(!name) {
      if(workerNumInput) workerNumInput.value = '';
      return;
    }
    // Look up in WORKER_MAP
    if(WORKER_MAP[name]){
      if(workerNumInput) workerNumInput.value = WORKER_MAP[name];
    } else {
      // If not found, clear it
      if(workerNumInput) workerNumInput.value = '';
    }
  }
  
  // Update on change
  workerNameSelect.addEventListener('change', updateWorkerNum);
  
  // Initialize on page load
  updateWorkerNum();
});

// --- Multi-select hidden UI helpers (person & mainPerson)
function getSelectedValues(selectId){
  const sel = document.getElementById(selectId); if(!sel) return []; return Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v && v.trim());
}
function setMultiSelectValues(selectId, csvOrArray){
  const sel = document.getElementById(selectId); if(!sel) return;
  let arr = [];
  if(Array.isArray(csvOrArray)) arr = csvOrArray;
  else if(typeof csvOrArray === 'string' && csvOrArray.trim() !== '') arr = csvOrArray.split(',').map(s=>s.trim()).filter(Boolean);
  for(let i=0;i<sel.options.length;i++){ sel.options[i].selected = arr.includes(sel.options[i].value); }
}
function renderSelectedChips(selectId, chipsId){
  const sel = document.getElementById(selectId); const cont = document.getElementById(chipsId); if(!sel || !cont) return; cont.innerHTML='';
  const vals = getSelectedValues(selectId);
  if(vals.length===0){ cont.innerHTML = '<span class="empty">â€”</span>'; return; }
  vals.forEach(v=>{
    const span = document.createElement('span'); span.className='chip'; span.style.cssText='display:inline-block;background:#eef;padding:4px 8px;border-radius:12px;margin:2px;font-size:13px';
    span.textContent = v;
    const rem = document.createElement('button'); rem.type='button'; rem.textContent='âœ•'; rem.style.cssText='background:transparent;border:0;color:#900;cursor:pointer;margin-left:6px';
    rem.addEventListener('click', ()=>{ for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value===v){ sel.options[i].selected=false; break; } } renderSelectedChips(selectId,chipsId); });
    span.appendChild(rem);
    cont.appendChild(span);
  });
}

document.addEventListener('DOMContentLoaded', function(){
  // Toggle button for showing/hiding part fields
  const partChangedSelect = document.getElementById('partChanged');
  const partFieldsContainer = document.getElementById('partFieldsContainer');
  
  if(partChangedSelect && partFieldsContainer) {
    // Function to toggle part fields visibility
    function togglePartFields() {
      partFieldsContainer.style.display = partChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    partChangedSelect.addEventListener('change', togglePartFields);
    
    // Initialize on page load
    togglePartFields();
  }

  // Toggle button for showing/hiding maintenance part fields
  const mainPartChangedSelect = document.getElementById('mainPartChanged');
  const mainPartFieldsContainer = document.getElementById('mainPartFieldsContainer');
  
  if(mainPartChangedSelect && mainPartFieldsContainer) {
    // Function to toggle part fields visibility
    function toggleMainPartFields() {
      mainPartFieldsContainer.style.display = mainPartChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    mainPartChangedSelect.addEventListener('change', toggleMainPartFields);
    
    // Initialize on page load
    toggleMainPartFields();
  }
  
  // toggle buttons â€” show/hide select and update chips after change
  const personToggle = document.getElementById('personToggle');
  const mainPersonToggle = document.getElementById('mainPersonToggle');
  const personSel = document.getElementById('person');
  const mainPersonSel = document.getElementById('mainPerson');
  const orderPersonToggle = document.getElementById('orderPersonToggle');
  const orderPersonSel = document.getElementById('orderPerson');

  personToggle?.addEventListener('click', function(){
    if(!personSel) return;
    personSel.style.display = (personSel.style.display==='none'?'block':'none');
    if(personSel.style.display!=='none') personSel.focus();
    // update chips to reflect current selection whenever the list is toggled
    renderSelectedChips('person','personChips');
  });

  mainPersonToggle?.addEventListener('click', function(){
    if(!mainPersonSel) return;
    mainPersonSel.style.display = (mainPersonSel.style.display==='none'?'block':'none');
    if(mainPersonSel.style.display!=='none') mainPersonSel.focus();
    renderSelectedChips('mainPerson','mainPersonChips');
  });

  // order person toggle/listeners
  orderPersonToggle?.addEventListener('click', function(){
    if(!orderPersonSel) return;
    orderPersonSel.style.display = (orderPersonSel.style.display==='none'?'block':'none');
    if(orderPersonSel.style.display!=='none') orderPersonSel.focus();
    renderSelectedChips('orderPerson','orderPersonChips');
  });

  // update chips live when the user changes selection inside the hidden multi-select
  personSel?.addEventListener('change', function(){
    renderSelectedChips('person','personChips');
    // hide the multi-select after selection to keep UI compact
    personSel.style.display = 'none';
  });
  mainPersonSel?.addEventListener('change', function(){
    renderSelectedChips('mainPerson','mainPersonChips');
    mainPersonSel.style.display = 'none';
  });
  orderPersonSel?.addEventListener('change', function(){
    renderSelectedChips('orderPerson','orderPersonChips');
    orderPersonSel.style.display = 'none';
  });

  // render initial chips
  renderSelectedChips('person','personChips');
  renderSelectedChips('mainPerson','mainPersonChips');
  renderSelectedChips('orderPerson','orderPersonChips');
});

function displayValue(value) {
  const val = String(value || '').trim();
  if (!val || val === 'undefined' || val === 'null' || val === '0') {
    return '<span class="empty">â€”</span>';
  }
  return escapeHtml(val);
}

// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¯ÙŠÙ‡Ø§ IDs
maintenance.forEach(m => { if(!m.id) m.id = uid(); });
faults.forEach(f => { if(!f.id) f.id = uid(); });
orders.forEach(o => { if(!o.id) o.id = uid(); });
attendance.forEach(a => { if(!a.id) a.id = uid(); });
trash.faults.forEach(f => { if(!f.id) f.id = uid(); });
trash.orders.forEach(o => { if(!o.id) o.id = uid(); });
trash.maintenance.forEach(m => { if(!m.id) m.id = uid(); });
(trash.attendance||[]).forEach(a => { if(!a.id) a.id = uid(); });
saveAll();

function startTrashSync(){
  // if(trashSyncInterval) return; // Already syncing
  if (typeof trashSyncInterval !== "undefined" && trashSyncInterval) {
        clearInterval(trashSyncInterval);
    }
  console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  // Initial load
  loadTrashFromServer();
  // Then refresh every 2 seconds while viewing trash
  trashSyncInterval = setInterval(loadTrashFromServer, 2000);
}

function stopTrashSync(){
  if(trashSyncInterval){
    clearInterval(trashSyncInterval);
    trashSyncInterval = null;
    console.log('â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  }
}

function loadTrashFromServer(){
  // Load all trash data in parallel and wait for all to complete
  const promises = [];
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_faults')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.faults = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_orders')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.orders = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_maintenance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.maintenance = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  promises.push(
    fetch(API_URL + '?kind=trash_attendance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.attendance = data;
        console.log('âœ… ØªØ­Ù…Ù‘Ù„Øª Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', data.length);
      })
      .catch(err => console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err))
  );

  // Ø§Ù†ØªØ¸Ø± ÙƒÙ„ Ø§Ù„Ù€ fetches ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø±Ù†Ø¯Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© - ÙˆØ§Ø±Ø¬Ø¹ Promise
  return Promise.all(promises).then(() => {
    console.log('ğŸ‰ Ø§Ù†ØªÙ‡Øª ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ - Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ù†Ø¯Ø±');
    saveAll();
    renderTrash();
  }).catch(err => {
    console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ loadTrashFromServer:', err);
    renderTrash(); // Ø±Ù†Ø¯Ø± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø£Ø®Ø·Ø§Ø¡
    throw err; // Ù…Ø±Ø± Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ø£Ø¹Ù„Ù‰
  });
}

/* CRUD faults */
let editingFaultId = null;
document.getElementById('addBtn').addEventListener('click', onAddOrSave);
document.getElementById('clearBtn').addEventListener('click', clearFaultForm);
function clearFaultForm(){
  editingFaultId = null;
  document.getElementById('machineGroup').value = '';
  populateItemsForGroup('', 'machineItem');
  document.getElementById('customMachinePlace').value = '';
  document.getElementById('customMachineName').value = '';
  setMultiSelectValues('person',''); renderSelectedChips('person','personChips');
  document.getElementById('description').value=''; 
  document.getElementById('solution').value=''; 
  document.getElementById('shift').value='ØµØ¨Ø§Ø­ÙŠØ©'; 
  document.getElementById('date').value=getTodayDate(); 
  document.getElementById('partChanged').value='no';
  document.getElementById('partFieldsContainer').style.display='none';
  document.getElementById('lcode').value=''; 
  document.getElementById('partName').value=''; 
  document.getElementById('partQty').value=0; 
  document.getElementById('status').value='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'; 
  document.getElementById('addBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„';
}

function onAddOrSave(){
  if(editingFaultId) return saveEditFault();
  
  const selML = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  if(selML.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±ÙŠ"ØŒ ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
    // ÙƒÙ…Ø§ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)
    const place = document.getElementById('customMachinePlace').value.trim();
    const customName = document.getElementById('customMachineName').value.trim();
    if(!place) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('person').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.');
      return; 
    }
  } else {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ ÙŠØ¬Ø¨:
    // 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    // 2. Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„
    if(!selML.machine) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('person').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.');
      return; 
    }
  }
  
  // Get the part changed value
  const partChanged = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcode = partChanged === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partName = partChanged === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQty = partChanged === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;
  
  const f = {
    id: uid(),
    machine: selML.machine,
    line: selML.line,
    person: getSelectedValues('person').join(', '),
    description: document.getElementById('description').value.trim(),
    solution: document.getElementById('solution').value.trim(),
    shift: document.getElementById('shift').value,
    date: formatDateOnly(document.getElementById('date').value),
    partChanged: partChanged,
    lcode: lcode,
    partName: partName,
    partQty: partQty,
    status: document.getElementById('status').value
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'fault', op: 'add', data: f })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ø·Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  faults.unshift(f);
  clearFaultForm(); 
  currentPageFaults = 1;
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
}

/* edit fault */
function startEditFault(id){
  const f = faults.find(x=>x.id===id); if(!f) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); editingFaultId = id;
  setGroupSelection('machineGroup','machineItem', f.machine, f.line);
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ù…Ù„Ø£ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(f.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† f.machine
    const parts = f.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMachinePlace').value = parts[0].trim();
      document.getElementById('customMachineName').value = parts[1].trim();
    } else {
      document.getElementById('customMachinePlace').value = '';
      document.getElementById('customMachineName').value = f.machine;
    }
  } else {
    document.getElementById('customMachinePlace').value = '';
    document.getElementById('customMachineName').value = '';
  }
  setMultiSelectValues('person', f.person);
  renderSelectedChips('person','personChips');
  document.getElementById('description').value = f.description;
  document.getElementById('solution').value = f.solution || '';
  document.getElementById('shift').value = f.shift;
  document.getElementById('date').value = f.date;
  // Set part changed based on whether part fields have values
  const hasPartData = f.lcode || f.partName || f.partQty;
  document.getElementById('partChanged').value = hasPartData ? 'yes' : 'no';
  document.getElementById('partFieldsContainer').style.display = hasPartData ? 'block' : 'none';
  document.getElementById('lcode').value = f.lcode;
  document.getElementById('partName').value = f.partName;
  document.getElementById('partQty').value = f.partQty;
  document.getElementById('status').value = f.status;
  document.getElementById('addBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

function saveEditFault(){
  const idx = faults.findIndex(x=>x.id===editingFaultId); if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');

  // Get the part changed value
  const partChanged = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcode = partChanged === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partName = partChanged === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQty = partChanged === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;

  // Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
  const selML2 = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  faults[idx].machine = selML2.machine;
  faults[idx].line = selML2.line;
  faults[idx].person = getSelectedValues('person').join(', ');
  faults[idx].description = document.getElementById('description').value.trim();
  faults[idx].solution = document.getElementById('solution').value.trim();
  faults[idx].shift = document.getElementById('shift').value;
  faults[idx].date = formatDateOnly(document.getElementById('date').value);
  faults[idx].partChanged = partChanged;
  faults[idx].lcode = lcode;
  faults[idx].partName = partName;
  faults[idx].partQty = partQty;
  faults[idx].status = document.getElementById('status').value;

   // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Sheet
  const f = faults[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => console.error('fault update error', err));

  editingFaultId = null;
  clearFaultForm(); 
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function moveToTrashFault(id){
  const f = faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† faults Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    trash.faults.unshift(faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
    showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }
}

function restoreFault(id){
  const f = trash.faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ faults Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    faults.unshift(trash.faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
  }
}
// function permanentDeleteFault(id){ const idx = trash.faults.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.faults.splice(idx,1); saveAll(); renderTrash(); }
function permanentDeleteFault(id){
  const idx = trash.faults.findIndex(x=>x.id===id); 
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;

  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  // Ø§Ø¨Ø¹Øª Delete Ù„Ù„Ù€ Sheet
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.faults.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('fault delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}


/* CRUD orders */
let editingOrderId = null;
document.getElementById('addOrderBtn').addEventListener('click', ()=> {
  if(editingOrderId) return saveEditOrder(); addOrder();});
document.getElementById('clearOrderBtn').addEventListener('click', clearOrderForm);

function addOrder(){
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…/Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
  if(getSelectedValues('orderPerson').length === 0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.'); return; }
  const o = { 
    id: uid(), 
    orderNum: document.getElementById('orderNum').value.trim(), 
    supplyNum: document.getElementById('supplyNum').value.trim(), 
    date: formatDateOnly(document.getElementById('orderDate').value), 
    person: getSelectedValues('orderPerson').join(', '), 
    details: document.getElementById('orderDetails').value.trim() 
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'order', op: 'add', data: o })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  orders.unshift(o); clearOrderForm(); currentPageOrders = 1; renderOrderTable(); renderTrash();
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
}
function startEditOrder(id){
  const o = orders.find(x=>x.id===id); if(!o) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  editingOrderId = id;
  document.getElementById('orderNum').value = o.orderNum;
  document.getElementById('supplyNum').value = o.supplyNum;
  document.getElementById('orderDate').value = o.date;
  // set multi-select values and render chips
  setMultiSelectValues('orderPerson', o.person);
  renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value = o.details;
  document.getElementById('addOrderBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}
// function saveEditOrder(){ const idx=orders.findIndex(x=>x.id===editingOrderId); if(idx===-1) return; orders[idx].orderNum=document.getElementById('orderNum').value.trim(); orders[idx].supplyNum=document.getElementById('supplyNum').value.trim(); orders[idx].date=document.getElementById('orderDate').value; orders[idx].person=document.getElementById('orderPerson').value.trim(); orders[idx].details=document.getElementById('orderDetails').value.trim(); editingOrderId=null; clearOrderForm(); renderOrderTable(); }
function saveEditOrder(){
  const idx = orders.findIndex(x=>x.id===editingOrderId); 
  if(idx===-1) return;

  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…/Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
  if(getSelectedValues('orderPerson').length === 0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.'); return; }

  orders[idx].orderNum = document.getElementById('orderNum').value.trim();
  orders[idx].supplyNum= document.getElementById('supplyNum').value.trim();
  orders[idx].date     = formatDateOnly(document.getElementById('orderDate').value);
  orders[idx].person   = getSelectedValues('orderPerson').join(', ');
  orders[idx].details  = document.getElementById('orderDetails').value.trim();

  const o = orders[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order update error', err));

  editingOrderId=null; 
  clearOrderForm(); 
  renderOrderTable();
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function clearOrderForm(){ 
  document.getElementById('orderNum').value=''; 
  document.getElementById('supplyNum').value=''; 
  document.getElementById('orderDate').value=getTodayDate(); 
  setMultiSelectValues('orderPerson',''); renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value=''; 
  editingOrderId=null; 
  document.getElementById('addOrderBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±'; 
}

function moveToTrashOrder(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† orders Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    trash.orders.unshift(orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
    showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }
}

function restoreOrder(id){
  const o = trash.orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ orders Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    orders.unshift(trash.orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
  }
}
function permanentDeleteOrder(id){
  const idx = trash.orders.findIndex(x=>x.id===id); 
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;

  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.orders.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('order delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}

// function permanentDeleteOrder(id){ const idx=trash.orders.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.orders.splice(idx,1); saveAll(); renderTrash(); }

/* MAINTENANCE CRUD */
let editingMaintenanceId = null;
document.getElementById('addMaintenanceBtn').addEventListener('click', ()=> {
  if(editingMaintenanceId) return saveEditMaintenance(); addMaintenance();});
document.getElementById('clearMaintenanceBtn').addEventListener('click', clearMaintenanceForm);

function addMaintenance(){
  const selMainML = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  if(selMainML.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±ÙŠ"ØŒ ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
    // ÙƒÙ…Ø§ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)
    const place = document.getElementById('customMainPlace').value.trim();
    const customName = document.getElementById('customMainName').value.trim();
    if(!place) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(!customName) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.');
      return; 
    }
  } else {
    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ ÙŠØ¬Ø¨:
    // 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    // 2. Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©
    if(!selMainML.machine) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.');
      return; 
    }
  }
  
  const partChanged = document.getElementById('mainPartChanged').value;
  const m = { 
    id: uid(), 
    machine: selMainML.machine, 
    line: selMainML.line, 
    person: getSelectedValues('mainPerson').join(', '), 
    date: formatDateOnly(document.getElementById('mainDate').value), 
    partChanged: partChanged,
    lcode: partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '', 
    partName: partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '', 
    partQty: partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '', 
    type: document.getElementById('mainType').value.trim(), 
    notes: document.getElementById('mainNotes').value.trim() 
  };
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'add', data: m })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    }).catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    });
  
  maintenance.unshift(m); 
  clearMaintenanceForm(); 
  currentPageMaintenance = 1;
  renderMaintenanceTable(); 
  renderTrash();
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
}

function startEditMaintenance(id){
  const m = maintenance.find(x=>x.id===id); 
  if(!m) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); 
  editingMaintenanceId=id; 
  setGroupSelection('mainGroup','mainItem', m.machine, m.line);
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ù…Ù„Ø£ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø±
  if(m.line === 'Ø£Ø®Ø±ÙŠ') {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† m.machine
    const parts = m.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMainPlace').value = parts[0].trim();
      document.getElementById('customMainName').value = parts[1].trim();
    } else {
      document.getElementById('customMainPlace').value = '';
      document.getElementById('customMainName').value = m.machine;
    }
  } else {
    document.getElementById('customMainPlace').value = '';
    document.getElementById('customMainName').value = '';
  }
  setMultiSelectValues('mainPerson', m.person);
  renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=m.date; 
  document.getElementById('mainPartChanged').value = m.partChanged || 'no';
  document.getElementById('mainLcode').value=m.lcode || ''; 
  document.getElementById('mainPartName').value=m.partName || ''; 
  document.getElementById('mainPartQty').value=m.partQty || '0'; 
  document.getElementById('mainPartFieldsContainer').style.display = (m.partChanged === 'yes') ? 'block' : 'none';
  document.getElementById('mainType').value=m.type; 
  document.getElementById('mainNotes').value=m.notes; 
  document.getElementById('addMaintenanceBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

function saveEditMaintenance(){
  const idx = maintenance.findIndex(x=>x.id===editingMaintenanceId); 
  if(idx===-1) return;

  const selMainML2 = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  const partChanged = document.getElementById('mainPartChanged').value;
  maintenance[idx].machine  = selMainML2.machine;
  maintenance[idx].line     = selMainML2.line;
  maintenance[idx].person   = getSelectedValues('mainPerson').join(', ');
  maintenance[idx].date     = formatDateOnly(document.getElementById('mainDate').value);
  maintenance[idx].partChanged = partChanged;
  maintenance[idx].lcode    = partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '';
  maintenance[idx].partName = partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '';
  maintenance[idx].partQty  = partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '';
  maintenance[idx].type     = document.getElementById('mainType').value.trim();
  maintenance[idx].notes    = document.getElementById('mainNotes').value.trim();

  // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Sheet
  const m = maintenance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: m })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§ØªØ­ÙØ¸ Local Ø¨Ø³');
    });

  editingMaintenanceId=null; 
  clearMaintenanceForm(); 
  renderMaintenanceTable();
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function clearMaintenanceForm(){ 
  document.getElementById('mainGroup').value = '';
  populateItemsForGroup('', 'mainItem');
  document.getElementById('customMainPlace').value = '';
  document.getElementById('customMainName').value = '';
  setMultiSelectValues('mainPerson',''); renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=getTodayDate(); 
  document.getElementById('mainPartChanged').value='no';
  document.getElementById('mainLcode').value=''; 
  document.getElementById('mainPartName').value=''; 
  document.getElementById('mainPartQty').value='0'; 
  document.getElementById('mainPartFieldsContainer').style.display='none';
  document.getElementById('mainType').value='Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©'; 
  document.getElementById('mainNotes').value=''; 
  editingMaintenanceId=null; 
  document.getElementById('addMaintenanceBtn').innerText='Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©'; 
}

function moveToTrashMaintenance(id){
  const idx = maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // Ø¹Ù„Ù‘Ù… ÙƒÙ€ deleted = true (soft delete)
  maintenance[idx].deleted = true;
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server ÙƒÙ€ update (ÙŠØ®Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø¨Ù€ deleted = true)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: maintenance[idx] })
  }).then(r=>r.json())
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', err));
  
  // Ø§Ø³Ø­Ø¨ Ù…Ù† maintenance ÙˆØ­Ø·Ù‡Ø§ ÙÙŠ trash
  const movedItem = maintenance.splice(idx,1)[0];
  trash.maintenance.unshift(movedItem);
  
  saveAll();
  renderMaintenanceTable();
  renderTrash();
  showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

function restoreMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // Ø§Ø³Ø­Ø¨ Ù…Ù† trash ÙˆØ¹Ù„Ù‘Ù… deleted = false
  const restoredItem = trash.maintenance.splice(idx,1)[0];
  restoredItem.deleted = false;
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server ÙƒÙ€ update (ÙŠØ®Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø¨Ù€ deleted = false)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: restoredItem })
  }).then(r=>r.json())
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹:', err));
  
  maintenance.unshift(restoredItem);
  saveAll();
  renderMaintenanceTable();
  renderTrash();
}

function permanentDeleteMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id); 
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;

  const deletedItem = trash.maintenance.splice(idx,1)[0];
  
  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'delete', data: { id: deletedItem.id } })
  }).then(r=>r.json())
    .catch(err => console.error(err));
  
  saveAll(); 
  renderTrash();
}

/* MAINTENANCE FILTERS */
document.getElementById('applyMaintenanceFilterBtn').addEventListener('click', applyMaintenanceFilters);
function applyMaintenanceFilters(){ 
  const q=(document.getElementById('searchMaintenance').value||'').toLowerCase();
  const filterType = (document.getElementById('filterMaintenanceType')?.value||'').trim();
  const dateFrom = document.getElementById('dateFromMaintenance').value;
  const dateTo = document.getElementById('dateToMaintenance').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('maintenanceCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Filter table view
  document.querySelectorAll('#maintenanceTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[4]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 4
    const rowType = (cells[8]?.textContent||'').trim();
    const typeMatch = !filterType || rowType === filterType;
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = ((!q || text.includes(q)) && dateMatch && typeMatch) ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#maintenanceCards .order-card').forEach(card=>{
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®'))?.textContent || '';
    const rowDate = dateText.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®', '').replace(':', '').trim();
    const typeText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('Ø§Ù„Ù†ÙˆØ¹'))?.textContent || '';
    const rowType = typeText.replace('Ø§Ù„Ù†ÙˆØ¹', '').replace(':','').trim();
    const typeMatch = !filterType || rowType === filterType;
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = ((!q || text.includes(q)) && dateMatch && typeMatch) ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterMaintenanceBtn')?.addEventListener('click', applyMaintenanceFilters);
document.getElementById('searchMaintenance')?.addEventListener('input', applyMaintenanceFilters);

/* MAINTENANCE EXPORTS */
document.getElementById('exportMaintenanceCsv').addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','machine','line','person','date','lcode','partName','partQty','type','notes'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      date: cells[4].textContent,
      lcode: cells[5].textContent,
      partName: cells[6].textContent,
      partQty: cells[7].textContent,
      type: cells[8].textContent,
      notes: cells[9].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `maintenance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportMaintenanceDoc').addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©';
  const headers = ['#','Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©','Ø§Ù„Ø®Ø·','Ø§Ù„Ù‚Ø§Ø¦Ù…','Ø§Ù„ØªØ§Ø±ÙŠØ®','L Number','Ø§Ù„Ù‚Ø·Ø¹Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `maintenance_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

document.getElementById('printMaintenanceBtn').addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

            document.getElementById('emptyTrashBtn').addEventListener('click', () => {
  if (!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª (Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± ÙˆØµÙŠØ§Ù†Ø§Øª)ØŸ')) return;

  // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ù€ IDs Ø§Ù„Ù„ÙŠ Ù‡ØªØªÙ…Ø³Ø­ Ù…Ù† Ø§Ù„Ø´ÙŠØª
  const faultIds = (trash.faults || []).map(f => f.id);
  const orderIds = (trash.orders || []).map(o => o.id);
  const maintenanceIds = (trash.maintenance || []).map(m => m.id);
  const attendanceIds = (trash.attendance || []).map(a => a.id);
  
  const totalItems = faultIds.length + orderIds.length + maintenanceIds.length + attendanceIds.length;
  console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ - Ø§Ù„Ø£Ø¹Ø·Ø§Ù„:', faultIds.length, 'Ø§Ù„Ø£ÙˆØ§Ù…Ø±:', orderIds.length, 'Ø§Ù„ØµÙŠØ§Ù†Ø§Øª:', maintenanceIds.length, 'Ø§Ù„Ø­Ø¶ÙˆØ±:', attendanceIds.length, 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', totalItems);

  // Ø§Ø°Ø§ Ù…Ø§ÙÙŠØ´ Ø­Ø§Ø¬Ø© Ù„Ù„Ø­Ø°Ù
  if (totalItems === 0) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ø­Ø°Ù');
    return;
  }

  const requests = [];

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ Ø¹Ø·Ù„
  faultIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'fault', op: 'delete', data: { id } })
      }).catch(e => console.error('Ø®Ø·Ø£ Ø­Ø°Ù Ø¹Ø·Ù„:', id, e))
    );
  });

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡
  orderIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'order', op: 'delete', data: { id } })
      }).catch(e => console.error('Ø®Ø·Ø£ Ø­Ø°Ù Ø£Ù…Ø±:', id, e))
    );
  });

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ ØµÙŠØ§Ù†Ø©
  maintenanceIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'maintenance', op: 'delete', data: { id } })
      }).catch(e => console.error('Ø®Ø·Ø£ Ø­Ø°Ù ØµÙŠØ§Ù†Ø©:', id, e))
    );
  });

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±
  attendanceIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'attendance', op: 'delete', data: { id } })
      }).catch(e => console.error('Ø®Ø·Ø£ Ø­Ø°Ù Ø­Ø¶ÙˆØ±:', id, e))
    );
  });

  // Ù„Ù…Ø§ ØªØ®Ù„Øµ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  Promise.allSettled(requests).then((results) => {
    console.log('âœ… Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø°Ù:', results);
    // ÙØ¶Ù‘ÙŠ Ø§Ù„Ø³Ù„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
    trash = { faults: [], orders: [], maintenance: [], attendance: [] };
    saveAll();
    renderTrash();
    // Ø§Ù†ØªØ¸Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ÙŠÙ† Ø§Ø¸Ù‡Ø± Ø§Ù„Ù€ alert
    return loadTrashFromServer().then(() => {
      alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù€ ' + totalItems + ' Ø³Ø¬Ù„!');
    });
  }).catch(err => {
    console.error('empty trash error', err);
    alert('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©');
  });
});

/* ATTENDANCE: CRUD, render, exports */
let editingAttendanceId = null;

// Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
const arabicDayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function calculateVacationDays(startDateStr, numDays) {
  const startDate = new Date(startDateStr);
  const dayNames = [];
  
  for (let i = 0; i < numDays; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    const dayIndex = currentDate.getDay();
    dayNames.push(arabicDayNames[dayIndex]);
  }
  
  return dayNames.join(', ');
}

document.getElementById('addAttendanceBtn').addEventListener('click', ()=>{ if(editingAttendanceId) return saveEditAttendance(); addAttendance(); });
document.getElementById('clearAttendanceBtn').addEventListener('click', clearAttendanceForm);

function clearAttendanceForm(){
  editingAttendanceId = null;
  document.getElementById('workerName').value=''; 
  document.getElementById('workerNum').value=''; 
  document.getElementById('absenceDate').value=getTodayDate(); 
  document.getElementById('daysCount').value=1; 
  document.getElementById('addAttendanceBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„';
}

function addAttendance(){
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  
  if (!startDate) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©');
    return;
  }
  
  // Ø§Ø­Ø³Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  const a = { 
    id: uid(), 
    workerName: document.getElementById('workerName').value.trim(), 
    workerNum: document.getElementById('workerNum').value.trim(), 
    absenceDate: startDate, 
    daysCount: daysCount, 
    absenceDay: daysName  // Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  };
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'add', data: a })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    }).catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    });
  
  attendance.unshift(a);
  clearAttendanceForm(); currentPageAttendance = 1; renderAttendanceTable(); show('attendance');
  showSuccess('ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
}

function startEditAttendance(id){ 
  const a = attendance.find(x=>x.id===id); 
  if(!a) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); 
  editingAttendanceId = id; 
  document.getElementById('workerName').value=a.workerName; 
  // trigger the change event to auto-fill the worker number
  document.getElementById('workerName').dispatchEvent(new Event('change'));
  document.getElementById('absenceDate').value=a.absenceDate; 
  document.getElementById('daysCount').value=a.daysCount; 
  document.getElementById('addAttendanceBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; 
}

function saveEditAttendance(){ 
  const idx = attendance.findIndex(x=>x.id===editingAttendanceId); 
  if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  
  // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  attendance[idx].workerName = document.getElementById('workerName').value.trim(); 
  attendance[idx].workerNum = document.getElementById('workerNum').value.trim(); 
  attendance[idx].absenceDate = startDate; 
  attendance[idx].daysCount = daysCount;
  attendance[idx].absenceDay = daysName;
  
  // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Server
  const a = attendance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: a })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance update error', err));
  
  editingAttendanceId = null; 
  clearAttendanceForm(); 
  renderAttendanceTable(); 
  showSuccess('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}

function deleteAttendance(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  const idx = attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance move to trash error', err));
  
  // move to trash.attendance
  const movedItem = attendance.splice(idx,1)[0];
  if(!trash.attendance) trash.attendance = [];
  trash.attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function restoreAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = trash.attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance restore error', err));
  
  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ attendance Ù…Ø­Ù„ÙŠÙ‹Ø§
  const movedItem = trash.attendance.splice(idx,1)[0];
  attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function permanentDeleteAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  
  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  // Ø§Ø¨Ø¹Øª Delete Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.attendance.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('attendance delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}

function renderAttendanceTable(){ 
  const tbody = document.querySelector('#attendanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('attendanceCards'); 
  cardsDiv.innerHTML=''; 
  
  // Ø§Ø­Ø³Ø¨ pagination
  const paginationData = paginate(attendance, currentPageAttendance);
  const { items: pageAttendance, totalPages } = paginationData;
  
  pageAttendance.forEach((a, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = (currentPageAttendance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(a.workerName)}</td><td>${escapeHtml(a.workerNum)}</td><td>${escapeHtml(a.absenceDate)}</td><td>${escapeHtml(a.daysCount)}</td><td>${escapeHtml(a.absenceDay)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditAttendance('${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="deleteAttendance('${a.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr);
    
    // card view
    const card = document.createElement('div'); 
    card.className='order-card'; 
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${globalIndex} - ${escapeHtml(a.workerName)}</div>
      <div class="order-card-row"><div class="order-card-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:</div><div class="order-card-value">${displayValue(a.workerNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(a.absenceDate)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…:</div><div class="order-card-value">${displayValue(a.daysCount)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(a.absenceDay)}</div></div>
      <div class="order-card-actions"><button class="btn ghost" onclick="startEditAttendance('${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="deleteAttendance('${a.id}')">Ø­Ø°Ù</button></div>
    `; 
    cardsDiv.appendChild(card);
  }); 
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination
  updatePaginationButtons('#attendancePagination', totalPages, currentPageAttendance, (pageNum) => {
    currentPageAttendance = pageNum;
    renderAttendanceTable();
  });
  
  saveAll(); 
}

/* Attendance filters & exports */
document.getElementById('applyAttendanceFilterBtn').addEventListener('click', applyAttendanceFilters);
function applyAttendanceFilters(){ 
  const q=(document.getElementById('searchAttendance').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance').value;
  const dateTo = document.getElementById('dateToAttendance').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('attendanceCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Filter table view
  document.querySelectorAll('#attendanceTable tbody tr').forEach(tr=> {
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[3]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 3
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#attendanceCards .order-card').forEach(card=> {
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨'))?.textContent || '';
    const rowDate = dateText.replace('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨', '').replace(':', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterAttendanceBtn')?.addEventListener('click', applyAttendanceFilters);
document.getElementById('searchAttendance').addEventListener('input', applyAttendanceFilters);

document.getElementById('exportAttendanceCsv').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','workerName','workerNum','absenceDate','daysCount','absenceDay'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      workerName: cells[1].textContent,
      workerNum: cells[2].textContent,
      absenceDate: cells[3].textContent,
      daysCount: cells[4].textContent,
      absenceDay: cells[5].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `attendance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportAttendanceDoc').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  downloadBlob(html, `attendance_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

document.getElementById('printAttendanceBtn').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* filters */
document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', ()=>{ 
  document.getElementById('search').value=''; 
  document.getElementById('filterStatus').value=''; 
  document.getElementById('dateFromFault').value=''; 
  document.getElementById('dateToFault').value=''; 
  applyFilters(); 
});

function applyFilters(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const st = (document.getElementById('filterStatus').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault').value;
  const dateTo = document.getElementById('dateToFault').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('faultCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Filter table view
  document.querySelectorAll('#faultTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[6]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 6
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = ((!q || text.includes(q)) && (!st || text.includes(st)) && dateMatch) ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#faultCards .fault-card').forEach(card=>{
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.fault-card-row')).find(row => row.textContent.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®'))?.textContent || '';
    const rowDate = dateText.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®', '').replace(':', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = ((!q || text.includes(q)) && (!st || text.includes(st)) && dateMatch) ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterFaultBtn')?.addEventListener('click', applyFilters);

/* order filter */
document.getElementById('applyOrderFilterBtn').addEventListener('click', applyOrderFilters);
function applyOrderFilters(){ 
  const q=(document.getElementById('searchOrder').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder').value;
  const dateTo = document.getElementById('dateToOrder').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('orderCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Filter table view
  document.querySelectorAll('#orderTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[2]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = (!q || text.toLowerCase().includes(q)) && dateMatch ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#orderCards .order-card').forEach(card=>{
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®'))?.textContent || '';
    const rowDate = dateText.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®', '').replace(':', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterOrderBtn')?.addEventListener('click', applyOrderFilters);

/* exports: CSV and Word (table) and print */
function arrayToCsv(headers, rows){
  const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
  const lines = [headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(',')));
  return lines.join('\r\n');
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* Faults exports (filtered only) */
document.getElementById('exportCsvAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers = ['#','machine','line','person','description','solution','shift','date','lcode','partName','partQty','status'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      description: cells[4].textContent,
      solution: cells[5].textContent,
      shift: cells[6].textContent,
      date: cells[7].textContent,
      lcode: cells[8].textContent,
      partName: cells[9].textContent,
      partQty: cells[10].textContent,
      status: cells[11].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `faults_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

/* Word export as table (filtered faults only) */
document.getElementById('exportDocAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  const headers = ['#','Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©','Ø§Ù„Ø®Ø·','Ø§Ù„Ù‚Ø§Ø¦Ù…','Ø§Ù„ÙˆØµÙ','Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„','Ø§Ù„ÙˆØ±Ø¯ÙŠØ©','Ø§Ù„ØªØ§Ø±ÙŠØ®','L Number','Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø­Ø§Ù„Ø©'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td><td>${escapeHtml(cells[11].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `faults_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print/PDF (opens printable window with filtered table only) */
document.getElementById('printPdfAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td><td>${escapeHtml(cells[11].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Orders exports (filtered only) */
document.getElementById('exportOrdersCsv').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','orderNum','supplyNum','date','person','details'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      orderNum: cells[0].textContent,
      supplyNum: cells[1].textContent,
      date: cells[2].textContent,
      person: cells[3].textContent,
      details: cells[4].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `orders_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});
document.getElementById('exportOrdersDoc').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  downloadBlob(html, `orders_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});
document.getElementById('printOrdersBtn').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* dashboard */
function applyDashboardTile(title){
  // faults statuses
  const faultStatuses = ['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  // maintenance types mapping
  const maintMap = {
    'ØµÙŠØ§Ù†Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©':'Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©',
    'ØµÙŠØ§Ù†Ø© Ø´Ù‡Ø±ÙŠØ©':'Ø´Ù‡Ø±ÙŠØ©',
    'Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©':'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ',
    'ØµÙŠØ§Ù†Ø© Ø³Ù†ÙˆÙŠØ©':'Ø³Ù†ÙˆÙŠØ©',
    'ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©':'Ø·Ø§Ø±Ø¦Ø©'
  };

  // Faults tiles
  if(title.includes('Ø£Ø¹Ø·Ø§Ù„') || faultStatuses.some(s=> title.includes(s) )){
    // clear search/date filters
    const statusTitle = faultStatuses.find(s=> title.includes(s));
    if(statusTitle){ document.getElementById('filterStatus').value = statusTitle; }
    else { document.getElementById('filterStatus').value = ''; }
    document.getElementById('search').value = '';
    document.getElementById('dateFromFault').value = '';
    document.getElementById('dateToFault').value = '';
    show('faults');
    applyFilters();
    return;
  }

  // Maintenance tiles
  if(title.includes('ØµÙŠØ§Ù†Ø©') || title.includes('Ø§Ù„ØµÙŠØ§Ù†Ø§Øª')){
    const mapped = maintMap[title] || '';
    document.getElementById('filterMaintenanceType').value = mapped;
    document.getElementById('searchMaintenance').value = '';
    document.getElementById('dateFromMaintenance').value = '';
    document.getElementById('dateToMaintenance').value = '';
    show('maintenance');
    applyMaintenanceFilters();
    return;
  }
}

function drawDashboard(){
  const total = faults.length;
  const done = faults.filter(f=>f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const working = faults.filter(f=>f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const testing = faults.filter(f=>f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©').length;
  const waitC = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©').length;
  const waitP = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±').length;

  const maintenanceTotal = maintenance.length;
  const mainWeekly = maintenance.filter(m=>m.type==='Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©').length;
  const mainMonthly = maintenance.filter(m=>m.type==='Ø´Ù‡Ø±ÙŠØ©').length;
  const mainQuarterAll = maintenance.filter(m=>m.type==='Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ').length;
  const mainYearly = maintenance.filter(m=>m.type==='Ø³Ù†ÙˆÙŠØ©').length;
  const mainEmergency = maintenance.filter(m=>m.type==='Ø·Ø§Ø±Ø¦Ø©').length;

  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentQuarter = Math.floor(now.getMonth()/3) + 1;
  function quarterOf(dateStr){
    const d = new Date(dateStr);
    if(isNaN(d)) return { year: null, quarter: null };
    return { year: d.getFullYear(), quarter: Math.floor(d.getMonth()/3) + 1 };
  }
  const mainQuarterCurrent = maintenance.filter(m => {
    if(m.type !== 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ') return false;
    const q = quarterOf(m.date);
    return q.year === currentYear && q.quarter === currentQuarter;
  }).length;

  const tiles = document.getElementById('tiles'); tiles.innerHTML='';
  function tileColor(title){
    // Ø£Ø®Ø¶Ø± Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬ÙŠØ¯Ø© / Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ Ø£ØµÙØ± Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©/ØªØ­Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±/Ø¨Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø£Ø²Ø±Ù‚ Ù„Ù„ØµÙŠØ§Ù†Ø§Øª
    const greenRegex = /ØªÙ…\s?Ø§Ù„Ø¥ØµÙ„Ø§Ø­|Ø¥Ø¬Ù…Ø§Ù„ÙŠ\s?Ø§Ù„Ø£Ø¹Ø·Ø§Ù„/;
    const yellowRegex = /Ø¬Ø§Ø±ÙŠ\s?Ø§Ù„Ø¥ØµÙ„Ø§Ø­|ØªØ­Øª\s?Ø§Ù„ØªØ¬Ø±Ø¨Ø©|ØªØ­Øª\s?Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±|Ø¨Ø§Ù†ØªØ¸Ø§Ø±/;
    const blueRegex = /ØµÙŠØ§Ù†Ø©|Ø§Ù„ØµÙŠØ§Ù†Ø§Øª|ØµÙŠØ§Ù†Ø©\s?Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©|ØµÙŠØ§Ù†Ø©\s?Ø´Ù‡Ø±ÙŠØ©|Ø±Ø¨Ø¹\s?Ø³Ù†ÙˆÙŠ|ØµÙŠØ§Ù†Ø©\s?Ø³Ù†ÙˆÙŠØ©|ØµÙŠØ§Ù†Ø©\s?Ø·Ø§Ø±Ø¦Ø©/;
    if(greenRegex.test(title)) return { bg: '#e8f7e8', fg: '#08365F' };
    if(yellowRegex.test(title)) return { bg: '#fff8dc', fg: '#08365F' };
    if(blueRegex.test(title)) return { bg: '#e6f0ff', fg: '#08365F' };
    return { bg: '#fff', fg: '#000' };
  }
  const addTile = (title,val)=> {
    const d=document.createElement('div'); d.className='tile';
    d.innerHTML=`<h4 style="margin:0 0 6px 0">${title}</h4><div style="font-weight:700;font-size:20px">${val}</div>`;
    // apply color for tiles (bg + foreground)
    const clr = tileColor(title);
    d.style.background = clr.bg;
    d.style.color = clr.fg;
    // make tile clickable: apply filter and navigate
    d.style.cursor = 'pointer';
    d.addEventListener('click', function(){
      try{ applyDashboardTile(title); }catch(e){ console.error('tile click error', e); }
    });
    tiles.appendChild(d);
  };
  addTile('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„', total);
  addTile('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', done);
  addTile('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', working);
  addTile('Ø£Ø¹Ø·Ø§Ù„ ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©', testing);
  addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©', waitC);
  addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±', waitP);
  addTile('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª', maintenanceTotal);
  addTile('ØµÙŠØ§Ù†Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©', mainWeekly);
  addTile('ØµÙŠØ§Ù†Ø© Ø´Ù‡Ø±ÙŠØ©', mainMonthly);
  addTile('Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©', mainQuarterAll);
  addTile('ØµÙŠØ§Ù†Ø© Ø³Ù†ÙˆÙŠØ©', mainYearly);
  addTile('ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©', mainEmergency);

  const canvas = document.getElementById('pie'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const data = [done, working, testing, waitC, waitP]; const colors=['#8ed08e','#ffd966','#fff3b0','#ffd59e','#ffb4b4']; const labels=['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-20;
  let start=0; const totalSum = data.reduce((a,b)=>a+b,0);
  for(let i=0;i<data.length;i++){
    const slice = totalSum===0?0:(data[i]/totalSum)*(Math.PI*2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i]; ctx.arc(cx,cy,r,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
  }
  ctx.font='13px Arial'; let ly=10; for(let i=0;i<labels.length;i++){ ctx.fillStyle=colors[i]; ctx.fillRect(10,ly,12,12); ctx.fillStyle='#000'; ctx.fillText(` ${labels[i]} (${data[i]})`, 28, ly+10); ly+=18; }
  const tbody = document.querySelector('#dashTable tbody'); tbody.innerHTML=''; labels.forEach((lab,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${data[i]}</td>`; tbody.appendChild(tr);});
}

/* init render */
renderFaultTable(); renderOrderTable(); renderMaintenanceTable(); renderAttendanceTable(); renderTrash(); drawDashboard();

function loadFromServer() {
  // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=faults')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
      // ÙØµÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      faults = data.filter(f => !f.deleted && f.deleted !== 'Yes' && f.deleted !== 'TRUE' && f.deleted !== true);
      const deletedFaults = data.filter(f => f.deleted === 'Yes' || f.deleted === 'TRUE' || f.deleted === true);
      
      trash.faults = deletedFaults;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderFaultTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      drawDashboard();            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ Dashboard
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 2) ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=orders')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
      // ÙØµÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      orders = data.filter(o => !o.deleted && o.deleted !== 'Yes' && o.deleted !== 'TRUE' && o.deleted !== true);
      const deletedOrders = data.filter(o => o.deleted === 'Yes' || o.deleted === 'TRUE' || o.deleted === true);
      
      trash.orders = deletedOrders;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderOrderTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 3) ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=maintenance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
      // ÙØµÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ "deleted"
      maintenance = data.filter(m => !m.deleted && m.deleted !== 'Yes' && m.deleted !== 'TRUE' && m.deleted !== true);
      const deletedMaintenance = data.filter(m => m.deleted === 'Yes' || m.deleted === 'TRUE' || m.deleted === true);
      
      trash.maintenance = deletedMaintenance;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderMaintenanceTable();             // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();                        // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      drawDashboard();                      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ Dashboard
      saveAll();                            // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 4) ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=attendance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
      // ÙØµÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ "deleted"
      attendance = data.filter(a => !a.deleted && a.deleted !== 'Yes' && a.deleted !== 'TRUE' && a.deleted !== true);
      const deletedAttendance = data.filter(a => a.deleted === 'Yes' || a.deleted === 'TRUE' || a.deleted === true);
      
      trash.attendance = deletedAttendance;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderAttendanceTable();            // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();                      // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                          // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø¹Ù…Ù„ Ø±Ù†Ø¯Ø± Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† localStorage (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
loadFromServer();

/* implement render functions after declarations to avoid hoisting issues (redefine) */
function renderFaultTable(){ 
  const tbody = document.querySelector('#faultTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('faultCards');
  cardsDiv.innerHTML = '';
  
  // Ø§Ø­Ø³Ø¨ pagination
  const paginationData = paginate(faults, currentPageFaults);
  const { items: pageFaults, totalPages } = paginationData;
  
  pageFaults.forEach((f, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = (currentPageFaults - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td class="status-cell">${escapeHtml(f.status)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditFault('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashFault('${f.id}')">Ø­Ø°Ù</button></td>`; 
    const sc = tr.querySelector('.status-cell'); 
    if(f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­') sc.classList.add('status-okay'); 
    else if(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' || f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©') sc.classList.add('status-working'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©') sc.classList.add('status-wait-company'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±') sc.classList.add('status-wait-part'); 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'fault-card';
    const statusClass = f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'?'status-okay':(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­'||f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©')?'status-working':(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©')?'status-wait-company':'status-wait-part';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${globalIndex} - ${escapeHtml(f.machine)}</div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ø®Ø·:</div><div class="fault-card-value">${displayValue(f.line)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="fault-card-value">${displayValue(f.person)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØµÙ:</div><div class="fault-card-value">${displayValue(f.description)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„:</div><div class="fault-card-value">${displayValue(f.solution)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.shift)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">L Number:</div><div class="fault-card-value">${displayValue(f.lcode)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©:</div><div class="fault-card-value">${displayValue(f.partName)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.partQty)}</div></div>
      <div class="fault-card-row" style="margin-top:14px"><div class="fault-card-label">Ø§Ù„Ø­Ø§Ù„Ø©:</div><div class="fault-card-value"><div class="card-status-badge ${statusClass}">${escapeHtml(f.status)}</div></div></div>
      <div class="fault-card-actions">
        <button class="btn ghost" onclick="startEditFault('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashFault('${f.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination
  updatePaginationButtons('#faultsPagination', totalPages, currentPageFaults, (pageNum) => {
    currentPageFaults = pageNum;
    renderFaultTable();
  });
  
  saveAll(); 
}

function renderOrderTable(){ 
  const tbody = document.querySelector('#orderTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('orderCards');
  cardsDiv.innerHTML = '';
  
  // Ø§Ø­Ø³Ø¨ pagination
  const paginationData = paginate(orders, currentPageOrders);
  const { items: pageOrders, totalPages } = paginationData;
  
  pageOrders.forEach((o, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = (currentPageOrders - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashOrder('${o.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø£Ù…Ø± #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙˆØ±ÙŠØ¯:</div><div class="order-card-value">${displayValue(o.supplyNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="order-card-value">${displayValue(o.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</div><div class="order-card-value">${displayValue(o.details)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashOrder('${o.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  }); 
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination
  updatePaginationButtons('#ordersPagination', totalPages, currentPageOrders, (pageNum) => {
    currentPageOrders = pageNum;
    renderOrderTable();
  });
  
  saveAll(); 
}

function renderMaintenanceTable(){ 
  const tbody = document.querySelector('#maintenanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('maintenanceCards');
  cardsDiv.innerHTML = '';
  
  // Ø§Ø­Ø³Ø¨ pagination
  const paginationData = paginate(maintenance, currentPageMaintenance);
  const { items: pageMaintenance, totalPages } = paginationData;
  
  pageMaintenance.forEach((m, pageIndex)=>{ 
    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù… (Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ)
    const globalIndex = (currentPageMaintenance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(m.machine)}</td><td>${escapeHtml(m.line)}</td><td>${escapeHtml(m.person)}</td><td>${escapeHtml(m.date)}</td><td>${escapeHtml(m.lcode)}</td><td>${escapeHtml(m.partName)}</td><td>${escapeHtml(m.partQty)}</td><td>${escapeHtml(m.type)}</td><td>${escapeHtml(m.notes)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditMaintenance('${m.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashMaintenance('${m.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">ØµÙŠØ§Ù†Ø© #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©:</div><div class="order-card-value">${displayValue(m.machine)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ø®Ø·:</div><div class="order-card-value">${displayValue(m.line)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="order-card-value">${displayValue(m.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(m.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">L Number:</div><div class="order-card-value">${displayValue(m.lcode)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø·Ø¹Ø©:</div><div class="order-card-value">${displayValue(m.partName)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="order-card-value">${displayValue(m.partQty)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù†ÙˆØ¹:</div><div class="order-card-value">${displayValue(m.type)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div><div class="order-card-value">${displayValue(m.notes)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditMaintenance('${m.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashMaintenance('${m.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± pagination
  updatePaginationButtons('#maintenancePagination', totalPages, currentPageMaintenance, (pageNum) => {
    currentPageMaintenance = pageNum;
    renderMaintenanceTable();
  });
  
  saveAll(); 
}

function renderTrash(){
  const tf = document.querySelector('#trashFaults tbody');
  if(tf) {
    tf.innerHTML='';
    (trash.faults || []).forEach((f,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})</td><td class="no-print actions"><button class="btn" onclick="restoreFault('${f.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteFault('${f.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      tf.appendChild(tr);
    });
  }

  const to = document.querySelector('#trashOrders tbody');
  if(to) {
    to.innerHTML='';
    (trash.orders || []).forEach((o,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}</td><td class="no-print actions"><button class="btn" onclick="restoreOrder('${o.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteOrder('${o.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      to.appendChild(tr);
    });
  }

  const tm = document.querySelector('#trashMaintenance tbody');
  if(tm){
    tm.innerHTML='';
    (trash.maintenance||[]).forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1} - ${escapeHtml(m.machine)} (${escapeHtml(m.date)})</td><td class="no-print actions"><button class="btn" onclick="restoreMaintenance('${m.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteMaintenance('${m.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      tm.appendChild(tr);
    });
  }

  const ta = document.querySelector('#trashAttendance tbody');
  if(ta){
    ta.innerHTML='';
    (trash.attendance||[]).forEach((a,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(a.workerName)} / ${escapeHtml(a.workerNum)}</td><td>${escapeHtml(a.absenceDate)}</td><td class="no-print actions"><button class="btn" onclick="restoreAttendance('${a.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteAttendance('${a.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      ta.appendChild(tr);
    });
  }
}

/* wire inputs for live filters & actions */
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('input', applyFilters);
document.getElementById('searchOrder').addEventListener('input', applyOrderFilters);

/* ensure exports buttons exist even if no data */
document.getElementById('exportCsvAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} /* handled above */ });
document.getElementById('exportDocAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersCsv').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersDoc').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('printPdfAll').addEventListener('click', ()=>{/* handled above */});
document.getElementById('printOrdersBtn').addEventListener('click', ()=>{/* handled above */});

/* final save */
saveAll();
</script>
</script>
<script>
  (function(){
    function showAlert(msg, el){
      alert(msg);
      if(el && typeof el.focus === 'function') el.focus();
    }

    function hasSelection(selectEl){
      if(!selectEl) return false;
      if(selectEl.multiple){
        return Array.from(selectEl.options).some(function(o){ return o.selected && o.value.trim() !== ''; });
      }
      return selectEl.value && selectEl.value.trim() !== '';
    }

    function validateFault(){
      var machineGroup = document.getElementById('machineGroup');
      var machineItem = document.getElementById('machineItem');
      var person = document.getElementById('person');
      var personChips = document.getElementById('personChips');
      var description = document.getElementById('description');
      var solution = document.getElementById('solution');
      var shift = document.getElementById('shift');
      var date = document.getElementById('date');
      var partChanged = document.getElementById('partChanged');
      var lcode = document.getElementById('lcode');
      var partName = document.getElementById('partName');
      var partQty = document.getElementById('partQty');
      var status = document.getElementById('status');

      if(!machineGroup || machineGroup.value.trim()==='') { showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø®Ø·).', machineGroup); return false; }
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù†Ù‡ ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ù…ÙƒØ§Ù†
      if(machineGroup && machineGroup.value === 'Ø£Ø®Ø±ÙŠ'){
        var customPlace = document.getElementById('customMachinePlace');
        if(!customPlace || customPlace.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customPlace || machineGroup); return false; }
      } else {
        if(!machineItem || machineItem.value.trim()==='') { showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', machineItem); return false; }
      }
      if(!(hasSelection(person) || (personChips && personChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„.', person); return false; }
      if(!description || description.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„.', description); return false; }
      if(!solution || solution.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø´Ø±Ø­ Ø­Ù„ Ø§Ù„Ø¹Ø·Ù„.', solution); return false; }
      if(!shift || shift.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©.', shift); return false; }
      if(!date || date.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.', date); return false; }
      if(!partChanged || partChanged.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±.', partChanged); return false; }
      if(partChanged && partChanged.value === 'yes'){
        if(!lcode || lcode.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number).', lcode); return false; }
        if(!partName || partName.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', partName); return false; }
        if(!partQty || partQty.value === '' || Number(partQty.value) <= 0){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', partQty); return false; }
      }
      if(!status || status.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„.', status); return false; }
      return true;
    }

    function validateMaintenance(){
      var mainGroup = document.getElementById('mainGroup');
      var mainItem = document.getElementById('mainItem');
      var mainPerson = document.getElementById('mainPerson');
      var mainPersonChips = document.getElementById('mainPersonChips');
      var mainDate = document.getElementById('mainDate');
      var mainPartChanged = document.getElementById('mainPartChanged');
      var mainLcode = document.getElementById('mainLcode');
      var mainPartName = document.getElementById('mainPartName');
      var mainPartQty = document.getElementById('mainPartQty');
      var mainType = document.getElementById('mainType');

      if(!mainGroup || mainGroup.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø®Ø·).', mainGroup); return false; }
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø£Ø®Ø±ÙŠ"ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù†Ù‡ ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ù…ÙƒØ§Ù†
      if(mainGroup && mainGroup.value === 'Ø£Ø®Ø±ÙŠ'){
        var customMainPlace = document.getElementById('customMainPlace');
        if(!customMainPlace || customMainPlace.value.trim() === ''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', customMainPlace || mainGroup); return false; }
      } else {
        if(!mainItem || mainItem.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©.', mainItem); return false; }
      }
      if(!(hasSelection(mainPerson) || (mainPersonChips && mainPersonChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…/Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØ§Ù†Ø©.', mainPerson); return false; }
      if(!mainDate || mainDate.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.', mainDate); return false; }
      if(!mainPartChanged || mainPartChanged.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ ØªÙ… ØªØºÙŠÙŠØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±.', mainPartChanged); return false; }
      if(mainPartChanged && mainPartChanged.value === 'yes'){
        if(!mainLcode || mainLcode.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number).', mainLcode); return false; }
        if(!mainPartName || mainPartName.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', mainPartName); return false; }
        if(!mainPartQty || mainPartQty.value === '' || Number(mainPartQty.value) <= 0){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±.', mainPartQty); return false; }
      }
      if(!mainType || mainType.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©.', mainType); return false; }
      return true;
    }

    function validateOrder(){
      var orderNum = document.getElementById('orderNum');
      var orderDate = document.getElementById('orderDate');
      var orderPerson = document.getElementById('orderPerson');
      var orderPersonChips = document.getElementById('orderPersonChips');
      var orderDetails = document.getElementById('orderDetails');

      if(!orderNum || orderNum.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderNum); return false; }
      if(!orderDate || orderDate.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderDate); return false; }
      if(!(hasSelection(orderPerson) || (orderPersonChips && orderPersonChips.textContent.trim() !== ''))){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderPerson); return false; }
      if(!orderDetails || orderDetails.value.trim()===''){ showAlert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.', orderDetails); return false; }
      return true;
    }

    var addBtn = document.getElementById('addBtn');
    if(addBtn) addBtn.addEventListener('click', function(e){ if(!validateFault()){ e.stopImmediatePropagation(); e.preventDefault(); } }, true);
    var addMaintenanceBtn = document.getElementById('addMaintenanceBtn');
    if(addMaintenanceBtn) addMaintenanceBtn.addEventListener('click', function(e){ if(!validateMaintenance()){ e.stopImmediatePropagation(); e.preventDefault(); } }, true);
    var addOrderBtn = document.getElementById('addOrderBtn');
    if(addOrderBtn) addOrderBtn.addEventListener('click', function(e){ if(!validateOrder()){ e.stopImmediatePropagation(); e.preventDefault(); } }, true);

    function togglePartFields(selectElId, containerId){
      var sel = document.getElementById(selectElId);
      var container = document.getElementById(containerId);
      if(!sel || !container) return;
      sel.addEventListener('change', function(){
        var required = sel.value === 'yes';
        Array.from(container.querySelectorAll('input')).forEach(function(inp){
          if(required) inp.setAttribute('required','required'); else inp.removeAttribute('required');
        });
        container.style.display = required ? 'block' : 'none';
      });
    }
    togglePartFields('partChanged','partFieldsContainer');
    togglePartFields('mainPartChanged','mainPartFieldsContainer');
  })();
</script>
<!-- Success toast (centered) -->
<style>
  .success-toast{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .18s ease;z-index:9999}
  .success-toast.show{opacity:1;pointer-events:auto}
  .success-box{background:rgba(255,255,255,0.98);padding:18px 22px;border-radius:12px;display:flex;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,0.15);min-width:220px;max-width:90%;direction:rtl}
  .check-circle{width:48px;height:48px;border-radius:50%;background:#28a745;display:flex;align-items:center;justify-content:center;flex:0 0 48px}
  .check-circle svg{width:24px;height:24px;fill:#fff}
  .success-text{font-size:16px;color:#08365F;font-weight:600}
  @media (max-width:480px){ .success-box{padding:12px 14px} .success-text{font-size:15px} .check-circle{width:44px;height:44px} }
</style>
<div id="successToast" class="success-toast" role="status" aria-live="polite" aria-hidden="true">
  <div class="success-box">
    <div class="check-circle" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.00039 16.2L4.80039 12L3.40039 13.4L9.00039 19L21.0004 7L19.6004 5.6L9.00039 16.2Z"/></svg>
    </div>
    <div id="successToastMsg" class="success-text">ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</div>
  </div>
</div>
<script>
  (function(){
    var toast = document.getElementById('successToast');
    var toastMsg = document.getElementById('successToastMsg');
    var hideTimer = null;
    function hide(){ if(!toast) return; toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } }
    window.showSuccess = function(msg){
      if(!toast) return; toastMsg.textContent = msg || 'ØªÙ…'; toast.classList.add('show'); toast.setAttribute('aria-hidden','false');
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(function(){ hide(); }, 1600);
    };
    // allow click to dismiss
    toast.addEventListener('click', function(){ hide(); });
  })();
</script>
</body>
</html>
